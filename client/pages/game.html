<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SPRGame - Sekai Card Battle</title>
  <script>
    (function setupHomeRedesignFlag() {
      try {
        const stored = localStorage.getItem('psk-enable-home-redesign');
        if (stored === null) {
          localStorage.setItem('psk-enable-home-redesign', 'true');
          window.__PSK_UI_EXPERIMENT = true;
        } else {
          window.__PSK_UI_EXPERIMENT = stored === 'true';
        }
      } catch (err) {
        console.warn('[home-redesign] Unable to access localStorage, defaulting flag to true', err);
        window.__PSK_UI_EXPERIMENT = true;
      }
    })();
  </script>
  <script>
    (function enableHomeRedesign() {
      const isEnabled = (() => {
        if (typeof window.__PSK_UI_EXPERIMENT !== 'undefined') return window.__PSK_UI_EXPERIMENT;
        try {
          const stored = localStorage.getItem('psk-enable-home-redesign');
          return stored === null ? true : stored === 'true';
        } catch (err) {
          console.warn('[home-redesign] Flag read error, defaulting to true', err);
          return true;
        }
      })();

      if (!isEnabled) return;

      const activate = () => {
        document.body.classList.add('psk-home-experiment');
        if (document.getElementById('psk-home-redesign-styles')) return;
        const link = document.createElement('link');
        link.id = 'psk-home-redesign-styles';
        link.rel = 'stylesheet';
        link.href = '/assets/home-redesign.css';
        document.head.appendChild(link);
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', activate, { once: true });
      } else {
        activate();
      }
    })();
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;800&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #fff;
      font-family: 'Kanit', sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    /* ==================== LOBBY PHASE ==================== */
    #lobbyContainer {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      gap: 20px;
    }

    #lobbyContainer.hidden {
      display: none;
    }

    .lobby-box {
      background: rgba(0, 0, 0, 0.7);
      padding: 50px;
      border-radius: 20px;
      text-align: center;
      max-width: 600px;
      width: 90%;
      border: 3px solid #00d2ff;
    }

    .lobby-box h1 {
      font-size: 3rem;
      color: #00ffff;
      margin-bottom: 30px;
      text-shadow: 0 0 20px #00ffff;
    }

    .room-code-display {
      font-size: 3.5rem;
      letter-spacing: 15px;
      background: #e74c3c;
      padding: 20px;
      border-radius: 20px;
      margin: 30px 0;
      font-weight: bold;
      display: none;
    }

    .room-code-display.show {
      display: block;
    }

    .lobby-input-group {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    .lobby-input-group input {
      padding: 15px;
      font-size: 1.2rem;
      border-radius: 12px;
      border: none;
      text-align: center;
    }

    .lobby-input-group input[type="text"] {
      text-transform: uppercase;
      letter-spacing: 5px;
    }

    .lobby-button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 15px 40px;
      font-size: 1.3rem;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-family: 'Kanit', sans-serif;
      transition: all 0.3s;
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(39, 174, 96, 0.5);
    }

    .btn-create {
      background: linear-gradient(135deg, #667eea, #764ba2);
    }

    .btn-create:hover {
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
    }

    .btn-join {
      background: linear-gradient(135deg, #11998e, #38ef7d);
    }

    .btn-join:hover {
      box-shadow: 0 10px 30px rgba(17, 153, 142, 0.5);
    }

    .players-list {
      background: rgba(0, 200, 255, 0.1);
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .player-item {
      background: rgba(0, 0, 0, 0.3);
      padding: 12px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .player-ready {
      color: #2ecc71;
      font-weight: bold;
    }

    .btn-ready {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      margin-top: 20px;
    }

    .btn-ready.ready {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
    }

    .btn-start {
      background: linear-gradient(135deg, #c0392b, #e74c3c);
      margin-top: 20px;
      display: none;
    }

    .btn-start.show {
      display: inline-block;
    }

    /* ==================== GAME PHASE ==================== */
    #gameContainer {
      width: 100vw;
      height: 100vh;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    #gameContainer.hidden {
      display: none;
    }

    #header {
      background: rgba(0, 0, 0, 0.5);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 3px solid #00d2ff;
      height: 80px;
      flex-shrink: 0;
    }

    .turn-info {
      font-size: 1.8rem;
      font-weight: 800;
      color: #00ff88;
    }

    .timer {
      font-size: 2rem;
      color: #ff6b6b;
      font-weight: 800;
    }

    #audioControlPanel {
      position: fixed;
      bottom: 26px;
      right: 26px;
      display: flex;
      gap: 10px;
      z-index: 130;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .audio-toggle-btn {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 0.85rem;
      font-weight: 700;
      color: #0a1228;
      background: linear-gradient(135deg, #38f9ff, #7effb2);
      box-shadow: 0 6px 16px rgba(8, 18, 40, 0.35);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-width: 84px;
      justify-content: center;
    }

    .audio-toggle-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(56, 249, 255, 0.35);
    }

    .audio-toggle-btn.muted {
      background: linear-gradient(135deg, rgba(128, 128, 128, 0.45), rgba(90, 90, 90, 0.7));
      color: rgba(255, 255, 255, 0.8);
      box-shadow: none;
      opacity: 0.85;
    }

    #globalMenuContainer {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 140;
    }

    .global-menu-btn {
      border: none;
      border-radius: 12px;
      width: 44px;
      height: 44px;
      font-size: 1.4rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      background: rgba(255, 255, 255, 0.12);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.25s ease;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .global-menu-btn:hover {
      background: rgba(255, 255, 255, 0.18);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      transform: translateY(-2px);
    }

    .global-menu-btn.menu-open {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Side Menu Panel */
    .side-menu-panel {
      position: fixed;
      left: 0;
      top: 0;
      width: 320px;
      height: 100vh;
      background: rgba(15, 25, 55, 0.98);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 150;
      transform: translateX(-100%);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      padding-top: 20px;
      overflow-y: auto;
    }

    .side-menu-panel.show {
      transform: translateX(0);
    }

    .side-menu-header {
      display: flex;
      justify-content: flex-end;
      padding: 10px 20px;
      margin-bottom: 20px;
    }

    .side-menu-close {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      width: 36px;
      height: 36px;
      font-size: 1.2rem;
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .side-menu-close:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.25);
      color: rgba(255, 255, 255, 1);
    }

    .side-menu-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 0 16px;
      flex: 1;
    }

    .side-menu-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(56, 249, 255, 0.12), rgba(100, 200, 255, 0.08));
      border: 1px solid rgba(56, 249, 255, 0.2);
      border-radius: 12px;
      color: rgba(255, 255, 255, 0.95);
      font-size: 1.05rem;
      font-weight: 500;
      text-align: left;
      cursor: pointer;
      transition: all 0.25s ease;
      position: relative;
      overflow: hidden;
    }

    .side-menu-item::before {
      content: '';
      position: absolute;
      left: -100%;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(56, 249, 255, 0.1);
      transition: left 0.3s ease;
    }

    .side-menu-item:hover {
      background: linear-gradient(135deg, rgba(56, 249, 255, 0.2), rgba(100, 200, 255, 0.15));
      border-color: rgba(56, 249, 255, 0.4);
      transform: translateX(8px);
      color: rgba(255, 255, 255, 1);
    }

    .side-menu-item:hover::before {
      left: 0;
    }

    .menu-icon {
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      min-width: 32px;
    }

    .menu-text {
      display: block;
      letter-spacing: 0.5px;
    }

    /* Menu Overlay */
    .menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0);
      backdrop-filter: blur(0px);
      -webkit-backdrop-filter: blur(0px);
      z-index: 145;
      display: none;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .menu-overlay.show {
      display: block;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    .global-menu-item span {
      font-size: 1rem;
      min-width: 18px;
    }

    .menu-info-panel {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
      animation: fadeInPanel 0.25s ease-out;
    }

    @keyframes fadeInPanel {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .menu-info-panel.show {
      display: flex;
    }

    .menu-info-card {
      width: min(450px, 85vw);
      background: rgba(15, 25, 55, 0.95);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 32px;
      color: rgba(255, 255, 255, 0.95);
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
      animation: slideUpCard 0.3s ease-out;
      position: relative;
    }

    @keyframes slideUpCard {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .menu-info-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
    }

    .menu-info-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: rgba(255, 255, 255, 1);
      letter-spacing: 0.5px;
    }

    .menu-info-close {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      width: 32px;
      height: 32px;
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .menu-info-close:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.25);
      color: rgba(255, 255, 255, 1);
    }

    .menu-info-body {
      font-size: 0.95rem;
      line-height: 1.7;
      color: rgba(255, 255, 255, 0.8);
      position: relative;
      z-index: 1;
    }

    @media (max-width: 640px) {
      #globalMenuContainer {
        top: 10px;
        left: 10px;
      }

      .global-menu-btn {
        padding: 4px 9px;
      }

      .global-menu-dropdown {
        min-width: 130px;
      }
    }

    @media (max-width: 640px) {
      #audioControlPanel {
        bottom: 16px;
        right: 16px;
        gap: 8px;
        flex-direction: column;
        align-items: flex-end;
      }

      .audio-toggle-btn {
        min-width: auto;
        width: 120px;
        justify-content: center;
      }
    }

    #eventCompetitionDisplay {
      position: absolute;
      top: 100px;
      right: 30px;
      background: rgba(0, 0, 0, 0.9);
      padding: 20px 25px;
      border-radius: 15px;
      border: 3px solid #ffd700;
      max-width: 400px;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
      display: none;
      z-index: 102;
    }

    #eventCompetitionDisplay.show {
      display: block;
    }

    .event-display-item {
      font-size: 1.3rem;
      font-weight: 700;
      margin: 8px 0;
      color: #ffd700;
    }

    .event-label {
      color: #00d2ff;
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .competition-label {
      color: #00ff88;
      font-size: 0.9rem;
      opacity: 0.8;
    }

    /* ==================== TABLE LAYOUT ==================== */
    .game-table {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 5px;
      position: relative;
      overflow: hidden;
    }

    .table-wrapper {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-start;
      gap: 10px;
      width: 100%;
      max-width: 1000px;
      height: auto;
      padding: 10px;
    }

    .player-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
      padding: 10px;
      min-width: 150px;
      max-width: 200px;
      border-radius: 10px;
    }

    .player-area.p1 {
      order: 10;
      border: 3px solid #ffd700;
      background: rgba(255, 215, 0, 0.1);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
      border-radius: 15px;
    }

    .player-area.p2 {
      border: 2px solid rgba(0, 255, 136, 0.5);
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
    }

    .player-area.p3 {
      border: 2px solid rgba(0, 255, 136, 0.5);
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
    }

    .player-area.p4 {
      border: 2px solid rgba(0, 255, 136, 0.5);
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
    }

    .player-area.p5 {
      border: 2px solid rgba(0, 255, 136, 0.5);
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
    }

    .table-center {
      width: 100%;
      order: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.6);
      border: 3px solid #ffd700;
      border-radius: 20px;
      padding: 20px;
      margin: 10px 0;
      box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
    }

    .player-name-tag {
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      color: #00ff88;
      border: 2px solid #00ff88;
      font-size: 0.95rem;
    }

    .player-hearts-display {
      font-size: 1.2rem;
      color: #ff6b6b;
      font-weight: 700;
    }

    .player-played-cards {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
      min-height: 130px;
      align-content: center;
    }

    /* ‚úÖ ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏ô‡πÇ‡∏ï‡πä‡∏∞ - ‡πÑ‡∏°‡πà‡∏°‡∏µ margin-left */
    .player-area .card {
      margin-left: 0 !important;
      position: relative !important;
      transform: none !important;
      margin-top: 0 !important;
      margin-right: 0 !important;
      flex-shrink: 0;
    }

    .player-area .card:hover {
      transform: scale(1.05) !important;
      z-index: 10;
    }

    .player-area .card:first-child {
      margin-left: 0 !important;
    }

    .player-small-card {
      width: 90px;
      height: 130px;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: 2px solid #00d2ff;
      border-radius: 12px;
      padding: 10px;
      font-size: 0.75rem;
      display: flex;
      flex-direction: column;
      justify-content: space-evenly;
      color: #00d2ff;
      text-align: center;
      box-shadow: 0 3px 15px rgba(0, 210, 255, 0.3);
      font-weight: 600;
      flex-shrink: 0;
    }

    .table-event-competition {
      text-align: center;
      position: relative;
      z-index: 150;
    }

    .table-event-item {
      font-size: 1.5rem;
      font-weight: 700;
      color: #ff9800;
      margin: 10px 0;
    }

    .table-competition-item {
      font-size: 1.3rem;
      font-weight: 700;
      color: #00ff88;
      margin: 10px 0;
    }

    /* Play Card Phase */
    #playCardPhase {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: rgba(0, 0, 0, 0.95);
      z-index: 100;
      flex-direction: column;
      justify-content: flex-start;
      padding: 20px 20px 130px 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    #playCardPhase.show {
      display: flex;
    }

    .playCardHeader {
      text-align: center;
      color: #00ff88;
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 20px;
    }

    .cardPreviewArea {
      flex: 1;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      gap: 30px;
      margin-bottom: 20px;
    }

    .cardPreview {
      width: 250px;
      height: 350px;
      border: 4px solid #00d2ff;
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      padding: 0;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      font-size: 1.4rem;
      text-align: center;
      box-shadow: 0 10px 50px rgba(0, 210, 255, 0.5);
      background-size: cover;
      background-position: center;
      overflow: hidden;
    }

    .cardPreviewImage {
      font-size: 4rem;
      margin: 10px 0;
    }

    .cardPreviewStats {
      flex: 1;
      min-width: 250px;
      max-width: 300px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #00d2ff;
      border-radius: 15px;
      font-size: 0.85rem;
      color: #00ff88;
      line-height: 1.3;
      height: 350px;
      justify-content: flex-start;
    }

    .hand {
      display: flex;
      gap: 0;
      justify-content: flex-start;
      flex-wrap: nowrap;
      padding: 0;
      background: transparent;
      border: none;
      max-height: none;
    }


    /* ‚úÖ Cards in phaseHandContainer - no overlap, can scroll */
    #phaseHandContainer {
      overflow-x: auto !important;
      overflow-y: hidden !important;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
    }
    
    #phaseHandContainer::-webkit-scrollbar {
      display: none; /* Chrome, Safari and Opera */
    }
    
    #phaseHandContainer .card {
      margin-left: 0 !important;
    }

    .card {
      width: 110px;
      height: 160px;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding: 8px;
      text-align: center;
      font-size: 0.8rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
      margin-left: -60px;
    }

    .card:first-child {
      margin-left: 0;
    }

    .card:hover {
      transform: translateY(-40px) scale(1.15);
      z-index: 100;
      box-shadow: 0 10px 30px rgba(0, 210, 255, 0.8);
    }

    .card.selected {
      border: 4px solid #ffd700;
      background: rgba(255, 215, 0, 0.3);
      box-shadow: 0 0 30px #ffd700;
    }

    .skill-tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.95);
      border: 2px solid #00ff88;
      border-radius: 8px;
      padding: 10px;
      font-size: 0.85rem;
      color: #00ff88;
      display: none;
      z-index: 1000;
      white-space: nowrap;
      bottom: -50px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
    }

    .card:hover .skill-tooltip {
      display: block;
    }

    .card-character {
      font-weight: 800;
      color: #00ff88;
      font-size: 1rem;
    }

    .card-stats {
      display: flex;
      justify-content: space-around;
      font-size: 0.85rem;
      color: #00d2ff;
      margin: 5px 0;
    }

    /* ‚úÖ ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ü‡∏≠‡∏ô‡∏ï‡πå Stats ‡πÉ‡∏ô Phase ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î */
    #phaseHandContainer .card-stats {
      font-size: 1.3rem;
      font-weight: 700;
    }

    .card-rarity {
      font-size: 0.8rem;
      color: #ff6b6b;
      font-weight: 600;
    }

    .card-skill {
      font-size: 0.75rem;
      color: #ffd700;
      display: none;
    }

    /* ‚úÖ Card image */
    .card-image {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
      flex-shrink: 0;
    }

    /* ‚úÖ Card info */
    .card-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 2px;
      padding: 4px 4px;
      background: rgba(0, 0, 0, 0.3);
      min-height: 48px;
    }

    /* ‚úÖ Card skill badge */
    .card-skill-badge {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 0.95) 40%);
      color: #ffffff;
      font-size: 0.65rem;
      font-weight: 600;
      padding: 4px 3px;
      text-align: center;
      border-radius: 0 0 12px 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      word-wrap: break-word;
      max-height: 32px;
      overflow: hidden;
    }

    .button-group {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      justify-content: center;
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 101;
    }

    .btn-confirm {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white;
      display: none;
    }

    .btn-confirm.show {
      display: inline-block;
    }

    .btn-confirm:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(39, 174, 96, 0.5);
    }

    .btn-skip {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
    }

    .btn-skip:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(231, 76, 60, 0.5);
    }

    /* Action Phase */
    #actionPhase {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(5, 10, 43, 0.88);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      z-index: 240;
      align-items: center;
      justify-content: center;
      padding: clamp(20px, 4vw, 60px);
      transition: background 0.3s ease;
    }

    #actionPhase.show {
      display: flex;
    }

    #actionPhase.collapsed {
      background: transparent;
      pointer-events: none;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }

    #actionPhase.collapsed .action-modal {
      opacity: 0;
      transform: translateY(24px) scale(0.97);
      pointer-events: none;
      box-shadow: none;
    }

    .action-modal {
      width: min(920px, 95vw);
      background: linear-gradient(145deg, rgba(5, 15, 43, 0.95), rgba(12, 34, 86, 0.9));
      border-radius: 36px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 35px 120px rgba(3, 10, 40, 0.65);
      padding: clamp(24px, 5vw, 56px);
      position: relative;
      overflow: hidden;
      transition: opacity 0.25s ease, transform 0.25s ease, box-shadow 0.25s ease;
    }

    .action-modal::before,
    .action-modal::after {
      content: '';
      position: absolute;
      inset: auto;
      pointer-events: none;
    }

    .action-modal::before {
      width: 320px;
      height: 320px;
      left: -80px;
      top: -120px;
      background: radial-gradient(circle, rgba(56, 249, 255, 0.35), transparent 60%);
      filter: blur(60px);
    }

    .action-modal::after {
      width: 260px;
      height: 260px;
      right: -120px;
      bottom: -60px;
      background: radial-gradient(circle, rgba(255, 79, 216, 0.3), transparent 60%);
      filter: blur(70px);
    }

    .action-header {
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .action-eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.3em;
      font-size: 0.85rem;
      color: rgba(245, 251, 255, 0.55);
      margin-bottom: 8px;
    }

    .action-title {
      font-size: clamp(2.2rem, 6vw, 3.8rem);
      margin: 0;
      color: #ffffff;
      text-shadow: 0 0 25px rgba(255, 255, 255, 0.35);
    }

    html[data-lang='en'] .action-title,
    html[data-lang='ja'] .action-title {
      font-size: clamp(1.9rem, 5vw, 3.2rem);
      line-height: 1.1;
    }

    .action-countdown {
      margin-top: 12px;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(255, 255, 255, 0.05);
      font-weight: 600;
      font-size: 1rem;
      color: rgba(245, 251, 255, 0.85);
    }

    .action-countdown-value {
      font-size: 1.4rem;
      color: #ff9edb;
    }

    .action-meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 30px;
    }

    .action-chip {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 16px 20px;
      backdrop-filter: blur(6px);
    }

    .action-chip-label {
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      color: rgba(245, 251, 255, 0.6);
    }

    .action-chip-value {
      margin-top: 6px;
      font-size: 1.2rem;
      color: #38f9ff;
      font-weight: 600;
    }

    .action-helper-text {
      margin-top: 24px;
      font-size: 1rem;
      color: rgba(245, 251, 255, 0.8);
      text-align: center;
    }

    .action-buttons {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 18px;
      margin-top: clamp(24px, 4vw, 40px);
      position: relative;
      z-index: 1;
    }

    .action-btn {
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 26px;
      padding: 22px;
      background: linear-gradient(135deg, rgba(56, 249, 255, 0.3), rgba(255, 79, 216, 0.2));
      color: #081332;
      cursor: pointer;
      text-align: left;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 20px 45px rgba(5, 15, 43, 0.55);
      transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
      font-family: 'Kanit', sans-serif;
      font-weight: 600;
    }

    .action-btn:hover {
      transform: translateY(-6px);
      box-shadow: 0 30px 65px rgba(56, 249, 255, 0.25);
      background: linear-gradient(135deg, rgba(56, 249, 255, 0.5), rgba(255, 123, 231, 0.35));
    }

    .action-btn.active {
      background: linear-gradient(135deg, #4df4b7, #38f9ff);
      box-shadow: 0 30px 60px rgba(72, 255, 210, 0.4);
      color: #05102c;
    }

    .action-btn__title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.3rem;
      font-weight: 700;
      color: inherit;
    }

    .action-btn__number {
      width: 48px;
      height: 48px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 1.2rem;
    }

    .action-btn__badge {
      font-size: 0.9rem;
      color: #ff9ea6;
      font-weight: 700;
    }

    .action-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      filter: grayscale(0.2);
    }

    .action-description {
      font-size: 0.95rem;
      color: rgba(7, 18, 44, 0.82);
    }

    .action-reopen-btn {
      position: fixed;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 28px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, rgba(56, 249, 255, 0.9), rgba(255, 79, 216, 0.8));
      color: #05102c;
      font-weight: 700;
      letter-spacing: 0.03em;
      box-shadow: 0 18px 40px rgba(5, 15, 43, 0.6);
      display: none;
      align-items: center;
      gap: 10px;
      z-index: 260;
      cursor: pointer;
    }

    .action-reopen-btn:hover {
      transform: translateX(-50%) translateY(-2px);
    }

    @media (max-width: 640px) {
      .action-buttons {
        grid-template-columns: 1fr;
      }
    }

    .action-footer-note {
      margin-top: 24px;
      text-align: center;
      font-size: 0.85rem;
      color: rgba(245, 251, 255, 0.55);
    }

    /* Result Overlay */
    #resultOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(20, 20, 40, 0.95));
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 40px 20px;
      box-sizing: border-box;
    }

    #resultOverlay.show {
      display: flex;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* ============== RESULT WRAPPER - MAIN CONTENT ============== */
    .result-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 40px;
      width: 100%;
      max-width: 1000px;
      text-align: center;
    }

    /* ============== TITLE ============== */
    .result-title {
      font-size: 4rem;
      color: #ffd700;
      font-weight: 900;
      text-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
      margin: 0;
      animation: glow 2s infinite;
    }

    @keyframes glow {
      0%, 100% { text-shadow: 0 0 40px rgba(255, 215, 0, 0.8); }
      50% { text-shadow: 0 0 80px rgba(255, 215, 0, 1), 0 0 120px rgba(255, 215, 0, 0.6); }
    }

    /* ============== PLAYERS SCORE GRID ============== */
    .players-score-grid {
      display: none;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      width: 100%;
      max-width: 1400px;
      margin: 20px auto;
      justify-items: center;
      justify-content: center;
      align-items: start;
    }

    /* ============== INDIVIDUAL PLAYER SCORE BOX ============== */
    .player-score-box {
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.15), rgba(0, 150, 200, 0.1));
      border: 3px solid #00d2ff;
      border-radius: 20px;
      padding: 35px 25px;
      transition: all 0.3s;
      box-shadow: 0 8px 25px rgba(0, 210, 255, 0.2);
      animation: slideUp 0.6s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .player-score-box:hover {
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.25), rgba(0, 150, 200, 0.15));
      border-color: #00ff88;
      box-shadow: 0 12px 40px rgba(0, 210, 255, 0.4);
      transform: translateY(-5px);
    }

    .player-score-name {
      font-size: 1.8rem;
      color: #00ff88;
      font-weight: 800;
      margin-bottom: 12px;
    }

    .player-score-hearts {
      font-size: 2.2rem;
      color: #ff6b6b;
      margin-bottom: 12px;
      letter-spacing: 2px;
    }

    .player-score-points {
      font-size: 2.2rem;
      color: #ffd700;
      font-weight: 700;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
    }

    /* ============== TURN WINNER ANNOUNCEMENT ============== */
    .winner-announcement {
      display: none;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 150, 0, 0.1));
      border: 3px solid #ffd700;
      border-radius: 25px;
      padding: 35px 50px;
      margin: 20px 0;
      animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes popIn {
      0% {
        opacity: 0;
        transform: scale(0.5);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .turn-winner {
      font-size: 3.5rem;
      color: #ffd700;
      font-weight: 900;
      text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
      margin: 0 0 15px 0;
    }

    .turn-winner-score {
      font-size: 2rem;
      color: #00ff88;
      font-weight: 700;
      margin: 0;
    }

    /* ============== GAME OVER MESSAGE ============== */
    .game-over-message {
      background: linear-gradient(135deg, rgba(46, 204, 113, 0.25), rgba(39, 174, 96, 0.15));
      border: 4px solid #2ecc71;
      border-radius: 30px;
      padding: 40px 60px;
      margin-top: 20px;
      animation: pulse 1.5s infinite alternate;
    }

    .final-winner-text {
      font-size: 3rem;
      color: #2ecc71;
      font-weight: 900;
      text-shadow: 0 0 40px rgba(46, 204, 113, 0.8);
      margin: 0;
      letter-spacing: 2px;
    }

    /* ============== REVEALED CARDS SECTION ============== */
    .revealed-cards-section {
      width: 100%;
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid #00ff88;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .revealed-title {
      font-size: 1.8rem;
      color: #00ff88;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .revealed-cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
      max-width: 100%;
    }

    .revealed-card-item {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: 2px solid #00d2ff;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      font-size: 0.85rem;
      color: #00ff88;
      font-weight: 600;
      overflow: hidden;
      word-wrap: break-word;
    }

    .error-message {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #e74c3c;
      padding: 20px;
      border-radius: 10px;
      font-size: 1.1rem;
      max-width: 400px;
      z-index: 1000;
      animation: slideIn 0.3s;
    }

    /* ==================== DECK PILE (‡∏Å‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î) ==================== */
    .deck-pile {
      position: fixed;
      right: 20%;
      top: 45%;
      transform: translateY(-50%);
      z-index: 90;
      transition: transform 0.3s ease;
    }

    .deck-pile:hover {
      transform: translateY(-50%) scale(1.05);
    }

    .deck-card {
      width: 110px;
      height: 158px;
      background-image: url('/assets/images/cards/0Backcard.jpg');
      background-size: cover;
      background-position: center;
      border-radius: 12px;
      position: absolute;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      border: 2px solid #00d2ff;
    }

    .deck-card-1 { top: 0; left: 0; }
    .deck-card-2 { top: 3px; left: 3px; }
    .deck-card-3 { top: 6px; left: 6px; }
    .deck-card-4 { top: 9px; left: 9px; z-index: 10; }

    /* ==================== CARD ANIMATIONS ==================== */
    @keyframes drawCardFromDeck {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      50% {
        transform: translate(-300px, 100px) scale(0.8) rotate(10deg);
        opacity: 0.8;
      }
      100% {
        transform: translate(-600px, 300px) scale(1);
        opacity: 1;
      }
    }

    @keyframes returnCardToDeck {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      50% {
        transform: translate(300px, -100px) scale(0.8) rotate(-10deg);
        opacity: 0.8;
      }
      100% {
        transform: translate(600px, -300px) scale(0.9);
        opacity: 0;
      }
    }

    .card-flying {
      position: fixed;
      z-index: 1000;
      pointer-events: none;
    }

    @keyframes slideIn {
      from { transform: translateX(500px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.1); }
    }

    /* ==================== RESPONSIVE DESIGN ==================== */
    /* Mobile (< 768px) */
    @media (max-width: 767px) {
      body {
        height: auto;
        overflow: auto;
      }

      #lobbyContainer {
        height: auto;
        padding: 20px;
        min-height: 100vh;
      }

      .lobby-box {
        padding: 30px 20px;
        max-width: 100%;
        width: 100%;
      }

      .lobby-box h1 {
        font-size: 2rem;
      }

      .table-wrapper {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto auto;
        gap: 15px;
        max-width: 100%;
        height: auto;
      }

      .player-area.p1 {
        grid-column: 1;
        grid-row: 5;
      }

      .player-area.p2 {
        grid-column: 1;
        grid-row: 1;
      }

      .player-area.p3 {
        grid-column: 1;
        grid-row: 2;
      }

      .player-area.p4 {
        grid-column: 1;
        grid-row: 3;
      }

      .table-center {
        grid-column: 1;
        grid-row: 4;
      }

      .game-table {
        padding: 10px;
      }

      #header {
        flex-direction: row;
        gap: 20px;
        font-size: 0.9rem;
      }

      #eventCompetitionDisplay {
        flex-direction: column;
        font-size: 0.9rem;
        padding: 10px;
      }

      .hand {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
      }

      .card {
        width: 80px;
        height: 110px;
        font-size: 0.7rem;
      }

      .phase-title {
        font-size: 1.2rem;
      }

      .action-buttons {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .action-btn {
        padding: 10px;
        font-size: 0.8rem;
      }

      .result-content {
        padding: 20px;
        width: 90%;
      }

      .btn {
        padding: 12px 20px;
        font-size: 0.9rem;
      }
    }

    /* Tablet (768px - 1024px) */
    @media (min-width: 768px) and (max-width: 1024px) {
      .table-wrapper {
        grid-template-columns: 1fr 1.5fr 1fr;
        max-width: 100%;
      }

      .hand {
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      }

      .lobby-box {
        max-width: 90%;
      }
    }

    /* Desktop (> 1024px) */
    @media (min-width: 1025px) {
      body {
        height: 100vh;
        overflow: hidden;
      }

      #lobbyContainer {
        height: 100vh;
      }

      .lobby-box {
        max-width: 600px;
      }

      .game-table {
        height: calc(100vh - 200px);
      }
    }
  </style>

  <style>
    .slot-container {
      text-align: center;
      animation: fadeIn 0.3s;
    }

    .slot-machine {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: 5px solid #ffd700;
      border-radius: 20px;
      padding: 40px 80px;
      box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
    }

    .slot-display {
      font-size: 3rem;
      font-weight: bold;
      color: #fff;
      background: rgba(0, 0, 0, 0.5);
      padding: 30px 60px;
      border-radius: 10px;
      min-width: 400px;
      transition: transform 0.1s;
    }

    .slot-result {
      text-align: center;
      animation: popIn 0.5s;
    }

    .revealed-container {
      text-align: center;
      animation: fadeIn 0.3s;
    }

    .revealed-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }

    .revealed-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: 3px solid #ffd700;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes popIn {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes flipCard {
      0% { transform: rotateY(0deg); }
      50% { transform: rotateY(90deg); }
      100% { transform: rotateY(0deg); }
    }
  </style>
</head>
<body>
  <div id="audioControlPanel">
    <button id="audioMuteToggle" class="audio-toggle-btn" type="button" aria-pressed="false" title="Toggle sound effects">üîä <span class="audio-label">SFX</span></button>
    <button id="bgmToggleButton" class="audio-toggle-btn" type="button" aria-pressed="true" title="Toggle background music">üéµ <span class="audio-label">BGM</span></button>
  </div>
  <div id="globalMenuContainer">
    <button id="globalMenuButton" class="global-menu-btn" type="button" aria-haspopup="true" aria-expanded="false">‚ò∞</button>
  </div>

  <!-- Side Menu Panel -->
  <div id="sideMenuPanel" class="side-menu-panel">
    <div class="side-menu-header">
      <button id="sideMenuClose" class="side-menu-close" type="button" aria-label="Close">‚úï</button>
    </div>
    <div class="side-menu-content">
      <button class="side-menu-item" data-action="home" data-i18n="menuHome">
        <span class="menu-icon">üè†</span>
        <span class="menu-text" data-i18n="menuHome">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
      </button>
      <button class="side-menu-item" data-action="about" data-i18n="menuAbout">
        <span class="menu-icon">‚ÑπÔ∏è</span>
        <span class="menu-text" data-i18n="menuAbout">‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤</span>
      </button>
      <button class="side-menu-item" data-action="gameInfo" data-i18n="menuGameInfo">
        <span class="menu-icon">üéÆ</span>
        <span class="menu-text" data-i18n="menuGameInfo">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏°</span>
      </button>
    </div>
  </div>

  <!-- Menu Overlay -->
  <div id="menuOverlay" class="menu-overlay"></div>
  <div id="menuInfoPanel" class="menu-info-panel" aria-hidden="true">
    <div class="menu-info-card">
      <div class="menu-info-header">
        <h3 id="menuInfoTitle" class="menu-info-title">SPRgame</h3>
        <button id="menuInfoClose" class="menu-info-close" type="button" aria-label="Close">‚úï</button>
      </div>
      <div id="menuInfoBody" class="menu-info-body">‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÅ‡∏ü‡∏ô‡πÄ‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ü‡∏ô Project Sekai</div>
    </div>
  </div>
  <!-- LOBBY PHASE -->
  <div id="lobbyContainer" class="hidden">
    <!-- Language Switcher -->
    <div class="psk-lang-switcher">
      <button class="btn psk-lang-btn" onclick="changeLanguage('th')" id="langBtnTh">‡πÑ‡∏ó‡∏¢</button>
      <button class="btn psk-lang-btn" onclick="changeLanguage('en')" id="langBtnEn">English</button>
      <button class="btn psk-lang-btn" onclick="changeLanguage('ja')" id="langBtnJa">Êó•Êú¨Ë™û</button>
    </div>

    <div class="psk-ambient-notes" aria-hidden="true">
      <span>‚ô™</span>
      <span>‚ô¨</span>
      <span>‚ô´</span>
      <span>‚ô©</span>
      <span>‚ô™</span>
    </div>

    <div class="lobby-box psk-home-stage">
      <h1 data-i18n="title">SPRgame</h1>
      <p style="font-size: 1.5rem; margin-bottom: 20px;" data-i18n="subtitle">Project Sekai BoardCard Game (Fanmade)</p>

      <div class="room-code-display code-box" id="roomCodeDisplay"></div>

      <div class="lobby-input-group">
        <input type="text" id="playerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" data-i18n-placeholder="enterName" value="">
        <input type="text" id="roomCode" placeholder="‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡πâ‡∏≠‡∏á (6 ‡∏ï‡∏±‡∏ß)" data-i18n-placeholder="enterCode" maxlength="6" style="display: none;">
      </div>

      <div class="lobby-button-group psk-home-cta-group">
        <button class="btn btn-create" onclick="createRoom()" data-i18n="createRoom">üéÆ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
        <button class="btn btn-join" onclick="toggleJoinMode()" id="joinToggle" data-i18n="joinRoom">üë• ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
      </div>

      <div class="room-code-display psk-share-card" id="roomCodeShare" style="margin-top: 30px; display: none;">
        <p style="font-size: 1rem; margin-bottom: 10px;" data-i18n="sharCode">‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</p>
        <div id="displayCode" class="code-box" style="font-size: 3.5rem; letter-spacing: 15px;">??????</div>
      </div>

      <div class="players-list" id="playersList"></div>

      <button class="btn btn-ready" id="readyBtn" onclick="toggleReady()" data-i18n="ready">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß!</button>
      <button class="btn btn-start" id="startBtn" onclick="startGame()" data-i18n="start">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°!</button>
      <button class="btn" id="backBtn" onclick="goBack()" style="background: #95a5a6; display: none; margin-top: 10px;" data-i18n="back">‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>
  </div>

  <!-- GAME PHASE -->
  <div id="gameContainer" class="hidden">
    <div id="header">
      <div class="turn-info" id="turnInfoLabel"><span class="turn-label">‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô:</span> <span id="turnNumber">1</span></div>
      <div id="spectatorMode" style="display: none; color: #ff6b6b; font-size: 1.2rem; font-weight: bold; background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 10px;">üëÅÔ∏è ‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡πÄ‡∏Å‡∏° - ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏û‡πâ‡πÅ‡∏•‡πâ‡∏ß</div>
      <div class="timer">‚è±Ô∏è <span id="timer">30</span>s</div>
    </div>

    <div id="gameControlButtons" style="position: absolute; top: 80px; left: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 100;"></div>

    <!-- Deck Pile (‡∏Å‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î) -->
    <div id="deckPile" class="deck-pile">
      <div class="deck-card deck-card-1"></div>
      <div class="deck-card deck-card-2"></div>
      <div class="deck-card deck-card-3"></div>
      <div class="deck-card deck-card-4"></div>
    </div>

    <div class="game-table">
      <div class="table-wrapper">
        <div class="player-area p2" id="player2Area"></div>
        <div class="player-area p3" id="player3Area"></div>
        <div class="player-area p4" id="player4Area"></div>
        <div class="player-area p5" id="player5Area"></div>
        
        <div class="table-center">
          <div class="table-event-competition">
            <div class="table-event-item" id="tableEvent">üìç -</div>
            <div class="table-competition-item" id="tableCompetition">üèÜ -</div>
          </div>
        </div>

        <div class="player-area p1" id="player1Area"></div>
      </div>
    </div>

    <!-- ‚úÖ My Hand Cards - Always Visible (UNO Style) -->
    <div class="hand" id="hand" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; flex-wrap: nowrap; gap: 0; z-index: 80; max-width: 90%;"></div>

    <!-- ‚úÖ Card Detail Preview (Left Side) -->
    <div id="cardDetailPreview" style="position: fixed; left: 20px; top: 50%; transform: translateY(-50%); width: 200px; height: 280px; background: rgba(0,0,0,0.9); border: 3px solid #00d2ff; border-radius: 15px; padding: 15px; display: none; z-index: 85; box-shadow: 0 0 30px rgba(0,210,255,0.5);">
      <div id="previewCardImage" style="width: 100%; height: 180px; background-size: cover; background-position: center; border-radius: 10px; margin-bottom: 10px;"></div>
      <div id="previewCardInfo" style="color: #00ff88; font-size: 0.9rem; line-height: 1.4;"></div>
    </div>

    <div id="playCardPhase">
      <div class="playCardHeader" id="playCardHeader">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏°!</div>
      
      <!-- ‚úÖ Card Preview Area (‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ - ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡∏¢‡∏≤‡∏¢ + ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î) -->
      <div class="cardPreviewArea">
        <div class="cardPreview">
          <div style="color: #888;" id="clickCardMsg">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
        </div>
        <div class="cardPreviewStats" style="display: none;"></div>
      </div>

      <!-- ‚úÖ Hand Cards Area (‡∏Å‡∏£‡∏≠‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á - ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ) -->
      <div class="hand" id="phaseHandContainer" style="margin: 20px auto; max-width: 95%; max-height: 400px; padding: 20px; background: rgba(0, 0, 0, 0.5); border: 2px solid #00d2ff; border-radius: 15px; display: flex; justify-content: flex-start; gap: 10px; flex-wrap: nowrap; min-height: 180px; overflow-x: auto; overflow-y: hidden;">
        <div style="color: #888; font-size: 1.1rem;" id="cardsAppearMsg">‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...</div>
      </div>
      
      <div class="button-group" style="margin-top: 20px;">
        <button class="btn btn-confirm" id="confirmCard">‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î</button>
      </div>
    </div>

    <div id="actionPhase">
      <div class="action-modal">
        <div class="action-header">
          <p class="action-eyebrow" id="actionPhaseEyebrow">Phase 2 ¬∑ Strategy</p>
          <h1 class="action-title" id="selectActionTitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Action!</h1>
          <div class="action-countdown">
            <span id="actionCountdownLabel">Time left</span>
            <span class="action-countdown-value"><span id="actionTimerValue">30</span><span id="actionCountdownUnit">s</span></span>
          </div>
        </div>

        <div class="action-meta-grid">
          <div class="action-chip">
            <div class="action-chip-label" id="actionMetaEventLabel">Event</div>
            <div class="action-chip-value" id="actionMetaEvent">-</div>
          </div>
          <div class="action-chip">
            <div class="action-chip-label" id="actionMetaCompetitionLabel">Competition</div>
            <div class="action-chip-value" id="actionMetaCompetition">-</div>
          </div>
        </div>

        <p class="action-helper-text" id="actionPhaseHelper">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏∞‡∏´‡∏°‡∏î!</p>

        <div class="action-buttons">
          <button class="action-btn" data-action="1" id="actionBtn1">
            <div class="action-btn__title">
              <span class="action-btn__number">1</span>
              <span class="action-text">‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤</span>
            </div>
            <div class="action-description" id="actionDesc1">‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤ 1 ‡πÉ‡∏ö ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏î‡∏•‡∏á 5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
          </button>

          <button class="action-btn" data-action="2" id="actionBtn2">
            <div class="action-btn__title">
              <span class="action-btn__number">2</span>
              <span class="action-text">‡πÉ‡∏ä‡πâ‡∏™‡∏Å‡∏¥‡∏•</span>
              <span class="action-btn__badge" id="actionCdBadge"></span>
            </div>
            <div class="action-description" id="actionDesc2">‡∏ï‡∏¥‡∏î CD 2 ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô</div>
          </button>

          <button class="action-btn" data-action="3" id="actionBtn3">
            <div class="action-btn__title">
              <span class="action-btn__number">3</span>
              <span class="action-text">‡πÅ‡∏Ç‡πà‡∏á‡∏ï‡∏£‡∏á ‡πÜ</span>
            </div>
            <div class="action-description" id="actionDesc3">‡∏û‡∏•‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°</div>
          </button>

          <button class="action-btn" data-action="4" id="actionBtn4">
            <div class="action-btn__title">
              <span class="action-btn__number">4</span>
              <span class="action-text">‡∏ñ‡∏≠‡∏¢‡∏´‡∏ô‡∏µ</span>
            </div>
            <div class="action-description" id="actionDesc4">‡πÄ‡∏™‡∏µ‡∏¢‡∏û‡∏•‡∏±‡∏á‡πÉ‡∏à 1</div>
          </button>
        </div>

        <div class="action-footer-note" id="actionFooterHint">‡πÅ‡∏ï‡∏∞‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
      </div>
    </div>

    <button id="actionPhaseReopen" class="action-reopen-btn" type="button" aria-expanded="false">
      üëÅ‚Äçüó® <span id="actionReopenLabel">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Action</span>
    </button>

    <div id="resultOverlay">
      <div class="result-wrapper">
        <!-- Title -->
        <div class="result-title" id="resultTitle" class="result-title-text">‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
        
        <!-- Revealed Cards Section -->
        <div class="revealed-cards-section" id="revealedCardsSection" style="display: none;">
          <div class="revealed-title" id="revealedCardsTitle">üé¥ ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏´‡∏á‡∏≤‡∏¢</div>
          <div class="revealed-cards-grid" id="revealedCardsGrid">
            <!-- Cards will be shown here -->
          </div>
        </div>
        
        <!-- Players Score Grid -->
        <div class="players-score-grid" id="playersScoreGrid">
          <!-- Dynamic player score boxes -->
        </div>
        
        <!-- Winner Announcement -->
        <div class="winner-announcement" id="winnerAnnouncement">
          <!-- Will show winner and score -->
        </div>
        
        <!-- Game Over Message -->
        <div class="game-over-message" id="gameOverMessage" style="display: none;">
          <!-- Final winner announcement -->
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ==================== GLOBAL STATE ====================
    const socket = io();
    const actionPhaseElement = document.getElementById('actionPhase');
    const actionReopenBtn = document.getElementById('actionPhaseReopen');
    let actionModalCollapsed = false;
    
    // Language system - Read from URL parameter or localStorage
    const urlParams = new URLSearchParams(window.location.search);
    let currentLang = urlParams.get('lang') || localStorage.getItem('lang') || 'th';
    let translations = {};
    document.documentElement.setAttribute('data-lang', currentLang);
    console.log('[i18n-game] Current lang:', currentLang);

    async function loadLanguage(lang) {
      try {
        console.log(`[i18n-game] Loading language: ${lang}`);
        const response = await fetch(`/locales/${lang}.json?t=${Date.now()}`);
        console.log(`[i18n-game] Response status: ${response.status}`);
        
        if (!response.ok) {
          throw new Error(`Failed to load locales/${lang}.json: ${response.status}`);
        }
        
        translations = await response.json();
        console.log(`[i18n-game] ‚úÖ Loaded translations for ${lang}:`, Object.keys(translations).length, 'keys');
        currentLang = lang;
        localStorage.setItem('lang', lang);
        document.documentElement.setAttribute('data-lang', currentLang);
        updatePageLanguage();
      } catch (e) {
        console.error('[i18n-game] Failed to load language:', e);
      }
    }

    function t(key) {
      return translations[key] || key;
    }

    function updatePageLanguage() {
      document.documentElement.setAttribute('data-lang', currentLang);
      // Update all data-i18n elements
      document.querySelectorAll('[data-i18n]').forEach(el => {
        el.textContent = t(el.dataset.i18n);
      });
      
      // Update all data-i18n-placeholder inputs
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        el.placeholder = t(el.dataset.i18nPlaceholder);
      });

      // === TRANSLATE CONFIRM CARD BUTTON ===
      const confirmCardBtn = document.getElementById('confirmCard');
      if (confirmCardBtn) {
        confirmCardBtn.textContent = currentLang === 'en' ? '‚úì Confirm Card' : currentLang === 'ja' ? '‚úì „Ç´„Éº„Éâ„ÇíÁ¢∫Ë™ç' : '‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î';
      }

      // === TRANSLATE TURN LABEL ===
      const turnLabel = document.querySelector('.turn-label');
      if (turnLabel) {
        turnLabel.textContent = currentLang === 'en' ? 'Turn:' : currentLang === 'ja' ? '„Çø„Éº„É≥:' : '‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô:';
      }

      // === TRANSLATE PHASE TITLES ===
      const playCardHeader = document.getElementById('playCardHeader');
      const selectActionTitle = document.getElementById('selectActionTitle');
      const resultTitle = document.getElementById('resultTitle');
      const revealedCardsTitle = document.getElementById('revealedCardsTitle');
      const actionHelper = document.getElementById('actionPhaseHelper');
      const actionFooterHint = document.getElementById('actionFooterHint');
      const actionCountdownLabel = document.getElementById('actionCountdownLabel');
      const actionCountdownUnit = document.getElementById('actionCountdownUnit');
      const actionEyebrow = document.getElementById('actionPhaseEyebrow');
      const actionEventLabel = document.getElementById('actionMetaEventLabel');
      const actionCompetitionLabel = document.getElementById('actionMetaCompetitionLabel');
      const actionReopenLabel = document.getElementById('actionReopenLabel');

      if (currentLang === 'en') {
        if (playCardHeader) playCardHeader.textContent = 'Select a card to play!';
        if (selectActionTitle) selectActionTitle.textContent = 'Choose an action!';
        if (resultTitle) resultTitle.textContent = 'Turn Results';
        if (revealedCardsTitle) revealedCardsTitle.textContent = 'üé¥ Revealed Cards';
        if (actionHelper) actionHelper.textContent = 'Pick a strategy before the timer hits zero.';
        if (actionFooterHint) actionFooterHint.textContent = 'Tip: tap again to confirm your choice.';
        if (actionCountdownLabel) actionCountdownLabel.textContent = 'Time left';
        if (actionCountdownUnit) actionCountdownUnit.textContent = 's';
        if (actionEyebrow) actionEyebrow.textContent = 'Phase 2 ¬∑ Strategy';
        if (actionEventLabel) actionEventLabel.textContent = 'Event';
        if (actionCompetitionLabel) actionCompetitionLabel.textContent = 'Competition';
        if (actionReopenLabel) actionReopenLabel.textContent = 'Open action window';
      } else if (currentLang === 'ja') {
        if (playCardHeader) playCardHeader.textContent = '„Ç´„Éº„Éâ„ÇíÈÅ∏„Çì„Åß‰ΩøÁî®„Åó„Åæ„ÅôÔºÅ';
        if (selectActionTitle) selectActionTitle.textContent = '„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ';
        if (resultTitle) resultTitle.textContent = '„Çø„Éº„É≥ÁµêÊûú';
        if (revealedCardsTitle) revealedCardsTitle.textContent = 'üé¥ ÂÖ¨Èñã„Åï„Çå„Åü„Ç´„Éº„Éâ';
        if (actionHelper) actionHelper.textContent = '„Ç´„Ç¶„É≥„Éà„Åå„Çº„É≠„Å´„Å™„ÇãÂâç„Å´Êà¶Áï•„ÇíÊ±∫„ÇÅ„Åæ„Åó„Çá„ÅÜ„ÄÇ';
        if (actionFooterHint) actionFooterHint.textContent = '„Éí„É≥„Éà: „ÇÇ„ÅÜ‰∏ÄÂ∫¶„Çø„ÉÉ„Éó„Åô„Çã„Å®Á¢∫ÂÆö„Åó„Åæ„Åô„ÄÇ';
        if (actionCountdownLabel) actionCountdownLabel.textContent = 'ÊÆã„ÇäÊôÇÈñì';
        if (actionCountdownUnit) actionCountdownUnit.textContent = 'Áßí';
        if (actionEyebrow) actionEyebrow.textContent = '„Éï„Çß„Éº„Ç∫2 ¬∑ „Çπ„Éà„É©„ÉÜ„Ç∏„Éº';
        if (actionEventLabel) actionEventLabel.textContent = '„Ç§„Éô„É≥„Éà';
        if (actionCompetitionLabel) actionCompetitionLabel.textContent = 'Á´∂ÊäÄ';
        if (actionReopenLabel) actionReopenLabel.textContent = '„Ç¢„ÇØ„Ç∑„Éß„É≥ÁîªÈù¢„ÇíÈñã„Åè';
      } else {
        if (playCardHeader) playCardHeader.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏°!';
        if (selectActionTitle) selectActionTitle.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Action!';
        if (resultTitle) resultTitle.textContent = '‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô';
        if (revealedCardsTitle) revealedCardsTitle.textContent = 'üé¥ ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏´‡∏á‡∏≤‡∏¢';
        if (actionHelper) actionHelper.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏∞‡∏´‡∏°‡∏î!';
        if (actionFooterHint) actionFooterHint.textContent = '‡∏ó‡∏¥‡∏õ: ‡πÅ‡∏ï‡∏∞‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
        if (actionCountdownLabel) actionCountdownLabel.textContent = '‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠';
        if (actionCountdownUnit) actionCountdownUnit.textContent = '‡∏ß‡∏¥';
        if (actionEyebrow) actionEyebrow.textContent = 'Phase 2 ¬∑ ‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå';
        if (actionEventLabel) actionEventLabel.textContent = '‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå';
        if (actionCompetitionLabel) actionCompetitionLabel.textContent = '‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô';
        if (actionReopenLabel) actionReopenLabel.textContent = '‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Action';
      }

      // === TRANSLATE ACTION BUTTONS ===
      if (currentLang === 'en') {
        // Update action button text content
        const actionTexts = document.querySelectorAll('.action-text');
        const actionDescs = document.querySelectorAll('.action-description');
        
        if (actionTexts[0]) actionTexts[0].textContent = 'Gacha';
        if (actionTexts[1]) actionTexts[1].textContent = 'Use Skill';
        if (actionTexts[2]) actionTexts[2].textContent = 'Compete';
        if (actionTexts[3]) actionTexts[3].textContent = 'Flee';
        
        if (actionDescs[0]) actionDescs[0].textContent = 'Draw 1 card, lose 5 points';
        if (actionDescs[1]) actionDescs[1].textContent = 'Skill on cooldown for 2 turns';
        if (actionDescs[2]) actionDescs[2].textContent = 'Face off directly';
        if (actionDescs[3]) actionDescs[3].textContent = 'Escape but lose 1 HP';
      } else if (currentLang === 'ja') {
        // Japanese translations
        const actionTexts = document.querySelectorAll('.action-text');
        const actionDescs = document.querySelectorAll('.action-description');
        
        if (actionTexts[0]) actionTexts[0].textContent = '„Ç¨„ÉÅ„É£';
        if (actionTexts[1]) actionTexts[1].textContent = '„Çπ„Ç≠„É´‰ΩøÁî®';
        if (actionTexts[2]) actionTexts[2].textContent = 'Áõ¥Êé•ÂØæÊà¶';
        if (actionTexts[3]) actionTexts[3].textContent = 'ÈÄÉ„Åí„Çã';
        
        if (actionDescs[0]) actionDescs[0].textContent = '1Êûö„Éâ„É≠„Éº„ÄÅ„Çπ„Ç≥„Ç¢-5';
        if (actionDescs[1]) actionDescs[1].textContent = '„Çπ„Ç≠„É´„ÅØ2„Çø„Éº„É≥„ÇØ„Éº„É´„ÉÄ„Ç¶„É≥';
        if (actionDescs[2]) actionDescs[2].textContent = 'Áõ¥Êé•ÂØæÊà¶„Åô„Çã';
        if (actionDescs[3]) actionDescs[3].textContent = 'ÈÄÉ„Åí„Çã„ÅåHP-1';
      } else {
        // Reset to Thai
        const actionTexts = document.querySelectorAll('.action-text');
        const actionDescs = document.querySelectorAll('.action-description');
        
        if (actionTexts[0]) actionTexts[0].textContent = '‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤';
        if (actionTexts[1]) actionTexts[1].textContent = '‡πÉ‡∏ä‡πâ‡∏™‡∏Å‡∏¥‡∏•';
        if (actionTexts[2]) actionTexts[2].textContent = '‡πÅ‡∏Ç‡πà‡∏á‡∏ï‡∏£‡∏á ‡πÜ';
        if (actionTexts[3]) actionTexts[3].textContent = '‡∏ñ‡∏≠‡∏¢‡∏´‡∏ô‡∏µ';
        
        if (actionDescs[0]) actionDescs[0].textContent = '‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤ 1 ‡πÉ‡∏ö ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏î‡∏•‡∏á 5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô';
        if (actionDescs[1]) actionDescs[1].textContent = '‡∏ï‡∏¥‡∏î CD 2 ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô';
        if (actionDescs[2]) actionDescs[2].textContent = '‡∏û‡∏•‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°';
        if (actionDescs[3]) actionDescs[3].textContent = '‡πÄ‡∏™‡∏µ‡∏¢‡∏û‡∏•‡∏±‡∏á‡πÉ‡∏à 1';
      }

      // === TRANSLATE PLAY CARD PHASE MESSAGES ===
      const clickCardMsg = document.getElementById('clickCardMsg');
      const cardsAppearMsg = document.getElementById('cardsAppearMsg');
      
      if (currentLang === 'en') {
        if (clickCardMsg) clickCardMsg.textContent = 'Click card to view details';
        if (cardsAppearMsg) cardsAppearMsg.textContent = 'Your cards will appear here...';
      } else if (currentLang === 'ja') {
        if (clickCardMsg) clickCardMsg.textContent = '„Ç´„Éº„Éâ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Ë©≥Á¥∞„ÇíË°®Á§∫';
        if (cardsAppearMsg) cardsAppearMsg.textContent = '„ÅÇ„Å™„Åü„ÅÆ„Ç´„Éº„Éâ„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô...';
      } else {
        if (clickCardMsg) clickCardMsg.textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
        if (cardsAppearMsg) cardsAppearMsg.textContent = '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...';
      }

      // Update language button styles
      const langBtnTh = document.getElementById('langBtnTh');
      const langBtnEn = document.getElementById('langBtnEn');
      const langBtnJa = document.getElementById('langBtnJa');
      
      if (langBtnTh && langBtnEn && langBtnJa) {
        // Reset all buttons
        langBtnTh.style.background = '#667eea';
        langBtnTh.style.color = '#fff';
        langBtnEn.style.background = '#667eea';
        langBtnEn.style.color = '#fff';
        langBtnJa.style.background = '#667eea';
        langBtnJa.style.color = '#fff';
        
        // Highlight active language
        if (currentLang === 'th') {
          langBtnTh.style.background = '#ffd700';
          langBtnTh.style.color = '#000';
        } else if (currentLang === 'en') {
          langBtnEn.style.background = '#ffd700';
          langBtnEn.style.color = '#000';
        } else if (currentLang === 'ja') {
          langBtnJa.style.background = '#ffd700';
          langBtnJa.style.color = '#000';
        }
      }

      if (menuInfoPanel && menuInfoPanel.classList.contains('show') && activeMenuInfoTopic) {
        setMenuInfoContent(activeMenuInfoTopic);
      }
    }

    function changeLanguage(lang) {
      loadLanguage(lang);
    }

    const gameState = {
      phase: 'init',
      roomCode: null,
      playerName: null,
      myCard: null,
      myAction: null,
      hand: [],
      players: [],
      turn: 1,
      event: null,
      competition: null,
      isReady: false,
      isHost: false,
      playedCards: {}
    };

    let _countdownInterval = null;
    let _joinMode = false;

    const PHASE_TIMERS = {
      eventReveal: 5,
      playCard: 25,
      action: 25,
      results: 7
    };

    function collapseActionModal() {
      if (!actionPhaseElement || actionModalCollapsed || !actionPhaseElement.classList.contains('show')) return;
      actionModalCollapsed = true;
      actionPhaseElement.classList.add('collapsed');
      if (actionReopenBtn) {
        actionReopenBtn.style.display = 'flex';
        actionReopenBtn.setAttribute('aria-expanded', 'false');
      }
    }

    function expandActionModal() {
      if (!actionPhaseElement || !actionModalCollapsed) return;
      actionModalCollapsed = false;
      actionPhaseElement.classList.remove('collapsed');
      if (actionReopenBtn) {
        actionReopenBtn.style.display = 'none';
        actionReopenBtn.setAttribute('aria-expanded', 'true');
      }
    }

    function hideActionPhaseOverlay() {
      if (!actionPhaseElement) return;
      actionModalCollapsed = false;
      actionPhaseElement.classList.remove('collapsed');
      actionPhaseElement.classList.remove('show');
      if (actionReopenBtn) {
        actionReopenBtn.style.display = 'none';
        actionReopenBtn.setAttribute('aria-expanded', 'false');
      }
    }

    if (actionPhaseElement) {
      actionPhaseElement.addEventListener('click', (event) => {
        if (event.target === actionPhaseElement) {
          collapseActionModal();
        }
      });
    }

    if (actionReopenBtn) {
      actionReopenBtn.addEventListener('click', () => {
        expandActionModal();
      });
    }

    // ‚úÖ ‡∏õ‡∏¥‡∏î card detail ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ
    document.addEventListener('click', (e) => {
      const cardDetail = document.getElementById('cardDetailPreview');
      const clickedCard = e.target.closest('.card');
      
      // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏•‡∏∞ card detail ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î
      if (!clickedCard && cardDetail && cardDetail.style.display === 'block') {
        hideCardDetail();
      }
    });

    // ==================== SOUND SYSTEM ====================
    const audioState = {
      muted: false,
      bgmEnabled: true,
      userInteracted: false
    };

    const soundEffects = {
      cardDraw: new Audio('/assets/sounds/card_draw.mp3'),
      cardReturn: new Audio('/assets/sounds/card_return.wav'),
      cardPlay: new Audio('/assets/sounds/card_play.wav'),
      cardReveal: new Audio('/assets/sounds/card_reveal.mp3'),
      uiToggle: new Audio('/assets/sounds/ui_toggle.mp3'),
    };

    const loopedSoundEffects = {
      slotSpin: new Audio('/assets/sounds/slot_spin.mp3')
    };

    Object.keys(loopedSoundEffects).forEach(name => {
      if (loopedSoundEffects[name]) {
        loopedSoundEffects[name].loop = true;
        loopedSoundEffects[name].volume = 0.4;
      }
    });

    const backgroundMusic = new Audio('/assets/sounds/bgm_theme.wav');
    backgroundMusic.loop = true;
    backgroundMusic.volume = 0.18;

    [...Object.values(soundEffects), ...Object.values(loopedSoundEffects), backgroundMusic]
      .filter(Boolean)
      .forEach(audio => audio.load());

    function playSound(soundName) {
      if (audioState.muted) return;
      const base = soundEffects[soundName];
      if (!base) return;
      const clone = base.cloneNode();
      clone.volume = base.volume ?? 0.35;
      clone.play().catch(err => console.warn('[Audio] Playback blocked:', err));
    }

    function startLoopSound(name) {
      if (audioState.muted) return;
      const loopSound = loopedSoundEffects[name];
      if (!loopSound) return;
      loopSound.currentTime = 0;
      loopSound.play().catch(err => console.warn('[Audio] Loop playback blocked:', err));
    }

    function stopLoopSound(name) {
      const loopSound = loopedSoundEffects[name];
      if (!loopSound) return;
      loopSound.pause();
      loopSound.currentTime = 0;
    }

    function stopAllLoopingSounds() {
      Object.keys(loopedSoundEffects).forEach(stopLoopSound);
    }

    function startBackgroundMusic() {
      if (audioState.muted || !audioState.bgmEnabled) return;
      backgroundMusic.play().catch(err => console.warn('[Audio] BGM blocked:', err));
    }

    function stopBackgroundMusic() {
      backgroundMusic.pause();
      backgroundMusic.currentTime = 0;
    }

    function handleFirstAudioUnlock() {
      if (audioState.userInteracted) return;
      audioState.userInteracted = true;
      startBackgroundMusic();
    }

    const unlockHandler = () => {
      handleFirstAudioUnlock();
      window.removeEventListener('pointerdown', unlockHandler);
      window.removeEventListener('keydown', unlockHandler);
    };
    window.addEventListener('pointerdown', unlockHandler, { once: true });
    window.addEventListener('keydown', unlockHandler, { once: true });

    const muteToggleBtn = document.getElementById('audioMuteToggle');
    const bgmToggleBtn = document.getElementById('bgmToggleButton');

    function updateAudioControlUI() {
      if (muteToggleBtn) {
        muteToggleBtn.classList.toggle('muted', audioState.muted);
        muteToggleBtn.setAttribute('aria-pressed', audioState.muted ? 'true' : 'false');
        muteToggleBtn.innerHTML = `${audioState.muted ? 'üîá' : 'üîä'} <span class="audio-label">SFX</span>`;
      }
      if (bgmToggleBtn) {
        const bgmDisabled = !audioState.bgmEnabled || audioState.muted;
        bgmToggleBtn.classList.toggle('muted', bgmDisabled);
        bgmToggleBtn.setAttribute('aria-pressed', (!bgmDisabled).toString());
        bgmToggleBtn.innerHTML = `${audioState.bgmEnabled ? 'üéµ' : 'üö´'} <span class="audio-label">BGM</span>`;
      }
    }

    if (muteToggleBtn) {
      muteToggleBtn.addEventListener('click', () => {
        audioState.muted = !audioState.muted;
        if (audioState.muted) {
          stopBackgroundMusic();
          stopAllLoopingSounds();
        } else if (audioState.bgmEnabled) {
          startBackgroundMusic();
        }
        updateAudioControlUI();
        playSound('uiToggle');
      });
    }

    if (bgmToggleBtn) {
      bgmToggleBtn.addEventListener('click', () => {
        audioState.bgmEnabled = !audioState.bgmEnabled;
        if (audioState.bgmEnabled && !audioState.muted) {
          startBackgroundMusic();
        } else {
          stopBackgroundMusic();
        }
        updateAudioControlUI();
        playSound('uiToggle');
      });
    }

    updateAudioControlUI();

    // ==================== GLOBAL MENU ====================
    const globalMenuContainer = document.getElementById('globalMenuContainer');
    const globalMenuButton = document.getElementById('globalMenuButton');
    const sideMenuPanel = document.getElementById('sideMenuPanel');
    const menuOverlay = document.getElementById('menuOverlay');
    const sideMenuClose = document.getElementById('sideMenuClose');
    const menuInfoTitle = document.getElementById('menuInfoTitle');
    const menuInfoBody = document.getElementById('menuInfoBody');
    const menuInfoClose = document.getElementById('menuInfoClose');
    const menuItems = document.querySelectorAll('.side-menu-item');
    let activeMenuInfoTopic = null;

    function toggleSideMenu(forceState = null) {
      if (!sideMenuPanel || !menuOverlay) return;
      const shouldOpen = forceState !== null ? forceState : !sideMenuPanel.classList.contains('show');
      if (shouldOpen) {
        sideMenuPanel.classList.add('show');
        menuOverlay.classList.add('show');
        globalMenuButton.classList.add('menu-open');
        globalMenuButton.setAttribute('aria-expanded', 'true');
      } else {
        sideMenuPanel.classList.remove('show');
        menuOverlay.classList.remove('show');
        globalMenuButton.classList.remove('menu-open');
        globalMenuButton.setAttribute('aria-expanded', 'false');
      }
    }

    function setMenuInfoContent(topic) {
      if (!menuInfoTitle || !menuInfoBody) return;
      const titleKey = topic === 'about' ? 'menuAbout' : topic === 'gameInfo' ? 'menuGameInfo' : 'menuLabel';
      const bodyKey = topic === 'about' ? 'menuAboutContent' : topic === 'gameInfo' ? 'menuGameInfoContent' : 'menuLabel';
      menuInfoTitle.textContent = t(titleKey);
      menuInfoBody.innerHTML = t(bodyKey);
    }

    function showMenuInfo(topic) {
      if (!menuInfoPanel) return;
      activeMenuInfoTopic = topic;
      setMenuInfoContent(topic);
      menuInfoPanel.classList.add('show');
      menuInfoPanel.setAttribute('aria-hidden', 'false');
    }

    function hideMenuInfo() {
      if (!menuInfoPanel) return;
      activeMenuInfoTopic = null;
      menuInfoPanel.classList.remove('show');
      menuInfoPanel.setAttribute('aria-hidden', 'true');
    }

    function handleMenuAction(action) {
      toggleSideMenu(false);
      if (action === 'home') {
        hideMenuInfo();
        navigateToHomeScreen();
      } else if (action === 'about' || action === 'gameInfo') {
        showMenuInfo(action);
      }
    }

    function navigateToHomeScreen() {
      location.href = '/';
    }

    function updateGlobalMenuVisibility() {
      if (!globalMenuButton) return;
      const shouldShow = gameState.phase === 'lobby';
      globalMenuButton.style.display = shouldShow ? 'flex' : 'none';
      if (!shouldShow) {
        toggleSideMenu(false);
        hideMenuInfo();
      }
    }

    if (globalMenuButton) {
      globalMenuButton.addEventListener('click', () => toggleSideMenu());
    }

    if (sideMenuClose) {
      sideMenuClose.addEventListener('click', () => toggleSideMenu(false));
    }

    if (menuOverlay) {
      menuOverlay.addEventListener('click', () => toggleSideMenu(false));
    }

    if (menuInfoClose) {
      menuInfoClose.addEventListener('click', hideMenuInfo);
    }

    if (menuInfoPanel) {
      menuInfoPanel.addEventListener('click', (event) => {
        if (event.target === menuInfoPanel) {
          hideMenuInfo();
        }
      });
    }

    if (menuItems && menuItems.length > 0) {
      menuItems.forEach(item => {
        item.addEventListener('click', () => handleMenuAction(item.dataset.action));
      });
    }

    // Keyboard shortcut to close menu
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && sideMenuPanel?.classList.contains('show')) {
        toggleSideMenu(false);
      }
    });

    // Load initial language after UI controls are ready
    loadLanguage(currentLang);

    // ==================== DECK ANIMATION FUNCTIONS ====================
    async function animateDrawCard(targetElement, cardData) {
      return new Promise((resolve) => {
        playSound('cardDraw');
        
        const deckPile = document.getElementById('deckPile');
        const deckRect = deckPile.getBoundingClientRect();
        
        // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô hand ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ hand container
        const lastCard = targetElement.querySelector('.card:last-child');
        const targetRect = lastCard ? lastCard.getBoundingClientRect() : targetElement.getBoundingClientRect();
        
        const flyingCard = document.createElement('div');
        flyingCard.className = 'card-flying';
        flyingCard.style.cssText = `
          left: ${deckRect.left}px;
          top: ${deckRect.top}px;
          width: 110px;
          height: 158px;
          background-image: url('/assets/images/cards/0Backcard.jpg');
          background-size: cover;
          border-radius: 12px;
          transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
          border: 2px solid #00d2ff;
          box-shadow: 0 4px 15px rgba(0, 210, 255, 0.5);
        `;
        
        document.body.appendChild(flyingCard);
        
        setTimeout(() => {
          flyingCard.style.left = `${targetRect.left}px`;
          flyingCard.style.top = `${targetRect.top}px`;
          flyingCard.style.width = '90px';
          flyingCard.style.height = '130px';
          flyingCard.style.transform = 'rotate(360deg)';
        }, 50);
        
        setTimeout(() => {
          flyingCard.remove();
          resolve();
        }, 550);
      });
    }

    async function animateReturnCard(sourceElement) {
      return new Promise((resolve) => {
        playSound('cardReturn');
        
        const deckPile = document.getElementById('deckPile');
        const deckRect = deckPile.getBoundingClientRect();
        const sourceRect = sourceElement.getBoundingClientRect();
        
        const flyingCard = document.createElement('div');
        flyingCard.className = 'card-flying';
        flyingCard.style.cssText = `
          left: ${sourceRect.left}px;
          top: ${sourceRect.top}px;
          width: ${sourceRect.width}px;
          height: ${sourceRect.height}px;
          background-image: url('/assets/images/cards/0Backcard.jpg');
          background-size: cover;
          border-radius: 12px;
          transition: all 0.7s cubic-bezier(0.4, 0, 0.2, 1);
          border: 2px solid #00d2ff;
          box-shadow: 0 4px 15px rgba(255, 107, 107, 0.5);
        `;
        
        document.body.appendChild(flyingCard);
        
        setTimeout(() => {
          flyingCard.style.left = `${deckRect.left}px`;
          flyingCard.style.top = `${deckRect.top}px`;
          flyingCard.style.width = '110px';
          flyingCard.style.height = '158px';
          flyingCard.style.transform = 'rotate(-360deg) scale(0.9)';
          flyingCard.style.opacity = '0';
        }, 50);
        
        setTimeout(() => {
          flyingCard.remove();
          resolve();
        }, 750);
      });
    }

    // ==================== LOBBY FUNCTIONS ====================
    function createRoom() {
      const name = document.getElementById('playerName').value.trim() || '‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô';
      gameState.playerName = name;
      socket.emit('createRoom', { name });
    }

    function toggleJoinMode() {
      _joinMode = !_joinMode;
      const roomInput = document.getElementById('roomCode');
      const joinBtn = document.getElementById('joinToggle');
      const createBtn = document.querySelector('.btn-create');
      const backBtn = document.getElementById('backBtn');

      if (_joinMode) {
        roomInput.style.display = 'block';
        joinBtn.textContent = currentLang === 'en' ? '‚úì Join' : currentLang === 'ja' ? '‚úì ÂèÇÂä†' : '‚úì ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°';
        joinBtn.onclick = () => joinRoom();
        createBtn.style.display = 'none';
        backBtn.style.display = 'block';
        roomInput.focus();
      } else {
        roomInput.style.display = 'none';
        roomInput.value = '';
        joinBtn.textContent = currentLang === 'en' ? 'üë• Join Room' : currentLang === 'ja' ? 'üë• „É´„Éº„É†„Å´ÂèÇÂä†' : 'üë• ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°';
        joinBtn.onclick = () => toggleJoinMode();
        createBtn.style.display = 'inline-block';
        backBtn.style.display = 'none';
      }
    }

    function goBack() {
      toggleJoinMode();
    }

    function joinRoom() {
      const code = document.getElementById('roomCode').value.trim().toUpperCase();
      const name = document.getElementById('playerName').value.trim() || '‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô';

      if (code.length !== 6) {
        showError(currentLang === 'en' ? 'Please enter 6-digit room code!' : currentLang === 'ja' ? '6Ê°Å„ÅÆ„É´„Éº„É†„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ' : '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 6 ‡∏ï‡∏±‡∏ß!');
        return;
      }

      gameState.playerName = name;
      socket.emit('joinRoom', { code, name });
    }

    function toggleReady() {
      socket.emit('toggleReady', { code: gameState.roomCode });
    }

    function startGame() {
      socket.emit('startGame', gameState.roomCode);
    }

    // ==================== UI UPDATES ====================
    function showLobby() {
      gameState.phase = 'lobby';
      document.getElementById('lobbyContainer').classList.remove('hidden');
      document.getElementById('gameContainer').classList.add('hidden');
      document.getElementById('roomCodeShare').style.display = 'none';
      _joinMode = false;
      document.getElementById('roomCode').style.display = 'none';
      document.getElementById('joinToggle').textContent = currentLang === 'en' ? 'üë• Join Room' : currentLang === 'ja' ? 'üë• „É´„Éº„É†„Å´ÂèÇÂä†' : 'üë• ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°';
      document.getElementById('backBtn').style.display = 'none';
      updatePageLanguage(); // ‚úÖ Update UI text on lobby display
      updateGlobalMenuVisibility();
    }

    function showGame() {
      gameState.phase = 'game';
      document.getElementById('lobbyContainer').classList.add('hidden');
      document.getElementById('gameContainer').classList.remove('hidden');
      updateGlobalMenuVisibility();
    }

    function updateLobbyUI(players) {
      const list = document.getElementById('playersList');
      const playersHeaderText = currentLang === 'en' ? 'üë• Players' : currentLang === 'ja' ? 'üë• „Éó„É¨„Ç§„É§„Éº' : 'üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô';
      const readyText = currentLang === 'en' ? 'Ready ‚úì' : currentLang === 'ja' ? 'Ê∫ñÂÇôÂÆå‰∫Ü ‚úì' : '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚úì';
      const waitingText = currentLang === 'en' ? 'Waiting...' : currentLang === 'ja' ? 'ÂæÖÊ©ü‰∏≠...' : '‡∏£‡∏≠...';
      
      list.innerHTML = `<h3 style="color: #00ff88; margin-bottom: 12px;">${playersHeaderText}</h3>` +
        players.map(p => 
          `<div class="player-item">
            <span>${p.name}</span>
            ${p.ready ? `<span class="player-ready">${readyText}</span>` : `<span style="color: #f39c12;">${waitingText}</span>`}
          </div>`
        ).join('');

      const readyBtn = document.getElementById('readyBtn');
      const startBtn = document.getElementById('startBtn');
      
      const readyBtnReadyText = currentLang === 'en' ? 'Cancel Ready' : currentLang === 'ja' ? 'Ê∫ñÂÇô„Ç≠„É£„É≥„Çª„É´' : '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°';
      const readyBtnNotReadyText = currentLang === 'en' ? 'Ready!' : currentLang === 'ja' ? 'Ê∫ñÂÇôÂÆå‰∫ÜÔºÅ' : '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß!';
      
      const me = players.find(p => p.name === gameState.playerName);
      if (me && me.ready) {
        readyBtn.textContent = readyBtnReadyText;
        readyBtn.classList.add('ready');
      } else {
        readyBtn.textContent = readyBtnNotReadyText;
        readyBtn.classList.remove('ready');
      }

      if (players.length >= 2 && players.every(p => p.ready)) {
        startBtn.classList.add('show');
      } else {
        startBtn.classList.remove('show');
      }
    }

    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î + ‡πÅ‡∏™‡∏î‡∏á back card ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô
    const SKILL_DESCRIPTIONS = {
      'salt': 'üåä No effect',
      'leek_shield': 'üõ°Ô∏è No heart loss this turn',
      'never_give_up': 'üí™ +2 Willpower',
      'golden_microphone': 'üé§ +5 Vocal',
      'feet_of_fire': 'üî• +5 Dance',
      'makeup_shop_visit': 'üíÑ +5 Visual',
      'mic_power_cut': 'üìµ Opponents -5 Vocal',
      'freeze_spell': '‚ùÑÔ∏è Opponents -5 Dance',
      'banana_slip': 'üçå Opponents -5 Visual',
      'fate_control': 'üé≤ Change competition type',
      'hidden_skill': 'üëª Block opponent skills',
      'gacha_god': 'üé∞ Draw 3 cards',
      'divine_card': '‚ú® Revive + 10 cards'
    };

    function createCardElement(card, isMe = true, revealed = false) {
      const div = document.createElement('div');
      div.className = 'card';
      div.dataset.cardId = card.id; // ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏á‡∏≤‡∏¢‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á

      const typeEmojis = {
        'happy': 'üòä',
        'love': 'üíñ',
        'hope': '‚ú®'
      };

      // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏â‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏á‡∏≤‡∏¢ ‚Üí ‡πÅ‡∏™‡∏î‡∏á backcard (‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î)
      if (!isMe && !revealed) {
        div.style.backgroundImage = `url('/assets/images/cards/0Backcard.jpg')`;
        div.style.backgroundSize = 'cover';
        div.style.backgroundPosition = 'center';
        div.innerHTML = ``;
        div.dataset.revealed = 'false';
        return div;
      }

      // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏Å‡∏≤‡∏£‡πå‡∏î (‡∏ó‡∏±‡πâ‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏á‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß)
      const cardImageUrl = `/assets/images/cards/${String(card.id).padStart(3, '0')}.png`;
      div.style.backgroundImage = `url('${cardImageUrl}')`;
      div.style.backgroundSize = 'cover';
      div.style.backgroundPosition = 'center';
      div.dataset.revealed = 'true'; // ‚úÖ ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡πà‡∏≤‡∏´‡∏á‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° click handler ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡∏π‡∏°
      div.addEventListener('click', (e) => {
        e.stopPropagation();
        showCardPreview(card);
      });

      const skillDesc = SKILL_DESCRIPTIONS[card.skill] || card.skill;
      
      // Store card data for preview
      div.dataset.cardData = JSON.stringify(card);
      
      // ‚úÖ ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á stat ‡∏ã‡πâ‡∏≠‡∏ô‡∏ö‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏ô‡πÇ‡∏ï‡πä‡∏∞ - ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
      div.innerHTML = ``;
      return div;
    }

    // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á preview ‡∏Å‡∏≤‡∏£‡πå‡∏î (zoom)
    function showCardPreview(card) {
      const previewDiv = document.querySelector('.cardPreview');
      const statsDiv = document.querySelector('.cardPreviewStats');
      if (!previewDiv || !statsDiv) return;

      const typeEmojis = {
        'happy': 'üòä',
        'love': 'üíñ',
        'hope': '‚ú®'
      };

      // Show card image on left
      const cardImageUrl = `/assets/images/cards/${String(card.id).padStart(3, '0')}.png`;
      previewDiv.style.backgroundImage = `url('${cardImageUrl}')`;
      previewDiv.style.backgroundSize = 'cover';
      previewDiv.style.backgroundPosition = 'center';
      previewDiv.innerHTML = '';
      
      // ‚úÖ Translate skill name and character name
      const translatedSkill = translateSkillName(card.skill);
      const translatedCharacter = translateCharacterName(card.character);
      
      // Show stats on right
      statsDiv.style.display = 'block';
      statsDiv.innerHTML = `
        <div style="font-weight: bold; color: #ffd700; font-size: 1rem; margin-bottom: 4px;">${translatedCharacter}</div>
        <div style="margin-bottom: 2px;"><span style="font-size: 1rem;">${typeEmojis[card.type] || '?'}</span> <strong>${(card.type || '?').toUpperCase()}</strong></div>
        <div style="margin: 2px 0; font-size: 0.8rem;">üìå Rarity: ${card.rarity}</div>
        <div style="margin: 2px 0; font-size: 0.8rem;">üë• Group: ${card.group}</div>
        <div style="margin: 2px 0; font-size: 0.8rem; color: #00d2ff;">‚ú® Skill: ${translatedSkill}</div>
        <hr style="border: 1px solid #00d2ff; margin: 4px 0;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; text-align: center;">
          <div style="background: rgba(255, 107, 157, 0.2); padding: 8px; border-radius: 3px; font-size: 1.2rem;">üé§<br><strong style="font-size: 1.4rem;">${card.vocal}</strong></div>
          <div style="background: rgba(0, 212, 255, 0.2); padding: 8px; border-radius: 3px; font-size: 1.2rem;">üíÉ<br><strong style="font-size: 1.4rem;">${card.dance}</strong></div>
          <div style="background: rgba(255, 215, 0, 0.2); padding: 8px; border-radius: 3px; font-size: 1.2rem;">‚ú®<br><strong style="font-size: 1.4rem;">${card.visual}</strong></div>
        </div>
      `;
    }

    function updateTableDisplay() {
      // ‚úÖ Translate event and competition names based on language
      let displayEventName = gameState.event?.name || gameState.event || '-';
      if ((currentLang === 'en' || currentLang === 'ja') && gameState.event?.name) {
        displayEventName = translateEventName(gameState.event.name);
      }
      document.getElementById('tableEvent').textContent = 'üìç ' + displayEventName;
      const actionMetaEvent = document.getElementById('actionMetaEvent');
      if (actionMetaEvent) actionMetaEvent.textContent = displayEventName;
      
      const competitionLabels = {
        'vocal': currentLang === 'en' ? 'üé§ Vocal Battle' : currentLang === 'ja' ? 'üé§ „Éú„Éº„Ç´„É´„Éê„Éà„É´' : 'üé§ Vocal Battle',
        'dance': currentLang === 'en' ? 'üíÉ Rhythm Clash' : currentLang === 'ja' ? 'üíÉ „É™„Ç∫„É†„ÇØ„É©„ÉÉ„Ç∑„É•' : 'üíÉ Rhythm Clash',
        'visual': currentLang === 'en' ? '‚ú® Stage Charm' : currentLang === 'ja' ? '‚ú® „Çπ„ÉÜ„Éº„Ç∏„ÉÅ„É£„Éº„É†' : '‚ú® Stage Charm'
      };
      const competitionText = competitionLabels[gameState.competition] || (gameState.competition || '-');
      document.getElementById('tableCompetition').textContent = 'üèÜ ' + competitionText;
      const actionMetaCompetition = document.getElementById('actionMetaCompetition');
      if (actionMetaCompetition) actionMetaCompetition.textContent = competitionText;

      // ‚úÖ Add GAME RULE + CHEAT SHEET buttons to top-left (only once)
      const btnContainer = document.getElementById('gameControlButtons');
      if (btnContainer.innerHTML === '') {
        const ruleBtn = document.createElement('button');
        ruleBtn.textContent = 'üìñ GAME RULE';
        ruleBtn.style.cssText = `
          padding: 12px 20px; font-size: 0.95rem; font-weight: bold;
          background: linear-gradient(135deg, #3498db, #2980b9);
          border: 2px solid #00d2ff; color: #00d2ff; border-radius: 8px;
          cursor: pointer; transition: all 0.3s; width: 140px;
        `;
        ruleBtn.onmouseover = () => ruleBtn.style.boxShadow = '0 0 20px rgba(0, 210, 255, 0.5)';
        ruleBtn.onmouseout = () => ruleBtn.style.boxShadow = 'none';
        ruleBtn.onclick = () => showGameRuleModal();
        
        const cheatBtn = document.createElement('button');
        cheatBtn.textContent = '‚ö° CHEAT SHEET';
        cheatBtn.style.cssText = `
          padding: 12px 20px; font-size: 0.95rem; font-weight: bold;
          background: linear-gradient(135deg, #e74c3c, #c0392b);
          border: 2px solid #ff6b6b; color: #ff6b6b; border-radius: 8px;
          cursor: pointer; transition: all 0.3s; width: 140px;
        `;
        cheatBtn.onmouseover = () => cheatBtn.style.boxShadow = '0 0 20px rgba(255, 107, 107, 0.5)';
        cheatBtn.onmouseout = () => cheatBtn.style.boxShadow = 'none';
        cheatBtn.onclick = () => showCheatSheetModal();
        
        btnContainer.appendChild(ruleBtn);
        btnContainer.appendChild(cheatBtn);
      }

      // Find my position and rotate player order so I'm at bottom (p1)
      const myIndex = gameState.players.findIndex(p => p.name === gameState.playerName);
      const playerAreas = ['player1Area', 'player2Area', 'player3Area', 'player4Area', 'player5Area'];
      
      // ‚úÖ ‡∏ã‡πà‡∏≠‡∏ô‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
      playerAreas.forEach(areaId => {
        const area = document.getElementById(areaId);
        area.style.display = 'none';
        area.innerHTML = '';
      });
      
      // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
      gameState.players.forEach((player, idx) => {
        // Rotate: if myIndex=0, positions become [1,2,3,0]
        // if myIndex=1, positions become [2,3,0,1], etc
        const rotatedIdx = (idx - myIndex + gameState.players.length) % gameState.players.length;
        const areaId = playerAreas[rotatedIdx];
        
        if (areaId) {
          const area = document.getElementById(areaId);
          area.style.display = 'flex'; // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ
          const isMe = player.name === gameState.playerName;
          
          // Clear previous content
          area.innerHTML = '';
          
          // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô hearts ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î (‡∏•‡∏ö‡∏õ‡∏∏‡πà‡∏°)
          if (isMe) {
            // Add player name tag
            const nameTag = document.createElement('div');
            nameTag.className = 'player-name-tag';
            nameTag.textContent = player.name;
            area.appendChild(nameTag);
            
            // Add hearts
            const hearts = document.createElement('div');
            hearts.className = 'player-hearts-display';
            hearts.textContent = '‚ô• ' + (player.heart || 0);
            area.appendChild(hearts);
            
            // ‚úÖ Add played card (visual)
            if (gameState.playedCards[player.name]) {
              const card = gameState.playedCards[player.name];
              const cardElement = createCardElement(card, isMe);
              cardElement.setAttribute('data-player', player.name);
              cardElement.classList.add('table-card'); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡∏û‡∏¥‡πÄ‡∏®‡∏©
              // ‚úÖ Reset inline styles ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏•‡∏∏‡∏î
              cardElement.style.position = 'relative';
              cardElement.style.marginLeft = '0';
              cardElement.style.transform = 'none';
              area.appendChild(cardElement);
            }
            return;
          }
          
          // Add player name tag
          const nameTag = document.createElement('div');
          nameTag.className = 'player-name-tag';
          nameTag.textContent = player.name;
          area.appendChild(nameTag);
          
          // Add hearts
          const hearts = document.createElement('div');
          hearts.className = 'player-hearts-display';
          hearts.textContent = '‚ô• ' + (player.heart || 0);
          area.appendChild(hearts);
          
          // ‚úÖ Add played card (visual) - ‡∏Ñ‡∏ß‡πà‡∏≥‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏â‡∏±‡∏ô
          if (gameState.playedCards[player.name]) {
            const card = gameState.playedCards[player.name];
            // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡πÇ‡∏´‡∏ô‡πÄ‡∏ã‡πÑ‡∏Å ‚Üí ‡∏´‡∏á‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            const isRevealed = (gameState.event?.effect === 'reveal_cards');
            const cardElement = createCardElement(card, isMe, isRevealed);
            cardElement.setAttribute('data-player', player.name);
            cardElement.classList.add('table-card'); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡∏û‡∏¥‡πÄ‡∏®‡∏©
            // ‚úÖ Reset inline styles ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏•‡∏∏‡∏î
            cardElement.style.position = 'relative';
            cardElement.style.marginLeft = '0';
            cardElement.style.transform = 'none';
            area.appendChild(cardElement);
          }
        }
      });
    }

    // ‚úÖ Modal: GAME RULE
    function showGameRuleModal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center;
        z-index: 2000;
      `;
      
      const gameRuleContent = currentLang === 'en' ? `
        <div style="background: #1a1a2e; border: 3px solid #00d2ff; border-radius: 15px; padding: 30px; max-width: 700px; max-height: 85vh; overflow-y: auto; color: #00ff88;">
          <div style="font-size: 2rem; font-weight: bold; color: #ffd700; margin-bottom: 20px; text-align: center;">üìñ GAME RULE</div>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">Game Details & How to Play:</h3>
          <p>‚Ä¢ 2-5 players</p>
          <p>‚Ä¢ Start: Everyone has 6 ‚ô•</p>
          <p>‚Ä¢ Each Turn: Have 5 cards (no draw except from Actions)</p>
          <p>‚Ä¢ Events: 19 random events per turn</p>
          <p>‚Ä¢ Competition: Random between Vocal, Dance, Visual</p>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">Game Steps:</h3>
          <p>1. Select 1 card to play</p>
          <p>2. Choose an Action:</p>
          <p style="margin-left: 20px;">‚Ä¢ Action 1 Gacha: Get 1 card but score -5</p>
          <p style="margin-left: 20px;">‚Ä¢ Action 2 Use Skill: CD 2 turns</p>
          <p style="margin-left: 20px;">‚Ä¢ Action 3 Compete: Direct competition</p>
          <p style="margin-left: 20px;">‚Ä¢ Action 4 Flee: Lose 1 ‚ô• but keep card</p>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">Score Calculation:</h3>
          <p><strong>Vocal Battle:</strong> Vocal√ó2 + Dance√ó1.5 + Visual√ó1 + modifiers</p>
          <p><strong>Rhythm Clash:</strong> Dance√ó2 + Visual√ó1.5 + Vocal√ó1 + modifiers</p>
          <p><strong>Stage Charm:</strong> Visual√ó2 + Vocal√ó1.5 + Dance√ó1 + modifiers</p>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">How to Win:</h3>
          <p>‚Ä¢ Winner: Last one with ‚ô• remaining</p>
          <p>‚Ä¢ Loser: No cards or no ‚ô•</p>
          <p>‚Ä¢ Draw: Both lose at same time</p>
          
          <div style="text-align: center; margin-top: 30px;">
            <button style="padding: 12px 30px; font-size: 1.1rem; background: #27ae60; border: 2px solid #2ecc71; color: white; border-radius: 8px; cursor: pointer;">‚úì Close</button>
          </div>
        </div>
      ` : currentLang === 'ja' ? `
        <div style="background: #1a1a2e; border: 3px solid #00d2ff; border-radius: 15px; padding: 30px; max-width: 700px; max-height: 85vh; overflow-y: auto; color: #00ff88;">
          <div style="font-size: 2rem; font-weight: bold; color: #ffd700; margin-bottom: 20px; text-align: center;">üìñ „Ç≤„Éº„É†„É´„Éº„É´</div>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">„Ç≤„Éº„É†Ë©≥Á¥∞„Å®ÈÅä„Å≥Êñπ:</h3>
          <p>‚Ä¢ „Éó„É¨„Ç§„É§„Éº: 2ÔΩû5‰∫∫</p>
          <p>‚Ä¢ ÈñãÂßãÊôÇ: ÂÖ®Âì°6 ‚ô•„ÇíÊåÅ„Å§</p>
          <p>‚Ä¢ ÂêÑ„Çø„Éº„É≥: 5Êûö„ÅÆ„Ç´„Éº„Éâ„ÇíÊâÄÊåÅÔºà„Ç¢„ÇØ„Ç∑„Éß„É≥‰ª•Â§ñ„ÅØÂºï„Åã„Å™„ÅÑÔºâ</p>
          <p>‚Ä¢ „Ç§„Éô„É≥„Éà: ÊØé„Çø„Éº„É≥19ÂÄã„ÅÆ„É©„É≥„ÉÄ„É†„Ç§„Éô„É≥„Éà</p>
          <p>‚Ä¢ ÂØæÊà¶: „Éú„Éº„Ç´„É´„Éª„ÉÄ„É≥„Çπ„Éª„Éì„Ç∏„É•„Ç¢„É´„Åã„Çâ„É©„É≥„ÉÄ„É†</p>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">„Ç≤„Éº„É†„Çπ„ÉÜ„ÉÉ„Éó:</h3>
          <p>1. ‰ΩøÁî®„Åô„Çã„Ç´„Éº„Éâ1Êûö„ÇíÈÅ∏Êäû</p>
          <p>2. „Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû:</p>
          <p style="margin-left: 20px;">‚Ä¢ „Ç¢„ÇØ„Ç∑„Éß„É≥1 „Ç¨„ÉÅ„É£: 1ÊûöÁç≤Âæó„Åß„Çπ„Ç≥„Ç¢-5</p>
          <p style="margin-left: 20px;">‚Ä¢ „Ç¢„ÇØ„Ç∑„Éß„É≥2 „Çπ„Ç≠„É´‰ΩøÁî®: CD2„Çø„Éº„É≥</p>
          <p style="margin-left: 20px;">‚Ä¢ „Ç¢„ÇØ„Ç∑„Éß„É≥3 Áõ¥Êé•ÂØæÊà¶: „Çπ„Ç≥„Ç¢Ë®àÁÆó</p>
          <p style="margin-left: 20px;">‚Ä¢ „Ç¢„ÇØ„Ç∑„Éß„É≥4 ÈÄÉ„Åí„Çã: ‚ô•1Â§±„ÅÜ„Åå„Ç´„Éº„Éâ„Ç≠„Éº„Éó</p>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">„Çπ„Ç≥„Ç¢Ë®àÁÆó:</h3>
          <p><strong>„Éú„Éº„Ç´„É´„Éê„Éà„É´:</strong> „Éú„Éº„Ç´„É´√ó2 + „ÉÄ„É≥„Çπ√ó1.5 + „Éì„Ç∏„É•„Ç¢„É´√ó1 + ‰øÆÊ≠£ÂÄ§</p>
          <p><strong>„É™„Ç∫„É†„ÇØ„É©„ÉÉ„Ç∑„É•:</strong> „ÉÄ„É≥„Çπ√ó2 + „Éì„Ç∏„É•„Ç¢„É´√ó1.5 + „Éú„Éº„Ç´„É´√ó1 + ‰øÆÊ≠£ÂÄ§</p>
          <p><strong>„Çπ„ÉÜ„Éº„Ç∏„ÉÅ„É£„Éº„É†:</strong> „Éì„Ç∏„É•„Ç¢„É´√ó2 + „Éú„Éº„Ç´„É´√ó1.5 + „ÉÄ„É≥„Çπ√ó1 + ‰øÆÊ≠£ÂÄ§</p>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">ÂãùÂà©Êù°‰ª∂:</h3>
          <p>‚Ä¢ ÂãùËÄÖ: ‚ô•„ÅåÊÆã„Å£„ÅüÊúÄÂæå„ÅÆ1‰∫∫</p>
          <p>‚Ä¢ ÊïóËÄÖ: „Ç´„Éº„Éâ„Å™„Åó „Åæ„Åü„ÅØ ‚ô•„Å™„Åó</p>
          <p>‚Ä¢ ÂêåÊôÇÊïóÂåó: ÂêåÊôÇ„Å´„Ç´„Éº„Éâ„Åæ„Åü„ÅØ‚ô•„ÅåÁµÇ„Çè„Çã</p>
          
          <div style="text-align: center; margin-top: 30px;">
            <button style="padding: 12px 30px; font-size: 1.1rem; background: #27ae60; border: 2px solid #2ecc71; color: white; border-radius: 8px; cursor: pointer;">‚úì Èñâ„Åò„Çã</button>
          </div>
        </div>
      ` : `
        <div style="background: #1a1a2e; border: 3px solid #00d2ff; border-radius: 15px; padding: 30px; max-width: 700px; max-height: 85vh; overflow-y: auto; color: #00ff88;">
          <div style="font-size: 2rem; font-weight: bold; color: #ffd700; margin-bottom: 20px; text-align: center;">üìñ GAME RULE</div>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô:</h3>
          <p>‚Ä¢ ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 2-5 ‡∏Ñ‡∏ô</p>
          <p>‚Ä¢ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏à‡∏∞‡∏°‡∏µ 6 ‚ô•</p>
          <p>‚Ä¢ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô: ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î 5 ‡πÉ‡∏ö (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡πà‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏≠‡∏≠‡∏Å Action)</p>
          <p>‚Ä¢ ‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå: ‡∏ó‡∏±‡πâ‡∏á 19 ‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô</p>
          <p>‚Ä¢ ‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á: ‡∏™‡∏∏‡πà‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Vocal, Dance, Visual</p>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô:</h3>
          <p>1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î 1 ‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</p>
          <p>2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Action ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥:</p>
          <p style="margin-left: 20px;">‚Ä¢ Action 1 ‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤: ‡πÑ‡∏î‡πâ 1 ‡πÉ‡∏ö‡πÅ‡∏ï‡πà‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -5</p>
          <p style="margin-left: 20px;">‚Ä¢ Action 2 ‡πÉ‡∏ä‡πâ‡∏™‡∏Å‡∏¥‡∏•: ‡∏ï‡∏¥‡∏î CD 2 ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô</p>
          <p style="margin-left: 20px;">‚Ä¢ Action 3 ‡πÅ‡∏Ç‡πà‡∏á‡∏ï‡∏£‡∏á‡πÜ: ‡∏ß‡∏±‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
          <p style="margin-left: 20px;">‚Ä¢ Action 4 ‡∏ñ‡∏≠‡∏¢‡∏´‡∏ô‡∏µ: ‡πÄ‡∏™‡∏µ‡∏¢ ‚ô• 1 ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î</p>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</h3>
          <p><strong>Vocal Battle:</strong> Vocal√ó2 + Dance√ó1.5 + Visual√ó1 + ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏¥‡πÄ‡∏®‡∏©</p>
          <p><strong>Rhythm Clash:</strong> Dance√ó2 + Visual√ó1.5 + Vocal√ó1 + ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏¥‡πÄ‡∏®‡∏©</p>
          <p><strong>Stage Charm:</strong> Visual√ó2 + Vocal√ó1.5 + Dance√ó1 + ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏¥‡πÄ‡∏®‡∏©</p>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏ô‡∏∞:</h3>
          <p>‚Ä¢ ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞: ‡∏°‡∏µ‡∏û‡∏•‡∏±‡∏á‡πÉ‡∏à‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</p>
          <p>‚Ä¢ ‡∏ú‡∏π‡πâ‡πÅ‡∏û‡πâ: ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏•‡∏±‡∏á‡πÉ‡∏à‡∏´‡∏°‡∏î</p>
          <p>‚Ä¢ ‡πÄ‡∏™‡∏°‡∏≠: ‡πÅ‡∏û‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</p>
          
          <div style="text-align: center; margin-top: 30px;">
            <button style="padding: 12px 30px; font-size: 1.1rem; background: #27ae60; border: 2px solid #2ecc71; color: white; border-radius: 8px; cursor: pointer;">‚úì ‡∏õ‡∏¥‡∏î</button>
          </div>
        </div>
      `;
      
      modal.innerHTML = gameRuleContent;
      document.body.appendChild(modal);
      
      // Add close functionality
      const closeBtn = modal.querySelector('button');
      closeBtn.onclick = () => modal.remove();
    }

    // ‚úÖ Modal: CHEAT SHEET (Skills)
    function showCheatSheetModal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center;
        z-index: 2000;
      `;
      
      const skillsContent = currentLang === 'en' ? `
        <div style="background: #1a1a2e; border: 3px solid #ff6b6b; border-radius: 15px; padding: 30px; max-width: 700px; max-height: 85vh; overflow-y: auto; color: #00ff88;">
          <div style="font-size: 2rem; font-weight: bold; color: #ffd700; margin-bottom: 20px; text-align: center;">‚ö° CHEAT SHEET - 13 SKILLS</div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">üåä Salt</strong><br>No skill effect
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">üõ°Ô∏è Leek Shield</strong><br>No ‚ô• loss this turn
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">üí™ Never Give Up</strong><br>+2 Willpower
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">üé§ Golden Microphone</strong><br>+5 Vocal
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">üî• Feet of Fire</strong><br>+5 Dance
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">üíÑ Makeup Shop Visit</strong><br>+5 Visual
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ff6b6b; border-radius: 5px;">
              <strong style="color: #ff6b6b;">üìµ Mic Power Cut</strong><br>Enemy -5 Vocal
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ff6b6b; border-radius: 5px;">
              <strong style="color: #ff6b6b;">‚ùÑÔ∏è Freeze Spell</strong><br>Enemy -5 Dance
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ff6b6b; border-radius: 5px;">
              <strong style="color: #ff6b6b;">üçå Banana Slip</strong><br>Enemy -5 Visual
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px;">
              <strong style="color: #ffd700;">üé≤ Fate Control</strong><br>Change Event (except special)
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px;">
              <strong style="color: #ffd700;">üëª Hidden Skill</strong><br>Block Enemy Skill
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px;">
              <strong style="color: #ffd700;">üé∞ Gacha God</strong><br>Draw 2 Cards
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px; grid-column: 1/3;">
              <strong style="color: #ffd700;">‚ú® Divine Card</strong><br>Revive + 10 Cards (‚ô•=0)
            </div>
          </div>
          
          <div style="text-align: center; margin-top: 30px;">
            <button style="padding: 12px 30px; font-size: 1.1rem; background: #e74c3c; border: 2px solid #ff6b6b; color: white; border-radius: 8px; cursor: pointer;">‚úì Close</button>
          </div>
        </div>
      ` : currentLang === 'ja' ? `
        <div style="background: #1a1a2e; border: 3px solid #ff6b6b; border-radius: 15px; padding: 30px; max-width: 700px; max-height: 85vh; overflow-y: auto; color: #00ff88;">
          <div style="font-size: 2rem; font-weight: bold; color: #ffd700; margin-bottom: 20px; text-align: center;">‚ö° „ÉÅ„Éº„Éà„Ç∑„Éº„Éà - 13„Çπ„Ç≠„É´</div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">üåä Â°©</strong><br>„Çπ„Ç≠„É´ÂäπÊûú„Å™„Åó
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">üõ°Ô∏è „Éç„ÇÆÁõæ</strong><br>„Åì„ÅÆ„Çø„Éº„É≥‚ô•„ÉÄ„É°„Éº„Ç∏„Å™„Åó
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">üí™ Áµ∂ÂØæ„Å´Ë´¶„ÇÅ„Å™„ÅÑ</strong><br>+2 „Ç¶„Ç£„É´„Éë„ÉØ„Éº
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">üé§ „Ç¥„Éº„É´„Éá„É≥„Éû„Ç§„ÇØ</strong><br>+5 „Éú„Éº„Ç´„É´
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">üî• ÁÇé„ÅÆË∂≥</strong><br>+5 „ÉÄ„É≥„Çπ
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">üíÑ „É°„Ç§„ÇØ„Ç∑„Éß„ÉÉ„ÉóË®™Âïè</strong><br>+5 „Éì„Ç∏„É•„Ç¢„É´
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ff6b6b; border-radius: 5px;">
              <strong style="color: #ff6b6b;">üìµ „Éû„Ç§„ÇØÂÅúÊ≠¢</strong><br>Êïµ -5 „Éú„Éº„Ç´„É´
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ff6b6b; border-radius: 5px;">
              <strong style="color: #ff6b6b;">‚ùÑÔ∏è ÂáçÁµêÈ≠îÊ≥ï</strong><br>Êïµ -5 „ÉÄ„É≥„Çπ
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ff6b6b; border-radius: 5px;">
              <strong style="color: #ff6b6b;">üçå „Éê„Éä„Éä„Çπ„É™„ÉÉ„Éó</strong><br>Êïµ -5 „Éì„Ç∏„É•„Ç¢„É´
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px;">
              <strong style="color: #ffd700;">üé≤ ÈÅãÂëΩÊìç‰Ωú</strong><br>„Ç§„Éô„É≥„ÉàÂ§âÊõ¥ÔºàÁâπÊÆäÈô§„ÅèÔºâ
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px;">
              <strong style="color: #ffd700;">üëª Èö†„Åó„Çπ„Ç≠„É´</strong><br>Êïµ„Çπ„Ç≠„É´„Çí„Éñ„É≠„ÉÉ„ÇØ
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px;">
              <strong style="color: #ffd700;">üé∞ „Ç¨„ÉÅ„É£„ÅÆÁ•û</strong><br>2Êûö„Éâ„É≠„Éº
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px; grid-column: 1/3;">
              <strong style="color: #ffd700;">‚ú® Á•û„Ç´„Éº„Éâ</strong><br>Âæ©Ê¥ª + 10Êûö„Éâ„É≠„Éº (‚ô•=0)
            </div>
          </div>
          
          <div style="text-align: center; margin-top: 30px;">
            <button style="padding: 12px 30px; font-size: 1.1rem; background: #e74c3c; border: 2px solid #ff6b6b; color: white; border-radius: 8px; cursor: pointer;">‚úì Èñâ„Åò„Çã</button>
          </div>
        </div>
      ` : `
        <div style="background: #1a1a2e; border: 3px solid #ff6b6b; border-radius: 15px; padding: 30px; max-width: 700px; max-height: 85vh; overflow-y: auto; color: #00ff88;">
          <div style="font-size: 2rem; font-weight: bold; color: #ffd700; margin-bottom: 20px; text-align: center;">‚ö° CHEAT SHEET - 13 SKILLS</div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">üåä ‡πÄ‡∏Å‡∏•‡∏∑‡∏≠</strong><br>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">üõ°Ô∏è ‡πÇ‡∏•‡πà‡πÅ‡∏´‡πà‡∏á‡∏ï‡πâ‡∏ô‡∏´‡∏≠‡∏°</strong><br>‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢ ‚ô• ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ô‡∏µ‡πâ
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">üí™ ‡πÑ‡∏°‡πà‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ</strong><br>+2 ‡∏û‡∏•‡∏±‡∏á‡πÉ‡∏à
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">üé§ ‡πÑ‡∏°‡∏Ñ‡πå‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥</strong><br>+5 Vocal
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">üî• ‡∏Ç‡∏≤‡πÄ‡∏ó‡∏û‡πÑ‡∏ü‡πÄ‡∏£‡∏≤‡∏∞</strong><br>+5 Dance
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">üíÑ ‡πÑ‡∏õ‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤</strong><br>+5 Visual
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ff6b6b; border-radius: 5px;">
              <strong style="color: #ff6b6b;">üìµ ‡πÑ‡∏ü‡∏î‡∏±‡∏ö‡πÑ‡∏°‡∏Ñ‡πå‡∏î‡∏±‡∏ö</strong><br>‡∏®‡∏±‡∏ï‡∏£‡∏π -5 Vocal
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ff6b6b; border-radius: 5px;">
              <strong style="color: #ff6b6b;">‚ùÑÔ∏è ‡∏û‡∏∑‡πâ‡∏ô‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏™‡∏∏‡∏î‡∏•‡∏∑‡πà‡∏ô‡∏õ‡∏∑‡πâ‡∏ô</strong><br>‡∏®‡∏±‡∏ï‡∏£‡∏π -5 Dance
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ff6b6b; border-radius: 5px;">
              <strong style="color: #ff6b6b;">üçå ‡∏•‡∏∑‡πà‡∏ô‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏ß‡∏ó‡∏µ</strong><br>‡∏®‡∏±‡∏ï‡∏£‡∏π -5 Visual
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px;">
              <strong style="color: #ffd700;">üé≤ ‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤‡∏Ç‡πâ‡∏≤‡∏•‡∏¥‡∏Ç‡∏¥‡∏ï</strong><br>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px;">
              <strong style="color: #ffd700;">üëª ‡πÑ‡∏°‡πà‡∏ö‡∏≠‡∏Å</strong><br>Block Skill ‡∏Ç‡∏≠‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px;">
              <strong style="color: #ffd700;">üé∞ ‡πÄ‡∏ó‡∏û‡∏Å‡∏≤‡∏ä‡∏≤</strong><br>‡∏î‡∏∂‡∏á 2 Card
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px; grid-column: 1/3;">
              <strong style="color: #ffd700;">‚ú® ‡πÉ‡∏ö‡πÄ‡∏ó‡∏û</strong><br>‡∏ä‡∏∏‡∏ö‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï + ‡∏î‡∏∂‡∏á 10 Card (‚ô•=0)
            </div>
          </div>
          
          <div style="text-align: center; margin-top: 30px;">
            <button style="padding: 12px 30px; font-size: 1.1rem; background: #e74c3c; border: 2px solid #ff6b6b; color: white; border-radius: 8px; cursor: pointer;">‚úì ‡∏õ‡∏¥‡∏î</button>
          </div>
        </div>
      `;
      
      modal.innerHTML = skillsContent;
      document.body.appendChild(modal);
      
      // Add close functionality
      const closeBtn = modal.querySelector('button');
      closeBtn.onclick = () => modal.remove();
    }

    function renderHand(hand) {
      const container = document.getElementById('hand');
      container.innerHTML = '';
      
      if (!hand || hand.length === 0) {
        container.innerHTML = '<div style="color:#aaa; padding: 20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ô‡∏∞</div>';
        return;
      }

      hand.forEach((card, i) => {
        const div = document.createElement('div');
        div.className = 'card';
        
        const cardId = String(card.id).padStart(3, '0');
        const cardImageUrl = `/assets/images/cards/${cardId}.png`;
        
        const img = document.createElement('img');
        img.src = cardImageUrl;
        img.alt = `Card ${cardId}`;
        img.className = 'card-image';
        img.style.border = 'none';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '12px';
        img.onerror = function() { 
          this.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'; 
        };
        
        div.appendChild(img);
        
        div.onclick = () => {
          showCardDetail(card);
          selectCard(card, div);
        };
        
        container.appendChild(div);
      });
      
      // ‚úÖ ‡∏ñ‡πâ‡∏≤ playCardPhase ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ô phase ‡∏î‡πâ‡∏ß‡∏¢
      const phaseElement = document.getElementById('playCardPhase');
      if (phaseElement && phaseElement.classList.contains('show')) {
        renderCardsInPhase(hand);
      }
    }
    
    function renderCardsInPhase(hand) {
      const phaseContainer = document.getElementById('phaseHandContainer');
      if (!phaseContainer) return;
      
      phaseContainer.innerHTML = '';
      
      hand.forEach((card, i) => {
        const div = document.createElement('div');
        div.className = 'card';
        div.style.marginLeft = '0';
        
        const cardId = String(card.id).padStart(3, '0');
        const cardImageUrl = `/assets/images/cards/${cardId}.png`;
        
        const img = document.createElement('img');
        img.src = cardImageUrl;
        img.alt = `Card ${cardId}`;
        img.className = 'card-image';
        img.style.border = 'none';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '12px';
        img.onerror = function() { 
          this.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'; 
        };
        
        div.appendChild(img);
        
        div.onclick = () => {
          showCardPreview(card);
          selectCardInPhase(card, div);
        };
        
        phaseContainer.appendChild(div);
      });
    }
    
    function selectCardInPhase(card, element) {
      // ‡πÄ‡∏≠‡∏≤ border ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      document.querySelectorAll('#phaseHandContainer .card').forEach(c => {
        c.style.border = 'none';
        c.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.5)';
      });
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° border ‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      element.style.border = '3px solid #ffd700';
      element.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.8), 0 4px 15px rgba(0, 0, 0, 0.5)';
      
      gameState.myCard = card;
      document.getElementById('confirmCard').classList.add('show');
    }

    function showCardDetail(card) {
      const preview = document.getElementById('cardDetailPreview');
      const image = document.getElementById('previewCardImage');
      const info = document.getElementById('previewCardInfo');
      
      const cardId = String(card.id).padStart(3, '0');
      const cardImageUrl = `/assets/images/cards/${cardId}.png`;
      
      image.style.backgroundImage = `url('${cardImageUrl}')`;
      
      const typeEmojis = { 'happy': 'üòä', 'love': 'üíñ', 'hope': '‚ú®' };
      const translatedSkill = translateSkillName(card.skill);
      
      // ‚úÖ Display card stats normally
      let displayVocal = card.vocal;
      let displayDance = card.dance;
      let displayVisual = card.visual;
      
      // ‚úÖ Translate character name
      const translatedCharName = translateCharacterName(card.character);
      
      info.innerHTML = `
        <div style="font-weight: bold; color: #ffd700; font-size: 1.1rem; margin-bottom: 5px;">${translatedCharName}</div>
        <div style="margin-bottom: 3px;">${typeEmojis[card.type] || '?'} ${(card.type || '?').toUpperCase()}</div>
        <div style="font-size: 0.8rem; color: #aaa; margin-bottom: 5px;">Rarity: ${card.rarity}</div>
        <div style="font-size: 0.8rem; color: #00d2ff; margin-bottom: 8px;">‚ú® ${translatedSkill}</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; font-size: 1.1rem;">
          <div style="background: rgba(255,107,157,0.3); padding: 8px; border-radius: 5px; text-align: center;">üé§<br><strong style="font-size: 1.3rem;">${displayVocal}</strong></div>
          <div style="background: rgba(0,212,255,0.3); padding: 8px; border-radius: 5px; text-align: center;">üíÉ<br><strong style="font-size: 1.3rem;">${displayDance}</strong></div>
          <div style="background: rgba(255,215,0,0.3); padding: 8px; border-radius: 5px; text-align: center;">‚ú®<br><strong style="font-size: 1.3rem;">${displayVisual}</strong></div>
        </div>
      `;
      
      preview.style.display = 'block';
    }

    function hideCardDetail() {
      const preview = document.getElementById('cardDetailPreview');
      preview.style.display = 'none';
    }

    function selectCard(card, element) {
      // ‡πÄ‡∏≠‡∏≤ border ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      document.querySelectorAll('#hand .card').forEach(c => {
        c.style.border = 'none';
        c.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.5)';
      });
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° border ‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      element.style.border = '3px solid #ffd700';
      element.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.8), 0 4px 15px rgba(0, 0, 0, 0.5)';
      
      gameState.myCard = card;
      document.getElementById('confirmCard').classList.add('show');
    }

    function showError(msg) {
      const err = document.createElement('div');
      err.className = 'error-message';
      err.textContent = msg;
      document.body.appendChild(err);
      setTimeout(() => err.remove(), 3000);
    }

    // ==================== UTILITY FUNCTIONS ====================
    function formatScore(score) {
      // ‡πÅ‡∏™‡∏î‡∏á decimal ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô .5 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á .0)
      const decimal = score % 1;
      console.log(`[formatScore] score=${score}, decimal=${decimal}, result=${decimal === 0.5 ? score.toFixed(1) : Math.floor(score).toString()}`);
      if (decimal === 0.5) {
        return score.toFixed(1);
      }
      return Math.floor(score).toString();
    }

    // ==================== SOCKET EVENTS ====================
    socket.on('connect', () => {
      console.log('[SPA] ‚úÖ Connected:', socket.id);
      showLobby();
    });

    socket.on('roomCreated', ({ code }) => {
      console.log('[SPA] roomCreated:', code);
      gameState.roomCode = code;
      gameState.isHost = true;
      document.getElementById('displayCode').textContent = code;
      document.getElementById('roomCodeShare').style.display = 'block';
      document.getElementById('roomCode').style.display = 'none';
    });

    socket.on('joined', ({ code }) => {
      console.log('[SPA] joined:', code);
      gameState.roomCode = code;
    });

    socket.on('updateLobby', (data) => {
      console.log('[SPA] updateLobby:', data);
      gameState.players = data.players;
      updateLobbyUI(data.players);
    });

    socket.on('gameStarted', (data) => {
      console.log('[SPA] gameStarted:', data);
      console.log('[i18n-game] Current language:', currentLang);
      gameState.turn = data.turn || 1;
      gameState.players = data.players || [];
      gameState.playedCards = {};
      
      // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏Å‡πà‡∏≤
      document.getElementById('resultOverlay').classList.remove('show');
      const slotOverlay = document.getElementById('slotOverlay');
      if (slotOverlay) {
        slotOverlay.style.display = 'none';
      }
      
      // ‚úÖ ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤ - ‡∏ñ‡πâ‡∏≤ server ‡∏™‡πà‡∏á‡∏°‡∏≤)
      if (data.hand && Array.isArray(data.hand)) {
        gameState.hand = data.hand;
        console.log('[SPA] Received starting hand:', data.hand.length, 'cards');
      }
      
      showGame();
      updateTableDisplay();
      updatePageLanguage(); // ‚úÖ Update language on game start
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
      if (gameState.hand && gameState.hand.length > 0) {
        renderHand(gameState.hand);
      }
      
      console.log('[SPA] ‚úÖ Game started, waiting for initial hand draw...');
    });

    // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° - ‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î 5 ‡πÉ‡∏ö‡∏ó‡∏µ‡∏•‡∏∞‡πÉ‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô
    socket.on('initialHandDraw', async (data) => {
      console.log('[SPA] üé¥ Initial hand draw:', data.cards.length, 'cards');
      
      // ‚úÖ ‡∏´‡∏¢‡∏∏‡∏î timer ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      clearInterval(_countdownInterval);
      
      // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï gameState ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      gameState.turn = data.turn || 1;
      gameState.players = data.players || [];
      gameState.hand = [];
      gameState.playedCards = {};
      gameState.myCard = null;  // ‚úÖ Clear ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡πà‡∏≤
      gameState.myAction = null;  // ‚úÖ Clear action ‡πÄ‡∏Å‡πà‡∏≤
      
      // ‚úÖ ‡∏ã‡πà‡∏≠‡∏ô UI ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      document.getElementById('resultOverlay').classList.remove('show');
      document.getElementById('playCardPhase').classList.remove('show');
      hideActionPhaseOverlay();
      const slotOverlay = document.getElementById('slotOverlay');
      if (slotOverlay) {
        slotOverlay.style.display = 'none';
      }
      
      showGame();
      updateTableDisplay();
      
      // ‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡∏•‡∏∞‡πÉ‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô
      const handContainer = document.getElementById('hand');
      for (const card of data.cards) {
        gameState.hand.push(card);
        const animPromise = animateDrawCard(handContainer, card);
        await new Promise(resolve => setTimeout(resolve, 450)); // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏¢‡∏°‡∏≤‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ó‡∏≤‡∏á
        renderHand(gameState.hand); // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏≠‡∏ô‡∏•‡∏≠‡∏¢‡∏°‡∏≤‡∏ñ‡∏∂‡∏á
        await animPromise; // ‡∏£‡∏≠‡πÉ‡∏´‡πâ animation ‡πÄ‡∏™‡∏£‡πá‡∏à
        await new Promise(resolve => setTimeout(resolve, 150)); // delay ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
      }
      
      console.log('[SPA] ‚úÖ Initial hand complete, waiting for event slot...');
    });

    // ‚úÖ Gacha God - ‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î 2 ‡πÉ‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô
    socket.on('gachaGodDraw', async (data) => {
      console.log('[SPA] üé∞ Gacha God draw:', data.cards.length, 'cards');
      const handContainer = document.getElementById('hand');
      for (const card of data.cards) {
        gameState.hand.push(card);
        await animateDrawCard(handContainer, card);
        await new Promise(resolve => setTimeout(resolve, 500)); // 0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ/‡πÉ‡∏ö
      }
      renderHand(gameState.hand);
      console.log('[SPA] ‚úÖ Gacha God complete!');
    });

    // ‚úÖ Divine Card Revival - ‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î 10 ‡πÉ‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô
    socket.on('divineCardRevive', async (data) => {
      console.log('[SPA] ‚ú® Divine Card Revival:', data.cards.length, 'cards');
      const handContainer = document.getElementById('hand');
      for (const card of data.cards) {
        gameState.hand.push(card);
        await animateDrawCard(handContainer, card);
        await new Promise(resolve => setTimeout(resolve, 500)); // 0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ/‡πÉ‡∏ö
      }
      renderHand(gameState.hand);
      console.log('[SPA] ‚úÖ Divine Card Revival complete!');
    });

    // ‚úÖ ‡πÄ‡∏ü‡∏™‡∏™‡∏∏‡πà‡∏°‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå (Slot Machine)
    socket.on('eventSlotStart', (data) => {
      console.log('[SPA] üé∞ Event slot starting...', data);
      startLoopSound('slotSpin');
      showEventSlotMachine(data.duration, data.finalEvent); // ‚úÖ ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
    });

    socket.on('eventSlotResult', (data) => {
      console.log('[SPA] üé≤ Event revealed:', data.event);
      stopLoopSound('slotSpin');
      gameState.event = data.event;
      gameState.revealCards = data.event.effect === 'reveal_cards';
      showEventResult(data.event);
      updateTableDisplay();
    });

    // ‚úÖ ‡πÄ‡∏ü‡∏™‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á (Slot Machine)
    socket.on('competitionSlotStart', (data) => {
      console.log('[SPA] üé∞ Competition slot starting...', data);
      startLoopSound('slotSpin');
      showCompetitionSlotMachine(data.duration, data.finalCompetition); // ‚úÖ ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
    });

    socket.on('competitionSlotResult', (data) => {
      console.log('[SPA] üìç Competition revealed:', data.competition);
      stopLoopSound('slotSpin');
      gameState.competition = data.competition;
      
      // ‚úÖ ‡∏ñ‡πâ‡∏≤ skipSlot = true (‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤) ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏•‡∏≠‡∏ï
      if (data.skipSlot) {
        console.log('[SPA] ‚ùì ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤ - ‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏•‡∏≠‡∏ï‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô');
        showCompetitionResult(data.competition);
      } else {
        showCompetitionResult(data.competition);
      }
      
      updateTableDisplay(); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    });

    // ‚úÖ ‡πÄ‡∏ü‡∏™‡∏´‡∏á‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î
    socket.on('revealCardsPhase', (data) => {
      console.log('[SPA] üé¥ Revealing cards...', data);
      console.log('[DEBUG] skillEffects:', data.skillEffects);
      console.log('[DEBUG] skillEffects length:', data.skillEffects ? data.skillEffects.length : 'undefined');
      
      // ‚úÖ ‡∏´‡∏á‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏ô‡πÇ‡∏ï‡πä‡∏∞‡πÅ‡∏ó‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πá‡∏≠‡∏õ‡∏≠‡∏±‡∏û
      revealAllCards();
      playSound('cardReveal');
      
      // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏Å‡∏¥‡∏•‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Ñ‡∏´‡∏•‡∏±‡∏á‡∏´‡∏á‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      if (data.skillEffects && data.skillEffects.length > 0) {
        console.log('[DEBUG] Will show skill effects in 3 seconds...');
        setTimeout(() => {
          console.log('[DEBUG] Showing skill effects NOW!');
          showSkillEffects(data.skillEffects);
        }, 3000);
      } else {
        console.log('[DEBUG] No skill effects to show');
      }
    });

    // ‚úÖ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏ô‡πÄ‡∏ã‡πÑ‡∏Å - ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏Å‡∏¥‡∏•‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏á‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î
    socket.on('showSkillEffectsOnly', (data) => {
      console.log('[SPA] üí´ Showing skill effects (no reveal)...', data);
      if (data.skillEffects && data.skillEffects.length > 0) {
        showSkillEffects(data.skillEffects);
      }
    });

    socket.on('newTurn', (data) => {
      console.log('[SPA] newTurn received:', data);
      gameState.turn = data.turn || gameState.turn;
      // ‚ùå ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó event/competition ‡∏à‡∏≤‡∏Å newTurn ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏™‡∏•‡πá‡∏≠‡∏ï‡πÅ‡∏•‡πâ‡∏ß
      // gameState.event = data.event || null;
      // gameState.competition = data.competition || null;
      gameState.players = data.players || gameState.players;
      gameState.myCard = null;
      gameState.myAction = null;
      gameState.playedCards = {};
      gameState.actionCooldown = data.actionCooldown || 0;

      document.getElementById('turnNumber').textContent = gameState.turn;
      
      // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏û‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡πÄ‡∏Å‡∏°
      const me = gameState.players.find(p => p.name === gameState.playerName);
      const spectatorMode = document.getElementById('spectatorMode');
      if (me && (me.heart <= 0 || me.handCount <= 0)) {
        spectatorMode.style.display = 'block';
        console.log('[SPA] üíÄ Player eliminated - spectator mode active');
      } else {
        spectatorMode.style.display = 'none';
      }
      
      // ‚ùå ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á updateTableDisplay ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏ô eventSlotResult ‡πÅ‡∏•‡∏∞ competitionSlotResult ‡πÅ‡∏•‡πâ‡∏ß
      // updateTableDisplay();

      if (data.hand && Array.isArray(data.hand)) {
        console.log('[SPA] Received hand with', data.hand.length, 'cards');
        gameState.hand = data.hand;
        renderHand(gameState.hand);
      } else {
        console.warn('[SPA] No hand data in newTurn');
      }

      // ‚úÖ ‡∏Ç‡πâ‡∏≤‡∏° eventRevealPhase ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Mikudayo (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡∏°‡∏µ‡πÄ‡∏ü‡∏™‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å)
      if (data.isMikudayo) {
        console.log('[SPA] üéÅ Mikudayo event - skipping eventRevealPhase, starting playCard phase');
        // ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å startEventRevealPhase() - ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
        startPlayCardPhase(); // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å startPlayCardPhase ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      } else {
        startEventRevealPhase();
      }
    });

    socket.on('allPlayedCards', (data) => {
      console.log('[SPA] allPlayedCards:', data);
      if (data.playedCards) {
        gameState.playedCards = data.playedCards;
      }
      
      // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö event data ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô updateTableDisplay
      if (data.event) {
        gameState.event = data.event;
      }
      
      updateTableDisplay();
      setTimeout(() => {
        startActionPhase();
      }, 1000);
    });

    socket.on('gameOver', (data) => {
      console.log('[SPA] üèÜ GAME OVER:', data);
      clearInterval(_countdownInterval);
      hideActionPhaseOverlay();
      document.getElementById('playCardPhase').classList.remove('show');
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏à‡∏ö‡πÄ‡∏Å‡∏°
      const overlay = document.getElementById('slotOverlay');
      if (overlay) {
        let html = '<div class="slot-container"><div class="slot-machine">';
        
        if (data.isDraw) {
          html += `
            <div style="font-size: 3rem; color: #ffd700; margin: 20px 0;">ü§ù</div>
            <div style="font-size: 2rem; color: #fff; margin: 20px 0;">‡πÄ‡∏™‡∏°‡∏≠!</div>
            <div style="font-size: 1.2rem; color: #aaa; margin: 10px 0;">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÅ‡∏û‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</div>
          `;
        } else {
          html += `
            <div style="font-size: 3rem; color: #ffd700; margin: 20px 0;">üèÜ</div>
            <div style="font-size: 2.5rem; color: #00ff88; margin: 20px 0;">${data.winnerName}</div>
            <div style="font-size: 1.5rem; color: #fff; margin: 10px 0;">‡∏ä‡∏ô‡∏∞‡πÄ‡∏Å‡∏°!</div>
          `;
        }
        
        if (data.reason === 'shrimp_curse') {
          html += `<div style="font-size: 1rem; color: #ff6b6b; margin: 10px 0;">ü¶ê ‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏Å‡∏∏‡πâ‡∏á</div>`;
        }
        
        html += '</div></div>';
        overlay.innerHTML = html;
        overlay.style.display = 'flex';
        
        // ‚úÖ Auto ‡∏Å‡∏•‡∏±‡∏ö lobby ‡∏´‡∏•‡∏±‡∏á 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setTimeout(() => {
          overlay.style.display = 'none';
          showLobby();
        }, 5000);
      }
    });

    socket.on('turnResult', (result) => {
      console.log('[SPA] turnResult:', result);
      clearInterval(_countdownInterval);
      hideActionPhaseOverlay();
      
      // ‡∏ã‡πà‡∏≠‡∏ô slot overlay
      const slotOverlay = document.getElementById('slotOverlay');
      if (slotOverlay) {
        slotOverlay.style.display = 'none';
      }
      
      document.getElementById('resultOverlay').classList.add('show');
      
      // ‚ùå ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏Å‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô revealCardsPhase
      
      // ==================== PHASE 1: Show Revealed Cards (SKIP - ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß) ====================
      // ‚ùå ‡∏•‡∏ö‡∏õ‡πá‡∏≠‡∏õ‡∏≠‡∏±‡∏û revealedCards ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏´‡∏á‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ô‡∏•‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î
      const revealedSection = document.getElementById('revealedCardsSection');
      if (revealedSection) {
        revealedSection.style.display = 'none';
      }
      
      // Initially hide score boxes
      document.getElementById('playersScoreGrid').style.display = 'none';
      document.getElementById('winnerAnnouncement').style.display = 'none';
      
      // ==================== PHASE 2: Show Results after 1.5 seconds ====================
      setTimeout(() => {
        // Hide revealed cards
        document.getElementById('revealedCardsSection').style.display = 'none';
        
        // Show score boxes
        document.getElementById('playersScoreGrid').style.display = 'grid';
        document.getElementById('winnerAnnouncement').style.display = 'block';
        
        // ‚úÖ Create score map from actionResults
        const scoreMap = {};
        if (result.actionResults && result.actionResults.length > 0) {
          result.actionResults.forEach(ar => {
            scoreMap[ar.name] = ar.score;
          });
        }
        
        console.log('[SPA] scoreMap:', scoreMap);
        
        // Build player score boxes
        const playersScoreGrid = document.getElementById('playersScoreGrid');
        playersScoreGrid.innerHTML = '';
        
        // ‚úÖ Reset gameOverMessage div at the start
        const gameOverDiv = document.getElementById('gameOverMessage');
        gameOverDiv.style.display = 'none';
        gameOverDiv.innerHTML = '';
        
        (result.players || gameState.players || []).forEach(player => {
          const thisRoundScore = scoreMap[player.name] || 0;
          console.log(`[SPA] ${player.name}: ${thisRoundScore} pts`);
          
          const scoreLabel = currentLang === 'ja' ? '„Éù„Ç§„É≥„Éà' : currentLang === 'en' ? 'Points' : '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô';
          const box = document.createElement('div');
          box.className = 'player-score-box';
          box.innerHTML = `
            <div class="player-score-name">${player.name}</div>
            <div class="player-score-hearts">${'‚ô•'.repeat(player.heart || 0)}</div>
            <div class="player-score-points">${formatScore(thisRoundScore)} ${scoreLabel}</div>
          `;
          playersScoreGrid.appendChild(box);
        });
        
        // Show winner announcement for this turn
        const announcementDiv = document.getElementById('winnerAnnouncement');
        const noWinnerText = currentLang === 'ja' ? 'ÂãùËÄÖ„Å™„Åó' : currentLang === 'en' ? 'No Winner' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞';
        const scoreLabel = currentLang === 'ja' ? '„Éù„Ç§„É≥„Éà' : currentLang === 'en' ? 'Points' : '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô';
        announcementDiv.innerHTML = `
          <div class="turn-winner">üèÜ ${result.winnerName || noWinnerText}</div>
          <div class="turn-winner-score">${formatScore(result.winnerScore || 0)} ${scoreLabel}</div>
        `;
        
        // Check if game is over
        if (result.gameOver === true) {
          gameOverDiv.style.display = 'block';
          
          console.log(`üèÜ [GAME OVER] Winner: ${result.winnerNameFinal}, Draw: ${result.isDraw}`);
          
          // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏°‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞
          const drawText = currentLang === 'ja' ? '„Ç≤„Éº„É†Âºï„ÅçÂàÜ„ÅëÔºÅ' : currentLang === 'en' ? 'Game Draw!' : '‡πÄ‡∏Å‡∏°‡πÄ‡∏™‡∏°‡∏≠!';
          const playersText = currentLang === 'ja' ? '„Éó„É¨„Ç§„É§„Éº' : currentLang === 'en' ? 'Players' : '‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô';
          const winnerText = currentLang === 'ja' ? '„Ç≤„Éº„É†„ÅÆÂãùËÄÖ„Åß„ÅôÔºÅ' : currentLang === 'en' ? 'is the Game Winner!' : '‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡πÄ‡∏Å‡∏°!';
          
          if (result.isDraw === true) {
            gameOverDiv.innerHTML = `
              <div class="final-winner-text">ü§ù ${drawText}</div>
              <div class="draw-players-text">${playersText}: ${result.drawPlayers.join(', ')}</div>
            `;
          } else if (result.winnerNameFinal) {
            gameOverDiv.innerHTML = `
              <div class="final-winner-text">üéâ ${result.winnerNameFinal} ${winnerText} üéâ</div>
            `;
          }
          
          // ‚úÖ Auto ‡∏Å‡∏•‡∏±‡∏ö lobby ‡∏´‡∏•‡∏±‡∏á 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
          setTimeout(() => {
            showLobby();
          }, 5000);
        } else {
          // Auto proceed to next turn after 3 more seconds
          setTimeout(() => {
            document.getElementById('resultOverlay').classList.remove('show');
          }, 3000);
        }
      }, 1500);

      gameState.players = result.players || gameState.players;
      // ‚ùå ‡πÑ‡∏°‡πà update ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞ update ‡∏´‡∏•‡∏±‡∏á returnCards animation ‡πÅ‡∏ó‡∏ô
    });

    // ==================== DECK ANIMATION LISTENERS ====================
    socket.on('returnCards', async (data) => {
      console.log('[SPA] üì§ Returning cards to deck...', data);
      
      // ‡πÅ‡∏™‡∏î‡∏á animation ‡∏Ñ‡∏∑‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (‡∏à‡∏≤‡∏Å player area)
      if (data.playedCards && data.playedCards.length > 0) {
        for (const pc of data.playedCards) {
          // ‡∏´‡∏≤ element ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡πÉ‡∏ô player area
          const playerAreas = document.querySelectorAll('.player-area .card');
          let cardElement = null;
          
          // ‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ data-player ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
          for (const card of playerAreas) {
            if (card.dataset && card.dataset.player === pc.playerName) {
              cardElement = card;
              break;
            }
          }
          
          if (cardElement) {
            console.log(`[ANIM] Returning card from ${pc.playerName}`);
            await animateReturnCard(cardElement);
          } else {
            console.log(`[ANIM] Card element not found for ${pc.playerName}, using fallback`);
            // fallback: ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ö‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠
            if (playerAreas.length > 0) {
              await animateReturnCard(playerAreas[0]);
            }
          }
        }
      }
      
      // ‚úÖ Clear played cards ‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à
      gameState.playedCards = {};
      updateTableDisplay();
      
      console.log('[SPA] ‚úÖ All cards returned to deck');
    });

    socket.on('drawCards', async (data) => {
      console.log('[SPA] üé¥ Drawing cards...', data);
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏∑‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏° animation
      if (data.cards && data.cards.length > 0) {
        for (let i = 0; i < data.cards.length; i++) {
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ gameState ‡∏Å‡πà‡∏≠‡∏ô
          gameState.hand.push(data.cards[i]);
          
          // Render ‡∏°‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á element ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡∏°‡πà
          renderHand(gameState.hand);
          
          // ‡∏´‡∏≤ element ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)
          const handElement = document.getElementById('hand');
          const lastCard = handElement.lastElementChild;
          
          if (lastCard) {
            console.log(`[ANIM] Drawing card ${i+1}/${data.cards.length}: ${data.cards[i].character}`);
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÅ‡∏™‡∏î‡∏á animation
            lastCard.style.opacity = '0';
            await animateDrawCard(lastCard, data.cards[i]);
            lastCard.style.opacity = '1';
          }
        }
        
        console.log('[SPA] ‚úÖ Drew', data.cards.length, 'cards -', data.reason);
      }
    });

    socket.on('error', (msg) => {
      console.error('[SPA] server error:', msg);
      showError('‚ùå ' + msg);
    });

    socket.on('disconnect', (reason) => {
      console.warn('[SPA] disconnected:', reason);
    });

    // ‚úÖ Fate Control - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà
    socket.on('fateControlEventChange', (data) => {
      console.log('[SPA] üé¥ Fate Control activated:', data);
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡πÉ‡∏ä‡πâ‡∏™‡∏Å‡∏¥‡∏•
      const overlay = document.getElementById('slotOverlay');
      if (overlay) {
        overlay.innerHTML = `
          <div class="slot-container">
            <h2 style="color: #ff00ff; font-size: 2rem; margin-bottom: 20px;">‚ú® Fate Control!</h2>
            <p style="color: #fff; font-size: 1.5rem; margin-bottom: 20px;">${data.player} ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå!</p>
            <h3 style="color: #ff6b6b; font-size: 1.8rem; margin: 10px 0;">‚ùå ${data.oldEvent.name}</h3>
            <h3 style="color: #666; font-size: 2rem; margin: 10px 0;">‚¨áÔ∏è</h3>
            <h3 style="color: #00ff88; font-size: 1.8rem; margin: 10px 0;">‚úÖ ${data.newEvent.name}</h3>
          </div>
        `;
        overlay.style.display = 'flex';
        
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï gameState
        gameState.event = data.newEvent;
        
        // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setTimeout(() => {
          overlay.style.display = 'none';
        }, 3000);
      }
    });

    // ==================== TRANSLATION HELPER ====================
    function translateEventName(thaiName) {
      if (!thaiName) return thaiName;
      
      // For English and Japanese, try to find the key in eventsByName mapping
      if (currentLang === 'en' || currentLang === 'ja') {
        const eventKey = translations.eventsByName ? translations.eventsByName[thaiName] : null;
        if (eventKey && translations.events && translations.events[eventKey]) {
          return translations.events[eventKey];
        }
      }
      
      // Fallback to direct lookup in events
      const directTranslation = translations.events ? Object.values(translations.events).find(name => name === thaiName) : null;
      return directTranslation || thaiName;
    }
    
    function translateSkillName(skillName) {
      if (!skillName) return skillName;
      
      console.log('[translateSkillName] Input:', skillName, 'Lang:', currentLang, 'Translations loaded:', !!translations.skillNames);
      
      // Convert underscore to space for lookup (server sends with underscore, JSON uses space)
      const skillNameWithSpace = skillName.replace(/_/g, ' ');
      
      // For Thai and Japanese, use skillNames mapping
      if (currentLang === 'th' || currentLang === 'ja') {
        if (translations.skillNames && translations.skillNames[skillNameWithSpace]) {
          console.log('[translateSkillName] Found translation:', translations.skillNames[skillNameWithSpace]);
          return translations.skillNames[skillNameWithSpace];
        } else {
          console.warn('[translateSkillName] No translation found for:', skillNameWithSpace, 'Available keys:', Object.keys(translations.skillNames || {}));
        }
      }
      
      // For English, convert underscore to space and capitalize each word
      if (currentLang === 'en') {
        return skillNameWithSpace.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
      }
      
      // Fallback to the converted skill name
      return skillNameWithSpace;
    }
    
    function translateCharacterName(englishName) {
      if (!englishName || !translations.characters) return englishName;
      
      // If English is selected, return the English name
      if (currentLang === 'en') {
        return translations.characters[englishName] || englishName;
      }
      
      // For Thai and Japanese, both have direct mappings
      const translation = translations.characters[englishName];
      if (translation) {
        return translation;
      }
      
      // Fallback to original English name
      return englishName;
    }

    function translateEventDescription(thaiDescription) {
      if (!thaiDescription) return thaiDescription;
      if (currentLang !== 'en' && currentLang !== 'ja') return thaiDescription;
      
      // Event descriptions translation mapping
      const eventDescriptions = {
        "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡∏¢ ‡πÄ‡∏•‡πà‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥": {
          en: "Nothing special happens. Play normally.",
          ja: "Áâπ„Å´‰Ωï„ÇÇËµ∑„Åç„Åæ„Åõ„Çì„ÄÇÈÄöÂ∏∏ÈÄö„Çä„Éó„É¨„Ç§„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
        },
        "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å VS ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô": {
          en: "VS members gain +5 score.",
          ja: "VS „É°„É≥„Éê„Éº„Åå+5„Çπ„Ç≥„Ç¢Áç≤Âæó"
        },
        "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å LN ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô": {
          en: "LN members gain +5 score.",
          ja: "LN „É°„É≥„Éê„Éº„Åå+5„Çπ„Ç≥„Ç¢Áç≤Âæó"
        },
        "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å MMJ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô": {
          en: "MMJ members gain +5 score.",
          ja: "MMJ „É°„É≥„Éê„Éº„Åå+5„Çπ„Ç≥„Ç¢Áç≤Âæó"
        },
        "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å VBS ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô": {
          en: "VBS members gain +5 score.",
          ja: "VBS „É°„É≥„Éê„Éº„Åå+5„Çπ„Ç≥„Ç¢Áç≤Âæó"
        },
        "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å WxS ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô": {
          en: "WxS members gain +5 score.",
          ja: "WxS „É°„É≥„Éê„Éº„Åå+5„Çπ„Ç≥„Ç¢Áç≤Âæó"
        },
        "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å Niko ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô": {
          en: "Niko members gain +5 score.",
          ja: "Niko „É°„É≥„Éê„Éº„Åå+5„Çπ„Ç≥„Ç¢Áç≤Âæó"
        },
        "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏•‡∏¥‡∏°‡∏¥‡∏ï/‡πÄ‡∏ü‡∏™ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 10 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô": {
          en: "Limited/Festival cards gain +10 score.",
          ja: "„É™„Éü„ÉÜ„ÉÉ„Éâ/„Éï„Çß„Çπ„ÉÜ„Ç£„Éê„É´„Ç´„Éº„Éâ„Åå+10„Çπ„Ç≥„Ç¢Áç≤Âæó"
        },
        "‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤‡∏Ñ‡∏ô‡∏•‡∏∞ 3 ‡πÉ‡∏ö": {
          en: "Players draw 3 random cards.",
          ja: "„Éó„É¨„Ç§„É§„Éº„Åå3Êûö„É©„É≥„ÉÄ„É†„Å´„Éâ„É≠„Éº"
        },
        "‡∏Ñ‡πà‡∏≤‡∏û‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏¢‡∏≠‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ô‡∏±‡πâ‡∏ô ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ": {
          en: "Highest stat of the card is nullified.",
          ja: "„Ç´„Éº„Éâ„ÅÆÊúÄÈ´ò„Çπ„ÉÜ„Éº„Çø„Çπ„ÅåÁÑ°ÂäπÂåñ„Åï„Çå„Çã"
        },
        "‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏°‡∏¥‡∏Å‡∏∏‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏û‡∏•‡∏±‡∏á‡πÉ‡∏à 1 ‡∏´‡∏ô‡πà‡∏ß‡∏¢": {
          en: "Players recover 1 willpower.",
          ja: "„Éó„É¨„Ç§„É§„Éº„Åå„Ç¶„Ç£„É´„Éë„ÉØ„Éº1ÂõûÂæ©"
        },
        "Kohane ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 30 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô": {
          en: "Kohane gains +30 score.",
          ja: "Â∞èÊò•„Åå+30„Çπ„Ç≥„Ç¢Áç≤Âæó"
        },
        "‡∏•‡∏ö‡∏Ñ‡πà‡∏≤‡∏û‡∏•‡∏±‡∏á‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞ 2 ‡∏´‡∏ô‡πà‡∏ß‡∏¢": {
          en: "All stats reduced by 2.",
          ja: "ÂÖ®„Å¶„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Åå2Ê∏õÂ∞ë"
        },
        "‡πÑ‡∏°‡πà‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô ‡πÅ‡∏Ç‡πà‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏Ñ‡πà‡∏≤‡∏û‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà+‡∏Å‡∏±‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì": {
          en: "Special battle: Add stats, no multiplier.",
          ja: "ÁâπÂà•ÂØæÊà¶Ôºö„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂêàÁÆó„ÄÅ‰πóÊï∞„Å™„Åó"
        },
        "‡∏´‡∏á‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ô‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ô‡∏±‡πâ‡∏ô": {
          en: "Cards are revealed this turn.",
          ja: "„Åì„ÅÆ„Çø„Éº„É≥„Ç´„Éº„Éâ„ÅåÂÖ¨Èñã„Åï„Çå„Çã"
        },
        "‡∏Ñ‡πà‡∏≤‡∏û‡∏•‡∏±‡∏á‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô -1 ": {
          en: "Players lose 1 willpower.",
          ja: "„Éó„É¨„Ç§„É§„Éº„Åå„Ç¶„Ç£„É´„Éë„ÉØ„Éº1Âñ™Â§±"
        },
        "Type love ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô": {
          en: "Love type cards gain +5 score.",
          ja: "„É©„Éñ„Çø„Ç§„Éó„Ç´„Éº„Éâ„Åå+5„Çπ„Ç≥„Ç¢Áç≤Âæó"
        },
        "Type hope ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô": {
          en: "Hope type cards gain +5 score.",
          ja: "„Éõ„Éº„Éó„Çø„Ç§„Éó„Ç´„Éº„Éâ„Åå+5„Çπ„Ç≥„Ç¢Áç≤Âæó"
        },
        "Type happy ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô": {
          en: "Happy type cards gain +5 score.",
          ja: "„Éè„ÉÉ„Éî„Éº„Çø„Ç§„Éó„Ç´„Éº„Éâ„Åå+5„Çπ„Ç≥„Ç¢Áç≤Âæó"
        }
      };
      
      const translation = eventDescriptions[thaiDescription];
      if (translation) {
        return currentLang === 'ja' ? translation.ja : translation.en;
      }
      return thaiDescription;
    }

    // ==================== SLOT MACHINE FUNCTIONS ====================
    // Event names in Thai and English
    const EVENTS_TH = [
      "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£","Magical Mirai","‡∏á‡∏≤‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡πÄ‡∏ß‡∏ó‡∏µ‡πÑ‡∏≠‡∏î‡∏≠‡∏•",
      "Vivid Street","Phoenix land","‡πÇ‡∏ã‡πÄ‡∏ã‡∏µ‡∏¢‡∏•‡πÑ‡∏ß‡∏£‡∏±‡∏•","Festival",
      "‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏à‡∏≤‡∏Å Mikudayo","NeneRobo ‡∏Ñ‡∏•‡∏±‡πà‡∏á","‡∏°‡∏π‡∏ü‡∏ß‡∏µ‡πà‡∏â‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß!",
      "SapphireR","‡∏°‡∏¥‡∏Å‡∏∏VBS‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß","‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤!?","‡πÇ‡∏´‡∏ô‡πÄ‡∏ã‡πÑ‡∏Å",
      "‡∏Å‡∏∏‡πâ‡∏á","Type love ‡∏ö‡∏±‡∏ü","Type hope ‡∏ö‡∏±‡∏ü","Type happy ‡∏ö‡∏±‡∏ü"
    ];
    
    const EVENTS_EN = [
      "Nothing","Magical Mirai","School Trip","Idol Stage",
      "Vivid Street","Phoenix Land","Social Viral","Festival",
      "Gift from Mikudayo","NeneRobo Crazy","Movie Released!",
      "SapphireR","Miku VBS Cooking","Mystery Show!?","Honesekai",
      "Shrimp Curse","Love Type Buff","Hope Type Buff","Happy Type Buff"
    ];
    
    const EVENTS_JA = [
      "‰Ωï„ÇÇ„Å™„ÅÑ","„Éû„Ç∏„Ç´„É´„Éü„É©„Ç§","‰øÆÂ≠¶ÊóÖË°å","„Ç¢„Ç§„Éâ„É´„Çπ„ÉÜ„Éº„Ç∏",
      "„Éì„Éì„ÉÉ„Éâ„Çπ„Éà„É™„Éº„Éà","„Éï„Çß„Éã„ÉÉ„ÇØ„Çπ„É©„É≥„Éâ","„ÇΩ„Éº„Ç∑„É£„É´„Ç¶„Ç§„É´„Çπ","„Éï„Çß„Çπ„ÉÜ„Ç£„Éê„É´",
      "„Éü„ÇØ„ÉÄ„É®„Éº„Åã„Çâ„ÅÆ„ÇÆ„Éï„Éà","„Éç„Éç„É≠„ÉúÊö¥Ëµ∞","Êò†ÁîªÂÖ¨ÈñãÔºÅ",
      "„Çµ„Éï„Ç°„Ç§„Ç¢R","„Éü„ÇØVBSÊñôÁêÜ","Ë¨é„ÅÆÁï™ÁµÑÔºÅÔºü","„Çª„Ç´„Ç§„ÅåÈñã„ÅÑ„Åü",
      "„Ç®„Éì„ÅÆÂë™„ÅÑ","„É©„Éñ„Çø„Ç§„Éó„Éê„Éï","„Éõ„Éº„Éó„Çø„Ç§„Éó„Éê„Éï","„Éè„ÉÉ„Éî„Éº„Çø„Ç§„Éó„Éê„Éï"
    ];
    
    const EVENTS_LIST = currentLang === 'en' ? EVENTS_EN : currentLang === 'ja' ? EVENTS_JA : EVENTS_TH;

    function showEventSlotMachine(duration, finalEvent) {
      const overlay = document.getElementById('slotOverlay');
      if (!overlay) return;

      const slotTitle = currentLang === 'en' ? 'üé∞ Spinning Event Slot...' : currentLang === 'ja' ? 'üé∞ „Ç§„Éô„É≥„Éà„Çπ„É≠„ÉÉ„ÉàÂõûËª¢‰∏≠...' : 'üé∞ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∏‡πà‡∏°‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå...';
      const eventList = currentLang === 'en' ? EVENTS_EN : currentLang === 'ja' ? EVENTS_JA : EVENTS_TH;
      
      overlay.innerHTML = `
        <div class="slot-container">
          <h2 style="color: #00ff88; font-size: 2.5rem; margin-bottom: 30px;">${slotTitle}</h2>
          <div class="slot-machine">
            <div class="slot-display" id="eventSlotDisplay">???</div>
          </div>
        </div>
      `;
      overlay.style.display = 'flex';

      // Spin animation - ‡∏´‡∏°‡∏∏‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏™‡∏∏‡πà‡∏°
      const display = document.getElementById('eventSlotDisplay');
      let spinCount = 0;
      const spinInterval = setInterval(() => {
        const randomEvent = eventList[Math.floor(Math.random() * eventList.length)];
        display.textContent = randomEvent;
        display.style.transform = `translateY(${(spinCount % 2) * 10}px)`;
        spinCount++;
      }, 100);

      // ‚úÖ ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á 500ms ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤
      setTimeout(() => {
        clearInterval(spinInterval);
        if (finalEvent) {
          // Translate event name if English is selected
          const displayName = translateEventName(finalEvent.name);
          display.textContent = displayName;
          display.style.transform = 'translateY(0)';
        }
      }, duration - 500);
    }

    function showEventResult(event) {
      const overlay = document.getElementById('slotOverlay');
      if (!overlay) return;

      // Store event for later use
      gameState.currentEvent = event;

      // Translate event name based on currentLang
      const translatedEventName = translateEventName(event.name);
      
      // Translate event description
      const translatedDescription = translateEventDescription(event.description);

      overlay.innerHTML = `
        <div class="slot-result">
          <h1 style="color: #ff6b6b; font-size: 4rem; animation: popIn 0.5s;">üéâ ${translatedEventName}</h1>
          <p style="font-size: 1.8rem; margin-top: 20px; color: #fff;">${translatedDescription}</p>
        </div>
      `;

      // Update info display
      const eventInfo = document.getElementById('tableEvent');
      if (eventInfo) {
        eventInfo.textContent = `üìç ${translatedEventName}`;
      }

      setTimeout(() => {
        overlay.style.display = 'none';
      }, 1000);
    }

    function showCompetitionSlotMachine(duration, finalCompetition) {
      const overlay = document.getElementById('slotOverlay');
      if (!overlay) return;

      const compNames = {
        'vocal': 'üé§ VOCAL',
        'dance': 'üíÉ DANCE',
        'visual': '‚ú® VISUAL'
      };

      const slotTitle = currentLang === 'en' ? 'üé∞ Spinning Competition Type...' : currentLang === 'ja' ? 'üé∞ ÂØæÊà¶„Çø„Ç§„ÉóÂõûËª¢‰∏≠...' : 'üé∞ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô...';

      overlay.innerHTML = `
        <div class="slot-container">
          <h2 style="color: #00d2ff; font-size: 2.5rem; margin-bottom: 30px;">${slotTitle}</h2>
          <div class="slot-machine">
            <div class="slot-display" id="compSlotDisplay">???</div>
          </div>
        </div>
      `;
      overlay.style.display = 'flex';

      // Spin animation - ‡∏´‡∏°‡∏∏‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏™‡∏∏‡πà‡∏°
      const display = document.getElementById('compSlotDisplay');
      const comps = ['üé§ VOCAL','üíÉ DANCE','‚ú® VISUAL'];
      let spinCount = 0;
      const spinInterval = setInterval(() => {
        const randomComp = comps[Math.floor(Math.random() * comps.length)];
        display.textContent = randomComp;
        display.style.transform = `translateY(${(spinCount % 2) * 10}px)`;
        spinCount++;
      }, 100);

      // ‚úÖ ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á 500ms ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤
      setTimeout(() => {
        clearInterval(spinInterval);
        if (finalCompetition) {
          display.textContent = compNames[finalCompetition];
          display.style.transform = 'translateY(0)';
        }
      }, duration - 500);
    }

    function showCompetitionResult(competition) {
      const overlay = document.getElementById('slotOverlay');
      if (!overlay) return;

      // Store competition for later use
      gameState.currentCompetition = competition;

      const compNames = {
        'vocal': currentLang === 'en' ? 'üé§ VOCAL BATTLE' : currentLang === 'ja' ? 'üé§ „Éú„Éº„Ç´„É´„Éê„Éà„É´' : 'üé§ VOCAL BATTLE',
        'dance': currentLang === 'en' ? 'üíÉ RHYTHM CLASH' : currentLang === 'ja' ? 'üíÉ „É™„Ç∫„É†„ÇØ„É©„ÉÉ„Ç∑„É•' : 'üíÉ RHYTHM CLASH',
        'visual': currentLang === 'en' ? '‚ú® STAGE CHARM' : currentLang === 'ja' ? '‚ú® „Çπ„ÉÜ„Éº„Ç∏„ÉÅ„É£„Éº„É†' : '‚ú® STAGE CHARM'
      };
      
      const resultText = currentLang === 'en' ? 'Competition Type Announced!' : currentLang === 'ja' ? 'ÂØæÊà¶„Çø„Ç§„ÉóÁô∫Ë°®ÔºÅ' : '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô!';

      overlay.innerHTML = `
        <div class="slot-result">
          <h1 style="color: #ff00ff; font-size: 4rem; animation: popIn 0.5s;">${compNames[competition]}</h1>
          <p style="font-size: 1.8rem; margin-top: 20px; color: #fff;">${resultText}</p>
        </div>
      `;

      // Update info display
      const competitionInfo = document.getElementById('tableCompetition');
      if (competitionInfo) {
        competitionInfo.textContent = `üèÜ ${compNames[competition]}`;
      }

      setTimeout(() => {
        overlay.style.display = 'none';
      }, 1000);
    }

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏á‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏ô‡πÇ‡∏ï‡πä‡∏∞ (‡πÅ‡∏ó‡∏ô‡∏õ‡πá‡∏≠‡∏õ‡∏≠‡∏±‡∏û)
    function revealAllCards() {
      console.log('[REVEAL] Revealing all cards on table...');
      
      // ‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡πà‡∏≥‡∏≠‡∏¢‡∏π‡πà (data-revealed="false")
      const cardElements = document.querySelectorAll('.card[data-revealed="false"]');
      
      cardElements.forEach(cardEl => {
        const cardId = cardEl.dataset.cardId;
        if (!cardId) return;
        
        // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏≤‡∏Å playedCards
        let cardData = null;
        for (const playerName in gameState.playedCards) {
          const card = gameState.playedCards[playerName];
          if (card.id === cardId) {
            cardData = card;
            break;
          }
        }
        
        if (!cardData) return;
        
        // ‡∏´‡∏á‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å backcard ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏£‡∏¥‡∏á
        const cardImageUrl = `/assets/images/cards/${String(cardData.id).padStart(3, '0')}.png`;
        cardEl.style.backgroundImage = `url('${cardImageUrl}')`;
        cardEl.dataset.revealed = 'true';
        
        const typeEmojis = {
          'happy': 'üòä',
          'love': 'üíñ',
          'hope': '‚ú®'
        };
        
        const skillDesc = SKILL_DESCRIPTIONS[cardData.skill] || cardData.skill;
        cardEl.innerHTML = `
          <div style="position: absolute; top: 3px; left: 3px; right: 3px; font-size: 9px; font-weight: bold; background: rgba(0,0,0,0.8); padding: 2px; border-radius: 3px; text-align: center;">${cardData.character || 'Card'}</div>
          <div style="position: absolute; bottom: 3px; left: 3px; right: 3px; background: rgba(0,0,0,0.85); padding: 4px; border-radius: 4px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2px; text-align: center;">
              <div style="font-size: 10px; color: #ff6b9d;">üé§<br><strong style="font-size: 13px; color: #fff;">${cardData.vocal || 0}</strong></div>
              <div style="font-size: 10px; color: #00d4ff;">üíÉ<br><strong style="font-size: 13px; color: #fff;">${cardData.dance || 0}</strong></div>
              <div style="font-size: 10px; color: #ffd700;">‚ú®<br><strong style="font-size: 13px; color: #fff;">${cardData.visual || 0}</strong></div>
            </div>
          </div>
        `;
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° animation ‡∏´‡∏á‡∏≤‡∏¢
        cardEl.style.animation = 'flipCard 0.6s ease-in-out';
      });
      
      console.log('[REVEAL] Revealed', cardElements.length, 'cards');
    }

    function showRevealedCards(playedCards) {
      const overlay = document.getElementById('slotOverlay');
      if (!overlay) return;

      const actionNames = {
        '1': 'üé≤ ‡∏Å‡∏≤‡∏ä‡∏≤',
        '2': '‚ö° ‡∏™‡∏Å‡∏¥‡∏•',
        '3': '‚öîÔ∏è ‡πÅ‡∏Ç‡πà‡∏á',
        '4': 'üèÉ ‡∏´‡∏ô‡∏µ'
      };

      let html = '<div class="revealed-container"><h2 style="color: #ffd700; font-size: 2.5rem; margin-bottom: 30px;">üé¥ ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô</h2><div class="revealed-grid">';
      
      playedCards.forEach(pc => {
        const card = pc.card;
        html += `
          <div class="revealed-card">
            <div style="font-size: 1.5rem; font-weight: bold; color: #00ff88;">${pc.playerName}</div>
            <div style="font-size: 2rem; margin: 10px 0;">${card.character}</div>
            <div style="font-size: 1rem; color: #aaa; margin: 5px 0;">üé§ ${card.vocal} | üíÉ ${card.dance} | ‚ú® ${card.visual}</div>
            <div style="font-size: 1.2rem; color: #00d2ff; margin-top: 5px;">${actionNames[pc.action]}</div>
          </div>
        `;
      });
      
      html += '</div></div>';
      overlay.innerHTML = html;
      overlay.style.display = 'flex';
    }

    // ==================== GAME FLOW ====================
    function showSkillEffects(skillEffects) {
      console.log('[SPA] üí´ Showing skill effects:', skillEffects);
      console.log('[DEBUG] skillEffects type:', typeof skillEffects);
      console.log('[DEBUG] skillEffects is array:', Array.isArray(skillEffects));
      console.log('[DEBUG] skillEffects length:', skillEffects ? skillEffects.length : 'null/undefined');
      
      if (!skillEffects || skillEffects.length === 0) {
        console.log('[DEBUG] No skill effects - returning early');
        return;
      }
      
      const skillVisuals = {
        // ‡∏î‡∏µ‡∏ö‡∏±‡∏ü
        'mic power cut': { icon: 'üìµ', stat: 'Vocal', color: '#ff6b9d', emoji: 'üé§', type: 'debuff' },
        'freeze spell': { icon: '‚ùÑÔ∏è', stat: 'Dance', color: '#00d4ff', emoji: 'üíÉ', type: 'debuff' },
        'banana slip': { icon: 'üçå', stat: 'Visual', color: '#ffd700', emoji: '‚ú®', type: 'debuff' },
        // ‡∏ö‡∏±‡∏ü
        'golden microphone': { icon: 'üé§', stat: 'Vocal', color: '#ff6b9d', emoji: 'üé§', type: 'buff' },
        'feet of fire': { icon: 'üî•', stat: 'Dance', color: '#00d4ff', emoji: 'üíÉ', type: 'buff' },
        'makeup shop visit': { icon: 'üíÑ', stat: 'Visual', color: '#ffd700', emoji: '‚ú®', type: 'buff' },
        // ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
        'leek shield': { icon: 'üõ°Ô∏è', stat: 'Shield', color: '#00ff88', emoji: 'üõ°Ô∏è', type: 'protect' },
        'never give up': { icon: 'üí™', stat: 'Willpower', color: '#ff00ff', emoji: '‚ô•', type: 'heal' },
        'hidden skill': { icon: 'üö´', stat: 'Block', color: '#888', emoji: 'üö´', type: 'block' },
        'gacha god': { icon: 'üé∞', stat: 'Draw', color: '#ffd700', emoji: 'üé¥', type: 'draw' },
        'divine card': { icon: '‚ú®', stat: 'Divine', color: '#fff', emoji: '‚ú®', type: 'divine' }
      };
      
      console.log('[DEBUG] Starting skill effects display...');
      
      // ‚úÖ ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏™‡∏Å‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
      const overlay = document.getElementById('slotOverlay');
      if (!overlay) return;
      
      let allEffectsHTML = '<div class="slot-container" style="max-height: 90vh; overflow-y: auto;">';
      const skillEffectTitle = currentLang === 'ja' ? 'üí´ „Çπ„Ç≠„É´„Ç®„Éï„Çß„ÇØ„Éà' : currentLang === 'en' ? 'üí´ Skill Effects' : 'üí´ Skill Effects';
      allEffectsHTML += `<h2 style="color: #00ff88; font-size: 2.5rem; margin-bottom: 20px;">${skillEffectTitle}</h2>`;
      
      // ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏Å‡∏¥‡∏•
      const debuffs = [];
      const buffs = [];
      const others = [];
      const blocked = [];
      
      skillEffects.forEach((effect) => {
        console.log(`[DEBUG] Processing effect:`, effect);
        
        if (effect.blocked) {
          blocked.push(effect);
          return;
        }
        
        const skillInfo = skillVisuals[effect.skill];
        if (!skillInfo) return;
        
        if (skillInfo.type === 'debuff') {
          debuffs.push({ effect, skillInfo });
        } else if (skillInfo.type === 'buff') {
          buffs.push({ effect, skillInfo });
        } else {
          others.push({ effect, skillInfo });
        }
      });
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏Å‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å
      if (blocked.length > 0) {
        allEffectsHTML += '<div style="background: rgba(136,136,136,0.2); padding: 15px; margin: 10px 0; border-radius: 10px;">';
        const blockedLabel = currentLang === 'ja' ? 'üö´ „Éñ„É≠„ÉÉ„ÇØÊ∏à„Åø!' : 'üö´ BLOCKED!';
        allEffectsHTML += `<h3 style="color: #888; font-size: 1.8rem; margin-bottom: 10px;">${blockedLabel}</h3>`;
        blocked.forEach(effect => {
          const translatedSkill = translateSkillName(effect.skill);
          allEffectsHTML += `<div style="color: #ff6b6b; margin: 5px 0;">${effect.player}'s ${translatedSkill}</div>`;
        });
        allEffectsHTML += '</div>';
      }
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏î‡∏µ‡∏ö‡∏±‡∏ü
      if (debuffs.length > 0) {
        allEffectsHTML += '<div style="background: rgba(255,107,157,0.2); padding: 15px; margin: 10px 0; border-radius: 10px;">';
        const debuffsLabel = currentLang === 'ja' ? 'üí• „Éá„Éê„Éï' : 'üí• Debuffs';
        allEffectsHTML += `<h3 style="color: #ff00ff; font-size: 1.8rem; margin-bottom: 10px;">${debuffsLabel}</h3>`;
        debuffs.forEach(({ effect, skillInfo }) => {
          const translatedSkill = translateSkillName(effect.skill);
          allEffectsHTML += `
            <div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
              <div style="font-size: 1.3rem; color: #fff; margin-bottom: 5px;">${skillInfo.icon} ${effect.player} ‚Üí ${translatedSkill}</div>
              <div style="color: ${skillInfo.color}; font-size: 1.1rem;">
                ${effect.effects.filter(e => e.includes('debuff')).map(e => `‚ñº ${e.replace('debuff to', '')}`).join('<br>')}
              </div>
            </div>
          `;
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏≤‡∏£‡πå‡∏ï‡∏¥‡πÄ‡∏Ñ‡∏¥‡∏•
          createDebuffParticles(skillInfo.icon, skillInfo.color);
        });
        allEffectsHTML += '</div>';
      }
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏±‡∏ü
      if (buffs.length > 0) {
        allEffectsHTML += '<div style="background: rgba(0,255,136,0.2); padding: 15px; margin: 10px 0; border-radius: 10px;">';
        const buffsLabel = currentLang === 'ja' ? '‚ú® „Éê„Éï' : '‚ú® Buffs';
        allEffectsHTML += `<h3 style="color: #00ff88; font-size: 1.8rem; margin-bottom: 10px;">${buffsLabel}</h3>`;
        buffs.forEach(({ effect, skillInfo }) => {
          const translatedSkill = translateSkillName(effect.skill);
          allEffectsHTML += `
            <div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
              <div style="font-size: 1.3rem; color: #fff; margin-bottom: 5px;">${skillInfo.icon} ${effect.player} ‚Üí ${translatedSkill}</div>
              <div style="color: ${skillInfo.color}; font-size: 1.1rem;">
                ${effect.effects.map(e => `‚ñ≤ ${e}`).join('<br>')}
              </div>
            </div>
          `;
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏≤‡∏£‡πå‡∏ï‡∏¥‡πÄ‡∏Ñ‡∏¥‡∏•
          createBuffParticles(skillInfo.icon, skillInfo.color);
        });
        allEffectsHTML += '</div>';
      }
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏Å‡∏¥‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©
      if (others.length > 0) {
        allEffectsHTML += '<div style="background: rgba(0,210,255,0.2); padding: 15px; margin: 10px 0; border-radius: 10px;">';
        const specialLabel = currentLang === 'ja' ? '‚ö° ÁâπÂà•„Å™„Çπ„Ç≠„É´' : '‚ö° Special Skills';
        allEffectsHTML += `<h3 style="color: #00d2ff; font-size: 1.8rem; margin-bottom: 10px;">${specialLabel}</h3>`;
        others.forEach(({ effect, skillInfo }) => {
          const translatedSkill = translateSkillName(effect.skill);
          allEffectsHTML += `
            <div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
              <div style="font-size: 1.3rem; color: #fff; margin-bottom: 5px;">${skillInfo.icon} ${effect.player} ‚Üí ${translatedSkill}</div>
              <div style="color: ${skillInfo.color}; font-size: 1.1rem;">
                ${effect.effects.map(e => `‚ú® ${e}`).join('<br>')}
              </div>
            </div>
          `;
        });
        allEffectsHTML += '</div>';
      }
      
      allEffectsHTML += '</div>';
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
      if (debuffs.length > 0 || buffs.length > 0 || others.length > 0 || blocked.length > 0) {
        overlay.innerHTML = allEffectsHTML + `
          <style>
            @keyframes pulse {
              from { transform: scale(1); }
              to { transform: scale(1.1); }
            }
          </style>
        `;
        overlay.style.display = 'flex';
        
        // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setTimeout(() => {
          overlay.style.display = 'none';
        }, 3000);
      }
    }
    
    function createDebuffParticles(icon, color) {
      const table = document.getElementById('table');
      if (!table) return;
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏≤‡∏£‡πå‡∏ï‡∏¥‡πÄ‡∏Ñ‡∏¥‡∏• 8 ‡∏ï‡∏±‡∏ß
      for (let i = 0; i < 8; i++) {
        const particle = document.createElement('div');
        particle.textContent = icon;
        particle.style.position = 'absolute';
        particle.style.fontSize = '3rem';
        particle.style.left = `${Math.random() * 80 + 10}%`;
        particle.style.top = '50%';
        particle.style.transform = 'translateY(-50%)';
        particle.style.opacity = '1';
        particle.style.pointerEvents = 'none';
        particle.style.zIndex = '100';
        particle.style.textShadow = `0 0 10px ${color}`;
        particle.style.animation = `floatUp${i} 2s ease-out forwards`;
        
        table.appendChild(particle);
        
        // ‡∏•‡∏ö‡∏´‡∏•‡∏±‡∏á animation ‡∏à‡∏ö
        setTimeout(() => {
          particle.remove();
        }, 2000);
      }
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° keyframes ‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°
      const style = document.createElement('style');
      let keyframes = '';
      for (let i = 0; i < 8; i++) {
        const randomX = (Math.random() - 0.5) * 200;
        keyframes += `
          @keyframes floatUp${i} {
            0% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-150px) translateX(${randomX}px) rotate(${Math.random() * 360}deg); opacity: 0; }
          }
        `;
      }
      style.textContent = keyframes;
      document.head.appendChild(style);
      setTimeout(() => style.remove(), 2100);
    }
    
    function createBuffParticles(icon, color) {
      const table = document.getElementById('table');
      if (!table) return;
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏≤‡∏£‡πå‡∏ï‡∏¥‡πÄ‡∏Ñ‡∏¥‡∏•‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏ü (‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á)
      for (let i = 0; i < 10; i++) {
        const particle = document.createElement('div');
        particle.textContent = icon;
        particle.style.position = 'absolute';
        particle.style.fontSize = '2.5rem';
        particle.style.left = `${Math.random() * 80 + 10}%`;
        particle.style.top = '50%';
        particle.style.transform = 'translateY(-50%)';
        particle.style.opacity = '1';
        particle.style.pointerEvents = 'none';
        particle.style.zIndex = '100';
        particle.style.textShadow = `0 0 20px ${color}, 0 0 40px ${color}`;
        particle.style.animation = `floatUpBuff${i} 1.5s ease-out forwards`;
        
        table.appendChild(particle);
        
        setTimeout(() => {
          particle.remove();
        }, 1500);
      }
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° keyframes ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ü (‡∏•‡∏≠‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢)
      const style = document.createElement('style');
      let keyframes = '';
      for (let i = 0; i < 10; i++) {
        const randomX = (Math.random() - 0.5) * 150;
        const randomRotate = Math.random() * 720 - 360;
        keyframes += `
          @keyframes floatUpBuff${i} {
            0% { 
              transform: translateY(0) translateX(0) rotate(0deg) scale(1); 
              opacity: 1; 
            }
            50% {
              transform: translateY(-80px) translateX(${randomX * 0.5}px) rotate(${randomRotate * 0.5}deg) scale(1.5);
              opacity: 1;
            }
            100% { 
              transform: translateY(-120px) translateX(${randomX}px) rotate(${randomRotate}deg) scale(2); 
              opacity: 0; 
            }
          }
        `;
      }
      style.textContent = keyframes;
      document.head.appendChild(style);
      setTimeout(() => style.remove(), 1600);
    }
    
    function startEventRevealPhase() {
      document.getElementById('playCardPhase').classList.remove('show');
      let time = PHASE_TIMERS.eventReveal;
      document.getElementById('timer').textContent = time;
      clearInterval(_countdownInterval);

      _countdownInterval = setInterval(() => {
        time--;
        document.getElementById('timer').textContent = time;
        if (time <= 0) {
          clearInterval(_countdownInterval);
          startPlayCardPhase();
        }
      }, 1000);
    }

    function startPlayCardPhase() {
      // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏û‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (heart = 0 ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏°‡∏î)
      const me = gameState.players.find(p => p.name === gameState.playerName);
      if (me && (me.heart <= 0 || me.handCount <= 0)) {
        console.log('[SPA] üíÄ Player eliminated - skipping play card phase');
        // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î - ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        return;
      }
      
      document.getElementById('playCardPhase').classList.add('show');
      
      // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ô phase container
      renderCardsInPhase(gameState.hand);
      
      let time = PHASE_TIMERS.playCard;
      document.getElementById('timer').textContent = time;
      clearInterval(_countdownInterval);

      _countdownInterval = setInterval(() => {
        time--;
        document.getElementById('timer').textContent = time;
        if (time <= 0) {
          clearInterval(_countdownInterval);
          if (!gameState.myCard) {
            // Auto-pick random card from hand
            if (gameState.hand && gameState.hand.length > 0) {
              const randomIdx = Math.floor(Math.random() * gameState.hand.length);
              gameState.myCard = gameState.hand[randomIdx];
            }
          }
          socket.emit('playCard', { roomCode: gameState.roomCode, card: gameState.myCard, skipTurn: false });
          document.getElementById('playCardPhase').classList.remove('show');
        }
      }, 1000);
    }

    function startActionPhase() {
      // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏û‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (heart = 0 ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏°‡∏î)
      const me = gameState.players.find(p => p.name === gameState.playerName);
      if (me && (me.heart <= 0 || me.handCount <= 0)) {
        console.log('[SPA] üíÄ Player eliminated - skipping action phase');
        // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å action - ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        return;
      }
      
      document.getElementById('playCardPhase').classList.remove('show');
      document.getElementById('actionPhase').classList.add('show');
      if (actionPhaseElement) {
        actionPhaseElement.classList.remove('collapsed');
      }
      actionModalCollapsed = false;
      if (actionReopenBtn) {
        actionReopenBtn.style.display = 'none';
        actionReopenBtn.setAttribute('aria-expanded', 'true');
      }
      
      const skillTextSpan = document.querySelector('#actionBtn2 .action-text');
      if (skillTextSpan) {
        skillTextSpan.textContent = currentLang === 'en' ? 'Skill' : currentLang === 'ja' ? '„Çπ„Ç≠„É´' : '‡πÉ‡∏ä‡πâ‡∏™‡∏Å‡∏¥‡∏•';
      }
      
      // Update Action 2 button status based on cooldown
      updateActionCooldownDisplay();
      
      let time = PHASE_TIMERS.action;
      document.getElementById('timer').textContent = time;
      const actionTimerValue = document.getElementById('actionTimerValue');
      if (actionTimerValue) actionTimerValue.textContent = time;
      clearInterval(_countdownInterval);

      _countdownInterval = setInterval(() => {
        time--;
        document.getElementById('timer').textContent = time;
        if (actionTimerValue) actionTimerValue.textContent = time;
        if (time <= 0) {
          clearInterval(_countdownInterval);
          if (!gameState.myAction) {
            gameState.myAction = "3";
          }
          socket.emit('chooseAction', { roomCode: gameState.roomCode, action: gameState.myAction });
          hideActionPhaseOverlay();
        }
      }, 1000);
    }

    function updateActionCooldownDisplay() {
      const btn2 = document.getElementById('actionBtn2');
      const cdBadge = document.getElementById('actionCdBadge');
      
      if (gameState.actionCooldown > 0) {
        btn2.disabled = true;
        btn2.style.opacity = '0.5';
        btn2.style.cursor = 'not-allowed';
        cdBadge.textContent = ` (CD: ${gameState.actionCooldown})`;
      } else {
        btn2.disabled = false;
        btn2.style.opacity = '1';
        btn2.style.cursor = 'pointer';
        cdBadge.textContent = '';
      }
    }

    function startResultsPhase(gameOver) {
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏•‡∏≠‡∏î ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏ô
      if (gameOver) {
        return;
      }
      
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô overlay ‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      let time = PHASE_TIMERS.results;
      document.getElementById('timer').textContent = time;
      clearInterval(_countdownInterval);

      _countdownInterval = setInterval(() => {
        time--;
        document.getElementById('timer').textContent = time;
        if (time <= 0) {
          clearInterval(_countdownInterval);
          document.getElementById('resultOverlay').classList.remove('show');
        }
      }, 1000);
    }

    document.getElementById('confirmCard').addEventListener('click', () => {
      if (!gameState.myCard) {
        showError(currentLang === 'en' ? 'Select a card first!' : currentLang === 'ja' ? '„Åæ„Åö„Ç´„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ' : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Å‡πà‡∏≠‡∏ô!');
        return;
      }
      
      playSound('cardPlay');
      
      clearInterval(_countdownInterval);
      socket.emit('playCard', { roomCode: gameState.roomCode, card: gameState.myCard, skipTurn: false });
      document.getElementById('playCardPhase').classList.remove('show');
      document.getElementById('confirmCard').classList.remove('show');
      
      // ‡πÄ‡∏≠‡∏≤ border ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      document.querySelectorAll('#hand .card').forEach(c => {
        c.style.border = 'none';
        c.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.5)';
      });
      
      // ‡∏ã‡πà‡∏≠‡∏ô card detail
      document.getElementById('cardDetailPreview').style.display = 'none';
    });

    document.querySelectorAll('.action-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏° 2 (Action 2) ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î CD -> ‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏î
        if (btn.dataset.action === "2" && gameState.actionCooldown > 0) {
          showError(currentLang === 'en' ? `Skill is on cooldown for ${gameState.actionCooldown} more turns!` : currentLang === 'ja' ? `„Çπ„Ç≠„É´„ÅØ${gameState.actionCooldown}„Çø„Éº„É≥Èñì„ÇØ„Éº„É´„ÉÄ„Ç¶„É≥‰∏≠„Åß„ÅôÔºÅ` : `‡∏õ‡∏∏‡πà‡∏° Action 2 ‡∏¢‡∏±‡∏á‡∏ï‡∏¥‡∏î CD ${gameState.actionCooldown} ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô!`);
          return;
        }
        
        gameState.myAction = btn.dataset.action;
        clearInterval(_countdownInterval);
        socket.emit('chooseAction', { roomCode: gameState.roomCode, action: gameState.myAction });
        hideActionPhaseOverlay();
      });
    });
  </script>

  <!-- Slot Machine Overlay -->
  <div id="slotOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; justify-content: center; align-items: center;">
  </div>
</body>
</html>