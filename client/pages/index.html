<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SPRgame - Sekai Card Battle</title>
  <script>
    (function setupHomeRedesignFlag() {
      try {
        const stored = localStorage.getItem('psk-enable-home-redesign');
        if (stored === null) {
          localStorage.setItem('psk-enable-home-redesign', 'true');
          window.__PSK_UI_EXPERIMENT = true;
        } else {
          window.__PSK_UI_EXPERIMENT = stored === 'true';
        }
      } catch (err) {
        console.warn('[home-redesign] Unable to access localStorage, defaulting flag to true', err);
        window.__PSK_UI_EXPERIMENT = true;
      }
    })();
  </script>
  <style>
    body { margin:0; height:100vh; background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; font-family:'Kanit',sans-serif; display:flex; flex-direction:column; justify-content:center; align-items:center; position:relative; }
    #langBtn { position:absolute; top:30px; right:30px; padding:12px 24px; font-size:1.2rem; background:#2c3e50; border:none; border-radius:10px; cursor:pointer; color:#fff; transition:0.3s; }
    #langBtn:hover { background:#34495e; transform:scale(1.05); }
    h1 { font-size:6rem; margin:0; text-shadow:0 0 30px rgba(0,0,0,0.5); }
    h2 { font-size:2.5rem; margin:30px 0; }
    button { padding:20px 60px; margin:20px; font-size:2.2rem; background:#ff6b6b; border:none; border-radius:20px; cursor:pointer; box-shadow:0 10px 30px rgba(0,0,0,0.4); transition:0.3s; }
    button:hover { background:#ff5252; transform:translateY(-8px); }
    .code-box { margin:40px; padding:40px 80px; background:#e74c3c; border-radius:30px; font-size:5rem; letter-spacing:20px; font-weight:bold; display:flex; flex-direction:column; align-items:center; max-width:90vw; }
    .code-box.hidden { display:none; }
    .copy-feedback { display:none; color:#2ecc71; font-size:1.5rem; font-weight:bold; margin-top:20px; }
    .copy-feedback.show { display:block; animation: fadeInOut 2s ease-in-out; }
    @keyframes fadeInOut { 0%, 10% { opacity:1; } 90%, 100% { opacity:0; } }
    .psk-home-stage { width:100%; display:flex; flex-direction:column; align-items:center; }
    .psk-home-cta-group { display:flex; flex-wrap:wrap; justify-content:center; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@700;900&display=swap" rel="stylesheet">
  <script>
    (function enableHomeRedesign() {
      const isEnabled = (function () {
        if (typeof window.__PSK_UI_EXPERIMENT !== 'undefined') return window.__PSK_UI_EXPERIMENT;
        try {
          const stored = localStorage.getItem('psk-enable-home-redesign');
          return stored === null ? true : stored === 'true';
        } catch (err) {
          console.warn('[home-redesign] Flag read error, defaulting to true', err);
          return true;
        }
      })();

      if (!isEnabled) return;

      const activate = () => {
        document.body.classList.add('psk-home-experiment');
        if (document.getElementById('psk-home-redesign-styles')) return;
        const link = document.createElement('link');
        link.id = 'psk-home-redesign-styles';
        link.rel = 'stylesheet';
        link.href = '/assets/home-redesign.css';
        document.head.appendChild(link);
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', activate, { once: true });
      } else {
        activate();
      }
    })();
  </script>
</head>
<body>
  <div class="psk-home-stage">
    <button id="langBtn" onclick="toggleLanguage()">English</button>

    <h1>SPRgame</h1>
    <h2 id="subtitle">Project Sekai BoardCard Game (Fanmade)</h2>
    <div class="psk-home-cta-group">
      <button id="createBtn" onclick="createRoom()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
      <button id="joinBtn" onclick="joinRoom()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á</button>
    </div>

    <div class="code-box hidden" id="codeBox">
      <div id="roomCodeText">ABC123</div>
      <div style="font-size:1.8rem; margin-top:30px;">‡∏™‡πà‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á</div>
      <div style="margin-top:30px; display:flex; gap:20px; justify-content:center; flex-wrap:wrap;">
        <button style="background:#27ae60; padding:15px 40px; font-size:1.8rem; margin:0;" onclick="goToLobby()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏¢!</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentRoomCode = null;
    let playerId = null;  // ‚Üê Store persistent player ID
    let playerName = null;
    let currentLang = localStorage.getItem('lang') || 'th';
    let texts = {};

    // Initialize: Hide code box on page load
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('codeBox').classList.add('hidden');
    });

    // Load translations
    async function loadLanguage(lang) {
      try {
        const response = await fetch(`/locales/${lang}.json`);
        texts = await response.json();
        currentLang = lang;
        localStorage.setItem('lang', lang);
        updateUI();
      } catch (e) {
        console.error('Failed to load language:', e);
      }
    }

    // Update UI with current language
    function updateUI() {
      document.getElementById('subtitle').textContent = texts.subtitle || 'Project Sekai BoardCard Game (Fanmade)';
      document.getElementById('createBtn').textContent = texts.createRoom || 'Create Room';
      document.getElementById('joinBtn').textContent = texts.joinRoom || 'Join Room';
      document.getElementById('langBtn').textContent = currentLang === 'th' ? 'English' : '‡πÑ‡∏ó‡∏¢';
    }

    // Toggle language
    async function toggleLanguage() {
      const newLang = currentLang === 'th' ? 'en' : 'th';
      await loadLanguage(newLang);
    }

    function createRoom() {
      const promptText = texts.enterName || 'Enter your name?';
      const defaultName = texts.defaultName1 || 'Miku-chan';
      playerName = prompt(promptText, defaultName)?.trim() || defaultName;
      
      // ‚úÖ Validate name length (client-side)
      if (playerName.length === 0) {
        alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢!');
        return;
      }
      if (playerName.length > 10) {
        alert('‚ö†Ô∏è ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£!');
        return;
      }
      
      console.log('üîµ [CLIENT] Emitting createRoom with name:', playerName);
      socket.emit('createRoom', { name: playerName });
    }

    function joinRoom() {
      const promptCode = texts.enterCode || 'Enter code';
      const code = prompt(promptCode, '')?.trim().toUpperCase();
      if (!code || code.length !== 6) {
        alert(texts.codeInvalid || 'Please enter 6 digits');
        return;
      }
      const promptText = texts.enterName || 'Enter your name?';
      const defaultName = texts.defaultName2 || 'Kohane-chan';
      playerName = prompt(promptText, defaultName)?.trim() || defaultName;
      
      // ‚úÖ Validate name length (client-side)
      if (playerName.length === 0) {
        alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢!');
        return;
      }
      if (playerName.length > 10) {
        alert('‚ö†Ô∏è ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£!');
        return;
      }
      
      socket.emit('joinRoom', { code, name: playerName, playerId });  // ‚Üê Send playerId
    }

    function goToLobby() {
      if (currentRoomCode && playerName) {
        location.href = `pages/lobby.html?room=${currentRoomCode}&name=${encodeURIComponent(playerName)}&playerId=${playerId}&lang=${currentLang}`;
      }
    }

    // Initialize on load
    loadLanguage(currentLang);

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    socket.on('roomCreated', ({ code, playerId: newPlayerId, name }) => {
      console.log('üü¢ [CLIENT] ‚úÖ roomCreated event received, code:', code, 'playerId:', newPlayerId);
      currentRoomCode = code;
      playerId = newPlayerId;  // ‚Üê Save playerId
      playerName = name;
      
      document.getElementById('roomCodeText').textContent = code;
      const codeBox = document.getElementById('codeBox');
      codeBox.classList.remove('hidden');
      console.log('üü¢ [CLIENT] codeBox shown');
    });

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    socket.on('joined', ({ code, playerId: newPlayerId }) => {
      currentRoomCode = code;
      if (newPlayerId) playerId = newPlayerId;  // ‚Üê Update playerId if received
      location.href = `pages/lobby.html?room=${code}&name=${encodeURIComponent(playerName)}&playerId=${playerId}&lang=${currentLang}`;
    });

    socket.on('error', msg => {
      alert('‚ö†Ô∏è ' + msg);
    });
  </script>

</body>
</html>
