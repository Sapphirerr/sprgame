<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SPRGame - Sekai Card Battle</title>
  <script>
    (function setupHomeRedesignFlag() {
      try {
        const stored = localStorage.getItem('psk-enable-home-redesign');
        if (stored === null) {
          localStorage.setItem('psk-enable-home-redesign', 'true');
          window.__PSK_UI_EXPERIMENT = true;
        } else {
          window.__PSK_UI_EXPERIMENT = stored === 'true';
        }
      } catch (err) {
        console.warn('[home-redesign] Unable to access localStorage, defaulting flag to true', err);
        window.__PSK_UI_EXPERIMENT = true;
      }
    })();
  </script>
  <script>
    (function enableHomeRedesign() {
      const isEnabled = (() => {
        if (typeof window.__PSK_UI_EXPERIMENT !== 'undefined') return window.__PSK_UI_EXPERIMENT;
        try {
          const stored = localStorage.getItem('psk-enable-home-redesign');
          return stored === null ? true : stored === 'true';
        } catch (err) {
          console.warn('[home-redesign] Flag read error, defaulting to true', err);
          return true;
        }
      })();

      if (!isEnabled) return;

      const activate = () => {
        document.body.classList.add('psk-home-experiment');
        if (document.getElementById('psk-home-redesign-styles')) return;
        const link = document.createElement('link');
        link.id = 'psk-home-redesign-styles';
        link.rel = 'stylesheet';
        link.href = '/assets/home-redesign.css';
        document.head.appendChild(link);
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', activate, { once: true });
      } else {
        activate();
      }
    })();
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;800&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #fff;
      font-family: 'Kanit', sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    /* ==================== LOBBY PHASE ==================== */
    #lobbyContainer {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      gap: 20px;
    }

    #lobbyContainer.hidden {
      display: none;
    }

    .lobby-box {
      background: rgba(0, 0, 0, 0.7);
      padding: 50px;
      border-radius: 20px;
      text-align: center;
      max-width: 600px;
      width: 90%;
      border: 3px solid #00d2ff;
      max-height: 90vh;
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .lobby-box::-webkit-scrollbar {
      display: none;
    }

    .lobby-box h1 {
      font-size: 3rem;
      color: #00ffff;
      margin-bottom: 30px;
      text-shadow: 0 0 20px #00ffff;
    }

    .room-code-display {
      font-size: 3.5rem;
      letter-spacing: 15px;
      background: #e74c3c;
      padding: 20px;
      border-radius: 20px;
      margin: 30px 0;
      font-weight: bold;
      display: none;
    }

    .room-code-display.show {
      display: block;
    }

    .lobby-input-group {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    .lobby-input-group input {
      padding: 15px;
      font-size: 1.2rem;
      border-radius: 12px;
      border: none;
      text-align: center;
    }

    .lobby-input-group input[type="text"] {
      text-transform: uppercase;
      letter-spacing: 5px;
    }

    .lobby-button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 15px 40px;
      font-size: 1.3rem;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-family: 'Kanit', sans-serif;
      transition: all 0.3s;
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(39, 174, 96, 0.5);
    }

    .btn-create {
      background: linear-gradient(135deg, #667eea, #764ba2);
    }

    .btn-create:hover {
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
    }

    .btn-join {
      background: linear-gradient(135deg, #11998e, #38ef7d);
    }

    .btn-join:hover {
      box-shadow: 0 10px 30px rgba(17, 153, 142, 0.5);
    }

    .players-list {
      background: rgba(0, 200, 255, 0.1);
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .player-item {
      background: rgba(0, 0, 0, 0.3);
      padding: 12px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .player-status {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .player-ready {
      color: #2ecc71;
      font-weight: bold;
    }

    .bot-controls {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 14px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      animation: fadeIn 0.3s ease;
    }

    .bot-controls.hidden {
      display: none;
    }

    .bot-controls-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    #botStatus {
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.85);
      font-weight: 600;
    }

    #botHint {
      font-size: 0.95rem;
      margin: 0;
      color: rgba(255, 255, 255, 0.65);
    }

    #addBotBtn {
      padding: 8px 18px;
      font-size: 1rem;
      border-radius: 999px;
      border: 1px solid rgba(56, 249, 255, 0.45);
      background: rgba(56, 249, 255, 0.2);
      color: #fff;
      cursor: pointer;
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    #addBotBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(56, 249, 255, 0.25);
    }

    #addBotBtn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
    }

    .bot-badge {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 0.85rem;
      margin-left: 8px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .remove-bot {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.35);
      border-radius: 50%;
      width: 34px;
      height: 34px;
      color: #fff;
      cursor: pointer;
      margin-left: 10px;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      flex-shrink: 0;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .remove-bot:hover {
      background: rgba(255, 79, 216, 0.3);
      transform: scale(1.05);
    }

    .kick-player {
      background: transparent;
      border: 1px solid rgba(255, 107, 107, 0.45);
      border-radius: 50%;
      width: 34px;
      height: 34px;
      color: #fff;
      cursor: pointer;
      margin-left: 10px;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      flex-shrink: 0;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .kick-player:hover {
      background: rgba(255, 107, 107, 0.25);
      transform: scale(1.05);
    }

    .btn-ready {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      margin-top: 20px;
    }

    .btn-ready.ready {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
    }

    .btn-start {
      background: linear-gradient(135deg, #c0392b, #e74c3c);
      margin-top: 20px;
      display: none;
    }

    .btn-start.show {
      display: inline-block;
    }

    /* ==================== GAME PHASE ==================== */
    #gameContainer {
      width: 100vw;
      height: 100vh;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    #gameContainer.hidden {
      display: none;
    }

    #header {
      background: rgba(0, 0, 0, 0.5);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 3px solid #00d2ff;
      height: 80px;
      flex-shrink: 0;
    }

    .turn-info {
      font-size: 1.8rem;
      font-weight: 800;
      color: #00ff88;
    }

    .timer {
      font-size: 2rem;
      color: #ff6b6b;
      font-weight: 800;
    }

    #audioControlPanel {
      position: fixed;
      bottom: 26px;
      right: 26px;
      display: flex;
      gap: 10px;
      z-index: 130;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .audio-toggle-btn {
      border: none;
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 0.7rem;
      font-weight: 700;
      color: #0a1228;
      background: linear-gradient(135deg, #38f9ff, #7effb2);
      box-shadow: 0 6px 16px rgba(8, 18, 40, 0.35);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      min-width: 70px;
      justify-content: center;
    }

    .audio-toggle-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(56, 249, 255, 0.35);
    }

    .audio-toggle-btn.muted {
      background: linear-gradient(135deg, rgba(128, 128, 128, 0.45), rgba(90, 90, 90, 0.7));
      color: rgba(255, 255, 255, 0.8);
      box-shadow: none;
      opacity: 0.85;
    }

    #globalMenuContainer {
      position: fixed;
      top: 110px;
      left: 20px;
      z-index: 200;
    }

    @media (max-width: 640px) {
      #globalMenuContainer {
        top: 200px !important;
      }
    }

    #globalMenuContainer.lobby-mode {
      top: 20px;
      z-index: 140;
    }

    @media (max-width: 640px) {
      #globalMenuContainer.lobby-mode {
        top: 20px !important;
      }
    }

    .global-menu-btn {
      border: none;
      border-radius: 12px;
      width: 38px;
      height: 38px;
      font-size: 1.1rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      background: rgba(255, 255, 255, 0.12);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.25s ease;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      pointer-events: auto;
      z-index: 201;
    }

    .global-menu-btn:hover {
      background: rgba(255, 255, 255, 0.18);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      transform: translateY(-2px);
    }

    .global-menu-btn.menu-open {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Popup Menu Styles */
    .global-menu-popup {
      position: absolute;
      top: 60px;
      left: 0;
      background: rgba(0, 0, 0, 0.9);
      border: none;
      border-radius: 12px;
      padding: 10px;
      display: none;
      flex-direction: column;
      gap: 10px;
      z-index: 210;
      min-width: 160px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
      animation: popupSlideDown 0.25s ease-out;
    }

    .global-menu-popup.show {
      display: flex;
    }

    @keyframes popupSlideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .popup-menu-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      background: linear-gradient(135deg, #3498db, #2980b9);
      border: 1.5px solid #00d2ff;
      border-radius: 6px;
      color: #00d2ff;
      font-size: 0.7rem;
      font-weight: 700;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Kanit', sans-serif;
      white-space: nowrap;
    }

    .popup-menu-item:nth-child(2) {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      border-color: #ff6b6b;
      color: #ff6b6b;
    }

    .popup-menu-item:nth-child(3) {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
      border-color: #bb86fc;
      color: #bb86fc;
    }

    .popup-menu-item:hover {
      box-shadow: 0 0 20px rgba(0, 210, 255, 0.5);
      transform: translateY(-2px);
    }

    .popup-menu-item:nth-child(2):hover {
      box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
    }

    .popup-menu-item:nth-child(3):hover {
      box-shadow: 0 0 20px rgba(187, 134, 252, 0.5);
    }

    .popup-menu-divider {
      height: 1px;
      background: rgba(255, 255, 255, 0.2);
      margin: 8px 0;
      border: none;
    }

    #bgmGameToggleBtn:hover,
    #sfxGameToggleBtn:hover {
      box-shadow: 0 0 20px rgba(102, 255, 150, 0.5);
    }

    /* Side Menu Panel */
    .side-menu-panel {
      position: fixed;
      left: 0;
      top: 0;
      width: 320px;
      height: 100vh;
      background: rgba(15, 25, 55, 0.98);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 150;
      transform: translateX(-100%);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      padding-top: 20px;
      overflow-y: auto;
    }

    .side-menu-panel.show {
      transform: translateX(0);
    }

    .side-menu-header {
      display: flex;
      justify-content: flex-end;
      padding: 10px 20px;
      margin-bottom: 20px;
    }

    .side-menu-close {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      width: 36px;
      height: 36px;
      font-size: 1.2rem;
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .side-menu-close:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.25);
      color: rgba(255, 255, 255, 1);
    }

    .side-menu-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 0 16px;
      flex: 1;
    }

    .side-menu-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(56, 249, 255, 0.12), rgba(100, 200, 255, 0.08));
      border: 1px solid rgba(56, 249, 255, 0.2);
      border-radius: 12px;
      color: rgba(255, 255, 255, 0.95);
      font-size: 1.05rem;
      font-weight: 500;
      text-align: left;
      cursor: pointer;
      transition: all 0.25s ease;
      position: relative;
      overflow: hidden;
    }

    .side-menu-item::before {
      content: '';
      position: absolute;
      left: -100%;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(56, 249, 255, 0.1);
      transition: left 0.3s ease;
    }

    .side-menu-item:hover {
      background: linear-gradient(135deg, rgba(56, 249, 255, 0.2), rgba(100, 200, 255, 0.15));
      border-color: rgba(56, 249, 255, 0.4);
      transform: translateX(8px);
      color: rgba(255, 255, 255, 1);
    }

    .side-menu-item:hover::before {
      left: 0;
    }

    .menu-icon {
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      min-width: 32px;
    }

    .menu-text {
      display: block;
      letter-spacing: 0.5px;
    }

    /* Menu Overlay */
    .menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0);
      backdrop-filter: blur(0px);
      -webkit-backdrop-filter: blur(0px);
      z-index: 145;
      display: none;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .menu-overlay.show {
      display: block;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    .global-menu-item span {
      font-size: 1rem;
      min-width: 18px;
    }

    .menu-info-panel {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
      animation: fadeInPanel 0.25s ease-out;
    }

    @keyframes fadeInPanel {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .menu-info-panel.show {
      display: flex;
    }

    .menu-info-card {
      width: min(450px, 85vw);
      background: rgba(15, 25, 55, 0.95);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 32px;
      color: rgba(255, 255, 255, 0.95);
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
      animation: slideUpCard 0.3s ease-out;
      position: relative;
    }

    @keyframes slideUpCard {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .menu-info-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
    }

    .menu-info-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: rgba(255, 255, 255, 1);
      letter-spacing: 0.5px;
    }

    .menu-info-close {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      width: 32px;
      height: 32px;
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .menu-info-close:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.25);
      color: rgba(255, 255, 255, 1);
    }

    .menu-info-body {
      font-size: 0.95rem;
      line-height: 1.7;
      color: rgba(255, 255, 255, 0.8);
      position: relative;
      z-index: 1;
    }

    @media (max-width: 640px) {
      #globalMenuContainer {
        top: 10px;
        left: 10px;
      }

      .global-menu-btn {
        padding: 4px 9px;
      }

      .global-menu-dropdown {
        min-width: 130px;
      }
    }

    @media (max-width: 640px) {
      #audioControlPanel {
        display: none !important;
      }

      .audio-toggle-btn {
        display: none !important;
      }
    }

    #eventCompetitionDisplay {
      position: absolute;
      top: 100px;
      right: 30px;
      background: rgba(0, 0, 0, 0.9);
      padding: 20px 25px;
      border-radius: 15px;
      border: 3px solid #ffd700;
      max-width: 400px;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
      display: none;
      z-index: 102;
    }

    #eventCompetitionDisplay.show {
      display: block;
    }

    .event-display-item {
      font-size: 1.3rem;
      font-weight: 700;
      margin: 8px 0;
      color: #ffd700;
    }

    .event-label {
      color: #00d2ff;
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .competition-label {
      color: #00ff88;
      font-size: 0.9rem;
      opacity: 0.8;
    }

    /* ==================== TABLE LAYOUT ==================== */
    .game-table {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 5px;
      position: relative;
      overflow: hidden;
    }

    .table-wrapper {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-start;
      gap: 10px;
      width: 100%;
      max-width: 1000px;
      height: auto;
      padding: 10px;
    }

    .player-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
      padding: 10px;
      min-width: 150px;
      max-width: 200px;
      border-radius: 10px;
    }

    .player-area.p1 {
      order: 10;
      border: 3px solid #ffd700;
      background: rgba(255, 215, 0, 0.1);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
      border-radius: 15px;
    }

    .player-area.p2 {
      border: 2px solid rgba(0, 255, 136, 0.5);
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
    }

    .player-area.p3 {
      border: 2px solid rgba(0, 255, 136, 0.5);
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
    }

    .player-area.p4 {
      border: 2px solid rgba(0, 255, 136, 0.5);
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
    }

    .player-area.p5 {
      border: 2px solid rgba(0, 255, 136, 0.5);
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
    }

    .table-center {
      width: 100%;
      order: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.6);
      border: 3px solid #ffd700;
      border-radius: 20px;
      padding: 20px;
      margin: 10px 0;
      box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
    }

    .player-name-tag {
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      color: #00ff88;
      border: 2px solid #00ff88;
      font-size: 0.95rem;
    }

    .player-hearts-display {
      font-size: 1.2rem;
      color: #ff6b6b;
      font-weight: 700;
    }

    .player-played-cards {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
      min-height: 130px;
      align-content: center;
    }

    /* ✅ การ์ดบนโต๊ะ - ไม่มี margin-left */
    .player-area .card {
      margin-left: 0 !important;
      position: relative !important;
      transform: none !important;
      margin-top: 0 !important;
      margin-right: 0 !important;
      flex-shrink: 0;
    }

    .player-area .card:hover {
      transform: scale(1.05) !important;
      z-index: 10;
    }

    .player-area .card:first-child {
      margin-left: 0 !important;
    }

    .player-small-card {
      width: 90px;
      height: 130px;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: 2px solid #00d2ff;
      border-radius: 12px;
      padding: 10px;
      font-size: 0.75rem;
      display: flex;
      flex-direction: column;
      justify-content: space-evenly;
      color: #00d2ff;
      text-align: center;
      box-shadow: 0 3px 15px rgba(0, 210, 255, 0.3);
      font-weight: 600;
      flex-shrink: 0;
    }

    .table-event-competition {
      text-align: center;
      position: relative;
      z-index: 150;
      pointer-events: auto;
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    .table-event-item {
      font-size: 1.5rem;
      font-weight: 700;
      color: #ff9800;
      margin: 10px 0;
    }

    .table-competition-item {
      font-size: 1.3rem;
      font-weight: 700;
      color: #00ff88;
      margin: 10px 0;
    }

    .event-guide-toggle-btn {
      position: absolute;
      top: -10px;
      right: 0;
      background: linear-gradient(135deg, rgba(56, 249, 255, 0.9), rgba(255, 79, 216, 0.8));
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 1.3rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      color: #05102c;
      font-weight: 700;
      box-shadow: 0 4px 15px rgba(56, 249, 255, 0.4);
    }

    .event-guide-toggle-btn:hover {
      transform: scale(1.1) translateY(-2px);
      box-shadow: 0 8px 25px rgba(56, 249, 255, 0.6);
    }

    .event-guide-toggle-btn:active {
      transform: scale(0.95);
    }

    /* Play Card Phase */
    #playCardPhase {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: linear-gradient(135deg, rgba(5, 15, 43, 0.98), rgba(15, 52, 96, 0.95));
      z-index: 100;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding: 50px 40px 50px 40px;
      box-sizing: border-box;
      overflow-y: auto;
      pointer-events: auto;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding-bottom: max(50px, calc(env(safe-area-inset-bottom) + 50px));
    }

    /* ✅ Allow clicks through to event/competition when not directly over cards */
    #playCardPhase > * {
      pointer-events: auto;
    }

    #playCardPhase.show {
      display: flex;
    }

    .playCardHeader {
      text-align: center;
      color: #38f9ff;
      font-size: 2.8rem;
      font-weight: 800;
      margin-bottom: 50px;
      text-shadow: 0 0 25px rgba(56, 249, 255, 0.8);
      letter-spacing: 3px;
      width: 100%;
    }

    .cardPreviewArea {
      flex: 1;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      gap: 80px;
      margin-bottom: 50px;
      padding: 0 40px;
      width: 100%;
      max-width: 1400px;
    }

    .cardPreview {
      width: 300px;
      height: 420px;
      border: 3px solid #38f9ff;
      border-radius: 28px;
      display: flex;
      flex-direction: column;
      padding: 0;
      background: linear-gradient(135deg, rgba(5, 15, 43, 0.9), rgba(15, 52, 96, 0.8));
      font-size: 1.4rem;
      text-align: center;
      box-shadow: 0 0 40px rgba(56, 249, 255, 0.6), inset 0 0 25px rgba(56, 249, 255, 0.1);
      background-size: cover;
      background-position: center;
      overflow: hidden;
      position: relative;
      animation: cardGlow 3s ease-in-out infinite;
    }

    @keyframes cardGlow {
      0%, 100% { box-shadow: 0 0 40px rgba(56, 249, 255, 0.6), inset 0 0 25px rgba(56, 249, 255, 0.1); }
      50% { box-shadow: 0 0 60px rgba(56, 249, 255, 0.9), inset 0 0 35px rgba(56, 249, 255, 0.2); }
    }

    .cardPreviewImage {
      font-size: 5.5rem;
      margin: 25px 0;
      filter: drop-shadow(0 0 15px rgba(56, 249, 255, 0.6));
    }

    .cardPreviewStats {
      flex: 1;
      min-width: 300px;
      max-width: 380px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      padding: 25px;
      background: linear-gradient(135deg, rgba(5, 15, 43, 0.95), rgba(15, 52, 96, 0.88));
      border: 3px solid #38f9ff;
      border-radius: 24px;
      font-size: 1rem;
      color: #52ffa0;
      line-height: 1.6;
      height: 420px;
      justify-content: flex-start;
      box-shadow: 0 0 35px rgba(56, 249, 255, 0.5);
    }

    /* Score Formula Guide - removed from playCardPhase */

    @media (max-width: 1024px) {
      .score-formula-guide {
        position: static;
        width: 100%;
        margin-top: 20px;
        pointer-events: auto;
      }
    }


    .hand {
      display: flex;
      gap: 0;
      justify-content: center;
      flex-wrap: nowrap;
      padding: 0;
      background: transparent;
      border: none;
      max-height: none;
    }


    /* ✅ Cards in phaseHandContainer - no overlap, can scroll */
    #phaseHandContainer {
      display: flex !important;
      flex-wrap: nowrap !important;
      justify-content: center;
      gap: 12px !important;
      overflow-x: auto !important;
      overflow-y: hidden !important;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
      scroll-behavior: smooth;
      touch-action: pan-x;
      -webkit-overflow-scrolling: touch;
      padding: 20px 25px !important;
      background: linear-gradient(135deg, rgba(5, 15, 43, 0.85), rgba(15, 52, 96, 0.75)) !important;
      border: 3px solid #38f9ff !important;
      border-radius: 24px !important;
      min-height: 210px !important;
      box-shadow: 0 0 35px rgba(56, 249, 255, 0.35), inset 0 0 20px rgba(56, 249, 255, 0.08) !important;
      width: 100% !important;
      max-width: 100% !important;
    }
    
    #phaseHandContainer::-webkit-scrollbar {
      display: none; /* Chrome, Safari and Opera */
    }
    
    #phaseHandContainer .card {
      margin-left: 0 !important;
      flex-shrink: 0;
      min-width: 140px;
      width: 140px;
      height: 200px;
      transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .card {
      width: 120px;
      height: 175px;
      background: linear-gradient(135deg, #0a1f4d, #0f3460);
      border: 2px solid rgba(56, 249, 255, 0.4);
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding: 8px;
      text-align: center;
      font-size: 0.8rem;
      box-shadow: 0 4px 15px rgba(56, 249, 255, 0.2);
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
      margin-left: -60px;
    }

    .card:first-child {
      margin-left: 0;
    }

    .card:hover {
      transform: translateY(-55px) scale(1.3);
      z-index: 100;
      border-color: #ff4fd8;
      box-shadow: 0 20px 50px rgba(56, 249, 255, 0.9), 0 0 30px rgba(255, 79, 216, 0.6);
    }

    .card.selected {
      border: 3px solid #ffd166;
      background: linear-gradient(135deg, rgba(255, 209, 102, 0.25), rgba(255, 215, 0, 0.15));
      box-shadow: 0 0 35px #ffd166, 0 0 20px rgba(255, 209, 102, 0.7);
      transform: scale(1.15);
    }

    .skill-tooltip {
      position: absolute;
      background: linear-gradient(135deg, rgba(5, 15, 43, 0.98), rgba(15, 52, 96, 0.95));
      border: 2px solid #52ffa0;
      border-radius: 12px;
      padding: 12px 15px;
      font-size: 0.9rem;
      color: #52ffa0;
      display: none;
      z-index: 1000;
      white-space: nowrap;
      bottom: -55px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 8px 25px rgba(82, 255, 160, 0.4);
      font-weight: 600;
      animation: tooltipPopIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes tooltipPopIn {
      0% { opacity: 0; transform: translateX(-50%) translateY(-5px); }
      100% { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    .card:hover .skill-tooltip {
      display: block;
    }

    .card-character {
      font-weight: 800;
      color: #38f9ff;
      font-size: 1.1rem;
      text-shadow: 0 0 10px rgba(56, 249, 255, 0.6);
    }

    .card-stats {
      display: flex;
      justify-content: space-around;
      font-size: 0.85rem;
      color: #ffd166;
      margin: 5px 0;
      font-weight: 700;
    }

    /* ✅ ขยายฟอนต์ Stats ใน Phase เลือกการ์ด */
    #phaseHandContainer .card-stats {
      font-size: 1.4rem;
      font-weight: 800;
      color: #ffd166;
    }

    .card-rarity {
      font-size: 0.8rem;
      color: #ff8fa3;
      font-weight: 700;
      text-shadow: 0 0 8px rgba(255, 143, 163, 0.4);
    }

    .card-skill {
      font-size: 0.75rem;
      color: #52ffa0;
      display: none;
      font-weight: 600;
    }

    /* ✅ Card image */
    .card-image {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
      flex-shrink: 0;
    }

    /* ✅ Card info */
    .card-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 2px;
      padding: 4px 4px;
      background: rgba(0, 0, 0, 0.3);
      min-height: 48px;
    }

    /* ✅ Card skill badge */
    .card-skill-badge {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 0.95) 40%);
      color: #ffffff;
      font-size: 0.65rem;
      font-weight: 600;
      padding: 4px 3px;
      text-align: center;
      border-radius: 0 0 12px 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      word-wrap: break-word;
      max-height: 32px;
      overflow: hidden;
    }

    .button-group {
      display: flex;
      gap: 30px;
      margin-top: 50px;
      justify-content: center;
      width: 100%;
      padding: 30px 40px;
      box-sizing: border-box;
      flex-shrink: 0;
    }

    .btn-confirm {
      background: linear-gradient(135deg, #38f9ff, #52ffa0);
      color: #050f2b;
      display: none;
      font-weight: 800;
      padding: 16px 50px;
      font-size: 1.2rem;
      border-radius: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 25px rgba(56, 249, 255, 0.4);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .btn-confirm::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .btn-confirm.show {
      display: inline-block;
      animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .btn-confirm:hover {
      transform: translateY(-8px) scale(1.05);
      box-shadow: 0 15px 45px rgba(56, 249, 255, 0.8), 0 0 30px rgba(82, 255, 160, 0.6);
      background: linear-gradient(135deg, #52ffa0, #38f9ff);
    }

    .btn-confirm:active {
      transform: translateY(-4px) scale(0.98);
    }

    .btn-skip {
      background: linear-gradient(135deg, #ff4fd8, #ff8fa3);
      color: white;
      padding: 18px 60px;
      font-size: 1.3rem;
      border-radius: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 25px rgba(255, 79, 216, 0.3);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .btn-skip:hover {
      transform: translateY(-8px) scale(1.05);
      box-shadow: 0 15px 45px rgba(255, 79, 216, 0.8), 0 0 30px rgba(255, 107, 107, 0.6);
    }

    /* Action Phase */
    #actionPhase {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(5, 10, 43, 0.88);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      z-index: 240;
      align-items: center;
      justify-content: center;
      padding: clamp(20px, 4vw, 60px);
      padding-top: max(clamp(20px, 4vw, 60px), env(safe-area-inset-top));
      padding-bottom: max(clamp(20px, 4vw, 60px), env(safe-area-inset-bottom));
      padding-left: max(clamp(20px, 4vw, 60px), env(safe-area-inset-left));
      padding-right: max(clamp(20px, 4vw, 60px), env(safe-area-inset-right));
      transition: background 0.3s ease;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    #actionPhase.show {
      display: flex;
    }

    #actionPhase.collapsed {
      background: transparent;
      pointer-events: none;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }

    #actionPhase.collapsed .action-modal {
      opacity: 0;
      transform: translateY(24px) scale(0.97);
      pointer-events: none;
      box-shadow: none;
    }

    .action-modal {
      width: min(920px, 95vw);
      background: linear-gradient(145deg, rgba(5, 15, 43, 0.95), rgba(12, 34, 86, 0.9));
      border-radius: 36px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 35px 120px rgba(3, 10, 40, 0.65);
      padding: clamp(24px, 5vw, 56px);
      position: relative;
      overflow: hidden;
      transition: opacity 0.25s ease, transform 0.25s ease, box-shadow 0.25s ease;
      max-height: 90vh;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(56, 249, 255, 0.3) transparent;
      -webkit-overflow-scrolling: touch;
    }

    .action-modal::-webkit-scrollbar {
      width: 6px;
    }

    .action-modal::-webkit-scrollbar-track {
      background: transparent;
    }

    .action-modal::-webkit-scrollbar-thumb {
      background: rgba(56, 249, 255, 0.3);
      border-radius: 3px;
    }

    .action-modal::-webkit-scrollbar-thumb:hover {
      background: rgba(56, 249, 255, 0.5);
    }

    .action-modal::before,
    .action-modal::after {
      content: '';
      position: absolute;
      inset: auto;
      pointer-events: none;
    }

    .action-modal::before {
      width: 320px;
      height: 320px;
      left: -80px;
      top: -120px;
      background: radial-gradient(circle, rgba(56, 249, 255, 0.35), transparent 60%);
      filter: blur(60px);
    }

    .action-modal::after {
      width: 260px;
      height: 260px;
      right: -120px;
      bottom: -60px;
      background: radial-gradient(circle, rgba(255, 79, 216, 0.3), transparent 60%);
      filter: blur(70px);
    }

    .action-header {
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .action-eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.3em;
      font-size: 0.85rem;
      color: rgba(245, 251, 255, 0.55);
      margin-bottom: 8px;
    }

    .action-title {
      font-size: clamp(2.2rem, 6vw, 3.8rem);
      margin: 0;
      color: #ffffff;
      text-shadow: 0 0 25px rgba(255, 255, 255, 0.35);
    }

    html[data-lang='en'] .action-title,
    html[data-lang='ja'] .action-title {
      font-size: clamp(1.9rem, 5vw, 3.2rem);
      line-height: 1.1;
    }

    .action-countdown {
      margin-top: 12px;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(255, 255, 255, 0.05);
      font-weight: 600;
      font-size: 1rem;
      color: rgba(245, 251, 255, 0.85);
    }

    .action-countdown-value {
      font-size: 1.4rem;
      color: #ff9edb;
    }

    .action-meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 30px;
    }

    .action-chip {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 16px 20px;
      backdrop-filter: blur(6px);
    }

    .action-chip-label {
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      color: rgba(245, 251, 255, 0.6);
    }

    .action-chip-value {
      margin-top: 6px;
      font-size: 1.2rem;
      color: #38f9ff;
      font-weight: 600;
    }

    /* Play Card Phase Event/Competition Display */
    .play-card-meta-section {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      justify-content: center;
      width: 100%;
      max-width: 100%;
      margin: 30px auto;
      padding: 0 40px;
      flex-wrap: wrap;
    }

    .play-card-meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      flex: 1;
      min-width: 250px;
    }

    .play-card-chip {
      background: linear-gradient(135deg, rgba(56, 249, 255, 0.15), rgba(82, 255, 160, 0.1));
      border: 2px solid rgba(56, 249, 255, 0.5);
      border-radius: 20px;
      padding: 20px 28px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 8px 25px rgba(56, 249, 255, 0.2);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .play-card-chip:hover {
      border-color: rgba(56, 249, 255, 0.9);
      box-shadow: 0 12px 35px rgba(56, 249, 255, 0.4);
      transform: translateY(-4px);
      background: linear-gradient(135deg, rgba(56, 249, 255, 0.2), rgba(82, 255, 160, 0.15));
    }

    .play-card-chip-label {
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      color: rgba(245, 251, 255, 0.65);
      font-weight: 700;
    }

    .play-card-chip-value {
      margin-top: 10px;
      font-size: 1.5rem;
      color: #52ffa0;
      font-weight: 800;
      text-shadow: 0 0 15px rgba(82, 255, 160, 0.6);
    }

    /* Score Formula removed from playCardPhase */

    .action-helper-text {
      margin-top: 24px;
      font-size: 1rem;
      color: rgba(245, 251, 255, 0.8);
      text-align: center;
    }

    .action-buttons {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 18px;
      margin-top: clamp(24px, 4vw, 40px);
      position: relative;
      z-index: 1;
    }

    .action-btn {
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 26px;
      padding: 22px;
      background: linear-gradient(135deg, rgba(56, 249, 255, 0.3), rgba(255, 79, 216, 0.2));
      color: #081332;
      cursor: pointer;
      text-align: left;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 20px 45px rgba(5, 15, 43, 0.55);
      transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
      font-family: 'Kanit', sans-serif;
      font-weight: 600;
    }

    .action-btn:hover {
      transform: translateY(-6px);
      box-shadow: 0 30px 65px rgba(56, 249, 255, 0.25);
      background: linear-gradient(135deg, rgba(56, 249, 255, 0.5), rgba(255, 123, 231, 0.35));
    }

    .action-btn.active {
      background: linear-gradient(135deg, #4df4b7, #38f9ff);
      box-shadow: 0 30px 60px rgba(72, 255, 210, 0.4);
      color: #05102c;
    }

    .action-btn__title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.3rem;
      font-weight: 700;
      color: inherit;
    }

    .action-btn__number {
      width: 48px;
      height: 48px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 1.2rem;
    }

    .action-btn__badge {
      font-size: 0.9rem;
      color: #ff9ea6;
      font-weight: 700;
    }

    .action-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      filter: grayscale(0.2);
    }

    .action-description {
      font-size: 0.95rem;
      color: rgba(7, 18, 44, 0.82);
    }

    .action-reopen-btn {
      position: fixed;
      bottom: max(28px, calc(env(safe-area-inset-bottom) + 8px));
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 28px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, rgba(56, 249, 255, 0.9), rgba(255, 79, 216, 0.8));
      color: #05102c;
      font-weight: 700;
      letter-spacing: 0.03em;
      box-shadow: 0 18px 40px rgba(5, 15, 43, 0.6);
      display: none;
      align-items: center;
      gap: 10px;
      z-index: 260;
      cursor: pointer;
    }

    .action-reopen-btn:hover {
      transform: translateX(-50%) translateY(-2px);
    }

    /* ============== CARD HAND COLLAPSE (Mobile) ============== */
    #playCardPhase.card-hand-collapsed {
      pointer-events: none;
      background: transparent !important;
      display: none !important;
    }

    #playCardPhase.card-hand-collapsed #phaseHandContainer {
      opacity: 0;
      transform: translateY(24px) scale(0.97);
      pointer-events: none;
      box-shadow: none;
      max-height: 0;
      overflow: hidden;
      transition: opacity 0.25s ease, transform 0.25s ease, max-height 0.25s ease;
    }

    #playCardPhase.card-hand-collapsed .button-group {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }

    #playCardPhase.card-hand-collapsed .cardPreviewArea {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }

    #playCardPhase.card-hand-collapsed .playCardHeader {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }

    .card-hand-reopen-btn {
      position: fixed;
      bottom: max(28px, calc(env(safe-area-inset-bottom) + 8px));
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 28px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, rgba(56, 249, 255, 0.9), rgba(255, 79, 216, 0.8));
      color: #05102c;
      font-weight: 700;
      letter-spacing: 0.03em;
      box-shadow: 0 18px 40px rgba(5, 15, 43, 0.6);
      display: none;
      align-items: center;
      gap: 10px;
      z-index: 260;
      cursor: pointer;
    }

    .card-hand-reopen-btn:hover {
      transform: translateX(-50%) translateY(-2px);
    }

    @media (max-width: 640px) {
      #actionPhase {
        padding: 16px;
        padding-top: max(16px, env(safe-area-inset-top));
        padding-bottom: max(16px, env(safe-area-inset-bottom));
        align-items: stretch;
        justify-content: flex-start;
      }

      .action-modal {
        width: 100%;
        border-radius: 24px;
        padding: 20px 16px 28px;
        box-shadow: 0 22px 60px rgba(3, 10, 40, 0.6);
        margin-top: auto;
        margin-bottom: auto;
      }

      .action-header {
        text-align: center;
      }

      .action-title {
        font-size: clamp(1.6rem, 6vw, 2.2rem);
      }

      .action-countdown {
        font-size: 0.95rem;
        padding: 8px 14px;
        gap: 8px;
      }

      .action-countdown-value {
        font-size: 1.2rem;
      }

      .action-meta-grid {
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 20px;
      }

      .action-chip {
        padding: 12px 14px;
      }

      .action-chip-label {
        font-size: 0.7rem;
      }

      .action-chip-value {
        font-size: 1rem;
        margin-top: 4px;
      }

      .action-helper-text {
        font-size: 0.9rem;
        margin-top: 16px;
      }

      .action-buttons {
        grid-template-columns: 1fr;
        gap: 12px;
        margin-top: 18px;
      }

      .action-btn {
        padding: 16px;
        border-radius: 20px;
        gap: 6px;
        min-height: 64px;
      }

      .action-btn__title {
        font-size: 1rem;
        gap: 10px;
      }

      .action-btn__number {
        width: 40px;
        height: 40px;
        font-size: 0.95rem;
      }

      .action-btn__badge {
        font-size: 0.8rem;
      }

      .action-description {
        font-size: 0.85rem;
      }
    }

    @media (max-width: 400px) {
      #actionPhase {
        padding: 12px;
        padding-top: max(12px, env(safe-area-inset-top));
        padding-bottom: max(12px, env(safe-area-inset-bottom));
      }

      .action-modal {
        padding: 16px 12px 22px;
        border-radius: 18px;
      }

      .action-title {
        font-size: clamp(1.4rem, 5vw, 2rem);
      }

      .action-countdown {
        width: 100%;
        justify-content: center;
        font-size: 0.9rem;
        padding: 6px 12px;
      }

      .action-meta-grid {
        gap: 10px;
        margin-top: 14px;
      }

      .action-chip {
        padding: 10px 12px;
      }

      .action-chip-label {
        font-size: 0.65rem;
      }

      .action-chip-value {
        font-size: 0.9rem;
      }

      .action-buttons {
        gap: 10px;
        margin-top: 16px;
      }

      .action-btn {
        padding: 14px;
        border-radius: 18px;
        min-height: 60px;
      }

      .action-btn__number {
        width: 36px;
        height: 36px;
        font-size: 0.9rem;
      }

      .action-btn__title {
        font-size: 0.95rem;
        gap: 8px;
      }

      .action-description {
        font-size: 0.8rem;
      }
    }

    .action-footer-note {
      margin-top: 24px;
      text-align: center;
      font-size: 0.85rem;
      color: rgba(245, 251, 255, 0.55);
    }

    /* ============== EVENTS CHEAT SHEET MODAL ============== */
    #eventsModal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(20, 20, 40, 0.95));
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    #eventsModal.show {
      display: flex;
    }

    .events-modal-content {
      background: linear-gradient(145deg, rgba(5, 15, 43, 0.95), rgba(12, 34, 86, 0.9));
      border: 2px solid #00d2ff;
      border-radius: 20px;
      padding: 30px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 0 50px rgba(0, 210, 255, 0.5);
    }

    .events-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(0, 210, 255, 0.3);
    }

    .events-modal-title {
      font-size: 2rem;
      font-weight: 800;
      color: #ffd700;
      margin: 0;
    }

    .events-modal-close {
      background: linear-gradient(135deg, #ff6b6b, #ff8787);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      transition: all 0.3s;
    }

    .events-modal-close:hover {
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(255, 107, 107, 0.6);
    }

    .events-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }

    .event-card {
      background: rgba(0, 210, 255, 0.1);
      border: 2px solid #00d2ff;
      border-radius: 12px;
      padding: 15px;
      transition: all 0.3s;
      cursor: default;
    }

    .event-card:hover {
      background: rgba(0, 210, 255, 0.2);
      box-shadow: 0 0 20px rgba(0, 210, 255, 0.4);
      transform: translateY(-2px);
    }

    .event-card-number {
      display: inline-block;
      background: #00d2ff;
      color: #05102c;
      font-weight: 800;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 0.85rem;
      margin-bottom: 8px;
    }

    .event-card-name {
      font-size: 1.1rem;
      font-weight: 700;
      color: #ffd700;
      margin: 8px 0;
    }

    .event-card-description {
      font-size: 0.95rem;
      color: #b0e0e6;
      line-height: 1.5;
    }

    .event-toggle-btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: rgba(0, 210, 255, 0.2);
      border: 1px solid #00d2ff;
      color: #00d2ff;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .event-toggle-btn:hover {
      background: rgba(0, 210, 255, 0.4);
      box-shadow: 0 0 15px rgba(0, 210, 255, 0.5);
    }

    .table-event-item {
      cursor: pointer;
      transition: all 0.3s;
    }

    .table-event-item:hover {
      text-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
      transform: scale(1.05);
    }

    @media (max-width: 640px) {
      .events-modal-content {
        padding: 20px;
        max-height: 95vh;
      }

      .events-grid {
        grid-template-columns: 1fr;
      }

      .events-modal-title {
        font-size: 1.5rem;
      }

      .event-card {
        padding: 12px;
      }

      .event-card-name {
        font-size: 1rem;
      }

      .event-card-description {
        font-size: 0.9rem;
      }

      .table-event-item {
        font-size: 0.9rem !important;
        margin: 5px 0 !important;
      }

      .table-competition-item {
        font-size: 0.85rem !important;
        margin: 5px 0 !important;
      }
    }

    /* Result Overlay */
    #resultOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(20, 20, 40, 0.95));
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 40px 20px;
      box-sizing: border-box;
    }

    #resultOverlay.show {
      display: flex;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* ============== RESULT WRAPPER - MAIN CONTENT ============== */
    .result-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 40px;
      width: 100%;
      max-width: 1000px;
      text-align: center;
    }

    /* ============== TITLE ============== */
    .result-title {
      font-size: 4rem;
      color: #ffd700;
      font-weight: 900;
      text-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
      margin: 0;
      animation: glow 2s infinite;
    }

    @keyframes glow {
      0%, 100% { text-shadow: 0 0 40px rgba(255, 215, 0, 0.8); }
      50% { text-shadow: 0 0 80px rgba(255, 215, 0, 1), 0 0 120px rgba(255, 215, 0, 0.6); }
    }

    /* ============== PLAYERS SCORE GRID ============== */
    .players-score-grid {
      display: none;
      grid-template-columns: repeat(5, 1fr);
      gap: 20px;
      width: 100%;
      max-width: 1400px;
      margin: 20px auto;
      justify-items: center;
      justify-content: center;
      align-items: start;
    }

    /* ============== INDIVIDUAL PLAYER SCORE BOX ============== */
    .player-score-box {
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.15), rgba(0, 150, 200, 0.1));
      border: 3px solid #00d2ff;
      border-radius: 20px;
      padding: 35px 25px;
      transition: all 0.3s;
      box-shadow: 0 8px 25px rgba(0, 210, 255, 0.2);
      animation: slideUp 0.6s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .player-score-box:hover {
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.25), rgba(0, 150, 200, 0.15));
      border-color: #00ff88;
      box-shadow: 0 12px 40px rgba(0, 210, 255, 0.4);
      transform: translateY(-5px);
    }

    .player-score-name {
      font-size: 1.8rem;
      color: #00ff88;
      font-weight: 800;
      margin-bottom: 12px;
    }

    .player-score-hearts {
      font-size: 2.2rem;
      color: #ff6b6b;
      margin-bottom: 12px;
      letter-spacing: 2px;
    }

    .player-score-points {
      font-size: 2.2rem;
      color: #ffd700;
      font-weight: 700;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
    }

    @media (max-width: 600px) {
      .result-wrapper {
        padding: 0 8px 40px;
        gap: 12px;
      }

      .result-title {
        font-size: 2rem;
      }

      .players-score-grid {
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        max-width: 100%;
      }

      .player-score-box {
        width: 100%;
        max-width: 280px;
        padding: 14px;
        border-width: 2px;
        box-shadow: 0 6px 20px rgba(0, 210, 255, 0.3);
      }

      .player-score-name {
        font-size: 1.1rem;
      }

      .player-score-hearts {
        font-size: 1.4rem;
      }

      .player-score-points {
        font-size: 1.4rem;
      }

      .winner-announcement {
        width: 100%;
        max-width: 280px;
        padding: 14px;
      }
    }

    /* ============== TURN WINNER ANNOUNCEMENT ============== */
    .winner-announcement {
      display: none;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 150, 0, 0.1));
      border: 3px solid #ffd700;
      border-radius: 25px;
      padding: 35px 50px;
      margin: 20px 0;
      animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes popIn {
      0% {
        opacity: 0;
        transform: scale(0.5);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .turn-winner {
      font-size: 3.5rem;
      color: #ffd700;
      font-weight: 900;
      text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
      margin: 0 0 15px 0;
    }

    .turn-winner-score {
      font-size: 2rem;
      color: #00ff88;
      font-weight: 700;
      margin: 0;
    }

    /* ============== GAME OVER MESSAGE ============== */
    .game-over-message {
      background: linear-gradient(135deg, rgba(46, 204, 113, 0.25), rgba(39, 174, 96, 0.15));
      border: 4px solid #2ecc71;
      border-radius: 30px;
      padding: 40px 60px;
      margin-top: 20px;
      animation: pulse 1.5s infinite alternate;
    }

    .final-winner-text {
      font-size: 3rem;
      color: #2ecc71;
      font-weight: 900;
      text-shadow: 0 0 40px rgba(46, 204, 113, 0.8);
      margin: 0;
      letter-spacing: 2px;
    }

    /* ============== REVEALED CARDS SECTION ============== */
    .revealed-cards-section {
      width: 100%;
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid #00ff88;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .revealed-title {
      font-size: 1.8rem;
      color: #00ff88;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .revealed-cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
      max-width: 100%;
    }

    .revealed-card-item {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: 2px solid #00d2ff;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      font-size: 0.85rem;
      color: #00ff88;
      font-weight: 600;
      overflow: hidden;
      word-wrap: break-word;
    }

    .error-message {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #e74c3c;
      padding: 20px;
      border-radius: 10px;
      font-size: 1.1rem;
      max-width: 400px;
      z-index: 1000;
      animation: slideIn 0.3s;
    }

    /* ==================== DECK PILE (กองการ์ด) ==================== */
    .deck-pile {
      position: fixed;
      right: 20%;
      top: 45%;
      transform: translateY(-50%);
      z-index: 90;
      transition: transform 0.3s ease;
    }

    .deck-pile:hover {
      transform: translateY(-50%) scale(1.05);
    }

    .deck-card {
      width: 110px;
      height: 158px;
      background-image: url('/assets/images/cards/0Backcard.jpg');
      background-size: cover;
      background-position: center;
      border-radius: 12px;
      position: absolute;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      border: 2px solid #00d2ff;
    }

    .deck-card-1 { top: 0; left: 0; }
    .deck-card-2 { top: 3px; left: 3px; }
    .deck-card-3 { top: 6px; left: 6px; }
    .deck-card-4 { top: 9px; left: 9px; z-index: 10; }

    /* ==================== CARD ANIMATIONS ==================== */
    @keyframes drawCardFromDeck {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      50% {
        transform: translate(-300px, 100px) scale(0.8) rotate(10deg);
        opacity: 0.8;
      }
      100% {
        transform: translate(-600px, 300px) scale(1);
        opacity: 1;
      }
    }

    @keyframes returnCardToDeck {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      50% {
        transform: translate(300px, -100px) scale(0.8) rotate(-10deg);
        opacity: 0.8;
      }
      100% {
        transform: translate(600px, -300px) scale(0.9);
        opacity: 0;
      }
    }

    .card-flying {
      position: fixed;
      z-index: 1000;
      pointer-events: none;
    }

    @keyframes slideIn {
      from { transform: translateX(500px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.1); }
    }

    /* ==================== RESPONSIVE DESIGN ==================== */
    /* Mobile (< 768px) */
    @media (max-width: 767px) {
      body {
        height: auto;
        overflow: auto;
        font-size: 16px;
        line-height: 1.4;
      }

      #lobbyContainer {
        height: auto;
        padding: 20px;
        min-height: 100vh;
      }

      .lobby-box {
        padding: 30px 20px;
        max-width: 100%;
        width: 100%;
      }

      .lobby-box h1 {
        font-size: 2rem;
      }

      .game-table {
        flex-direction: column;
        align-items: stretch;
        padding: 10px 10px 140px;
      }

      .table-wrapper {
        display: grid;
        grid-template-columns: 1fr 1fr;
        align-items: start;
        gap: 10px;
        max-width: 100%;
        height: auto;
      }

      .player-area.p4 {
        grid-column: 1;
        grid-row: 1;
        max-width: 100% !important;
      }

      .player-area.p5 {
        grid-column: 2;
        grid-row: 1;
        max-width: 100% !important;
      }

      .player-area.p2 {
        grid-column: 1;
        grid-row: 2;
        max-width: 100% !important;
      }

      .player-area.p3 {
        grid-column: 2;
        grid-row: 2;
        max-width: 100% !important;
      }

      .table-center {
        grid-column: 1 / -1;
        grid-row: 3;
        width: 100%;
        max-width: 100%;
        padding: 10px;
        margin: 0 auto;
        background: rgba(0, 0, 0, 0.5) !important;
        border: 2px solid #ffd700 !important;
        border-radius: 12px !important;
      }

      .player-area.p1 {
        grid-column: 1 / -1;
        grid-row: 4;
        max-width: 100% !important;
      }

      #header {
        flex-direction: row;
        gap: 20px;
        font-size: 0.9rem;
      }

      #eventCompetitionDisplay {
        flex-direction: column;
        font-size: 0.9rem;
        padding: 10px;
      }

      .player-name-tag {
        font-size: 0.75rem;
        padding: 4px 8px;
      }

      .player-hearts-display {
        font-size: 0.9rem;
      }

      .player-area {
        width: 100%;
        max-width: 100% !important;
        margin: 0 auto;
      }

      .player-played-cards {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 4px;
        width: 100%;
      }

      .board-grid,
      .table-board-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 4px;
        width: 100%;
      }

      .board-grid .card-slot,
      .table-board-grid .card-slot {
        min-height: 50px;
      }

      .player-area .card,
      .player-small-card {
        width: 100%;
        min-width: 0;
        max-width: 60px;
        height: 140px;
        font-size: 0.85rem;
      }

      .hand,
      #phaseHandContainer {
        display: flex !important;
        flex-wrap: nowrap !important;
        overflow-x: auto !important;
        overflow-y: hidden !important;
        gap: 8px !important;
        padding: 10px 10px 12px !important;
        max-width: 100% !important;
        width: 100% !important;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
        margin: 8px auto !important;
        min-height: 155px !important;
      }

      .hand::-webkit-scrollbar,
      #phaseHandContainer::-webkit-scrollbar {
        display: none;
      }

      .hand .card,
      #phaseHandContainer .card {
        flex: 0 0 95px;
        height: 140px;
        font-size: 0.8rem;
        min-width: 95px;
      }

      #hand {
        position: fixed;
        left: 50% !important;
        transform: translateX(-50%) !important;
        max-width: 95% !important;
        justify-content: center !important;
      }

      #phaseHandContainer {
        max-height: none;
        height: auto;
      }

      .phase-title {
        font-size: 1.2rem;
      }

      .action-buttons {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .action-btn {
        padding: 18px;
        font-size: 1rem;
        min-height: 48px;
      }

      .action-btn__number {
        width: 48px;
        height: 48px;
        font-size: 1rem;
      }

      .action-description,
      .action-btn__title,
      .action-text {
        font-size: 1rem;
      }

      .result-content {
        padding: 20px;
        width: 90%;
      }

      .btn,
      .button-group button,
      .action-reopen-btn,
      .card-hand-reopen-btn {
        padding: 14px 24px;
        font-size: 1rem;
        min-height: 48px;
      }

      .button-group {
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 12px !important;
        bottom: 12px !important;
      }

      .btn-confirm,
      .btn-skip {
        padding: 12px 20px !important;
        font-size: 0.95rem !important;
        min-height: 44px !important;
      }

      .cardPreviewArea {
        flex-direction: column;
        align-items: stretch;
      }

      .cardPreview,
      .cardPreviewStats {
        width: 100%;
        max-width: 100%;
        min-height: 260px;
      }

      /* Mobile playCardPhase styles removed - using desktop layout only */
    }

    /* Tablet (768px - 1024px) */
    @media (min-width: 768px) and (max-width: 1024px) {
      .table-wrapper {
        grid-template-columns: 1fr 1.5fr 1fr;
        max-width: 100%;
      }

      .hand {
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      }

      .lobby-box {
        max-width: 90%;
      }
    }

    /* Extra small screens landscape removed - using desktop layout only */

    /* iPhone/Android notch & safe area support removed - desktop layout only */

    /* Improved touch targets for mobile */
    @media (hover: none) and (pointer: coarse) {
      .action-btn {
        min-height: 56px;
        padding: 18px 16px;
        touch-action: manipulation;
      }

      .action-btn__number {
        min-width: 44px;
        min-height: 44px;
      }

      .btn,
      .btn-confirm,
      .btn-skip,
      .action-reopen-btn,
      .card-hand-reopen-btn {
        min-height: 48px;
        min-width: 48px;
        touch-action: manipulation;
      }

      #phaseHandContainer .card {
        min-width: 110px;
        min-height: 160px;
      }

      .card {
        min-width: 110px;
        min-height: 160px;
        touch-action: manipulation;
      }

      * {
        -webkit-tap-highlight-color: transparent;
      }
    }

    /* Desktop (> 1024px) */
    @media (min-width: 1025px) {
      body {
        height: 100vh;
        overflow: hidden;
      }

      #lobbyContainer {
        height: 100vh;
      }

      .lobby-box {
        max-width: 600px;
      }

      .game-table {
        height: calc(100vh - 200px);
      }
    }
  </style>

  <style>
    .slot-container {
      text-align: center;
      animation: fadeIn 0.3s;
    }

    .slot-machine {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: 5px solid #ffd700;
      border-radius: 20px;
      padding: 40px 80px;
      box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
    }

    .slot-display {
      font-size: 3rem;
      font-weight: bold;
      color: #fff;
      background: rgba(0, 0, 0, 0.5);
      padding: 30px 60px;
      border-radius: 10px;
      min-width: 400px;
      transition: transform 0.1s;
    }

    .slot-result {
      text-align: center;
      animation: popIn 0.5s;
    }

    .revealed-container {
      text-align: center;
      animation: fadeIn 0.3s;
    }

    .revealed-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }

    .revealed-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: 3px solid #ffd700;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes popIn {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes flipCard {
      0% { transform: rotateY(0deg); }
      50% { transform: rotateY(90deg); }
      100% { transform: rotateY(0deg); }
    }
  </style>
</head>
<body>
  <div id="audioControlPanel">
    <button id="audioMuteToggle" class="audio-toggle-btn" type="button" aria-pressed="false" title="Toggle sound effects">🔊 <span class="audio-label">SFX</span></button>
    <button id="bgmToggleButton" class="audio-toggle-btn" type="button" aria-pressed="true" title="Toggle background music">🎵 <span class="audio-label">BGM</span></button>
  </div>
  <div id="globalMenuContainer">
    <button id="globalMenuButton" class="global-menu-btn" type="button" aria-haspopup="true" aria-expanded="false">☰</button>
    <!-- Popup Menu for Game -->
    <div id="globalMenuPopup" class="global-menu-popup">
      <button class="popup-menu-item" id="gameRuleBtn" data-i18n="gameRule">
        <span class="popup-icon">📖</span>
        <span class="popup-text">GAME RULE</span>
      </button>
      <button class="popup-menu-item" id="skillInfoBtn" data-i18n="skillInfo">
        <span class="popup-icon">⚡</span>
        <span class="popup-text">Skill Info</span>
      </button>
      <button class="popup-menu-item" id="eventGuideBtn" data-i18n="eventGuide">
        <span class="popup-icon">📋</span>
        <span class="popup-text">EVENT GUIDE</span>
      </button>
      <div class="popup-menu-divider"></div>
      <button class="popup-menu-item" id="bgmGameToggleBtn" type="button" aria-pressed="true">
        <span class="popup-icon">🎵</span>
        <span class="popup-text bgm-toggle-text">BGM ON</span>
      </button>
      <button class="popup-menu-item" id="sfxGameToggleBtn" type="button" aria-pressed="true">
        <span class="popup-icon">🔊</span>
        <span class="popup-text sfx-toggle-text">SFX ON</span>
      </button>
    </div>
  </div>

  <!-- Side Menu Panel -->
  <div id="sideMenuPanel" class="side-menu-panel">
    <div class="side-menu-header">
      <button id="sideMenuClose" class="side-menu-close" type="button" aria-label="Close">✕</button>
    </div>
    <div class="side-menu-content">
      <button class="side-menu-item" data-action="home" data-i18n="menuHome">
        <span class="menu-icon">🏠</span>
        <span class="menu-text" data-i18n="menuHome">หน้าแรก</span>
      </button>
      <button class="side-menu-item" data-action="about" data-i18n="menuAbout">
        <span class="menu-icon">ℹ️</span>
        <span class="menu-text" data-i18n="menuAbout">เกี่ยวกับเรา</span>
      </button>
      <button class="side-menu-item" data-action="sprInfo" data-i18n="menuSprInfo">
        <span class="menu-icon">🧠</span>
        <span class="menu-text" data-i18n="menuSprInfo">SPRgame Info</span>
      </button>
      <button class="side-menu-item" data-action="gameInfo" data-i18n="menuGameInfo">
        <span class="menu-icon">🎮</span>
        <span class="menu-text" data-i18n="menuGameInfo">ข้อมูลเกม</span>
      </button>
    </div>
  </div>

  <!-- Menu Overlay -->
  <div id="menuOverlay" class="menu-overlay"></div>
  <div id="menuInfoPanel" class="menu-info-panel" aria-hidden="true">
    <div class="menu-info-card">
      <div class="menu-info-header">
        <h3 id="menuInfoTitle" class="menu-info-title">SPRgame</h3>
        <button id="menuInfoClose" class="menu-info-close" type="button" aria-label="Close">✕</button>
      </div>
      <div id="menuInfoBody" class="menu-info-body">โปรเจคแฟนเมดที่ทำขึ้นเพื่อแฟน Project Sekai</div>
    </div>
  </div>
  <!-- LOBBY PHASE -->
  <div id="lobbyContainer" class="hidden">
    <!-- Language Switcher -->
    <div class="psk-lang-switcher">
      <button class="btn psk-lang-btn" onclick="changeLanguage('th')" id="langBtnTh">ไทย</button>
      <button class="btn psk-lang-btn" onclick="changeLanguage('en')" id="langBtnEn">English</button>
      <button class="btn psk-lang-btn" onclick="changeLanguage('ja')" id="langBtnJa">日本語</button>
    </div>

    <div class="psk-ambient-notes" aria-hidden="true">
      <span>♪</span>
      <span>♬</span>
      <span>♫</span>
      <span>♩</span>
      <span>♪</span>
    </div>

    <div class="lobby-box psk-home-stage">
      <h1 data-i18n="title">SPRgame</h1>
      <p style="font-size: 1.5rem; margin-bottom: 20px;" data-i18n="subtitle">Project Sekai BoardCard Game (Fanmade)</p>

      <div class="room-code-display code-box" id="roomCodeDisplay"></div>

      <div class="lobby-input-group">
        <input type="text" id="playerName" placeholder="ชื่อของคุณ" data-i18n-placeholder="enterName" value="">
        <input type="text" id="roomCode" placeholder="โค้ดห้อง (6 ตัว)" data-i18n-placeholder="enterCode" maxlength="6" style="display: none;">
      </div>

      <div class="lobby-button-group psk-home-cta-group">
        <button class="btn btn-create" onclick="createRoom()" data-i18n="createRoom">🎮 สร้างห้อง</button>
        <button class="btn btn-join" onclick="toggleJoinMode()" id="joinToggle" data-i18n="joinRoom">👥 เข้าร่วม</button>
      </div>

      <div class="room-code-display psk-share-card" id="roomCodeShare" style="margin-top: 30px; display: none;">
        <p style="font-size: 1rem; margin-bottom: 10px;" data-i18n="sharCode">โค้ดห้องของคุณ:</p>
        <div id="displayCode" class="code-box" style="font-size: 3.5rem; letter-spacing: 15px;">??????</div>
      </div>

      <div class="players-list" id="playersList"></div>

      <div class="bot-controls hidden" id="botControls">
        <div class="bot-controls-header">
          <span id="botStatus">Bot 0/4</span>
          <button id="addBotBtn" type="button">+ เพิ่มบอท</button>
        </div>
        <p id="botHint">โฮสต์สามารถเพิ่มบอทได้สูงสุด 4 ตัว</p>
      </div>

      <button class="btn btn-ready" id="readyBtn" onclick="toggleReady()" data-i18n="ready">พร้อมแล้ว!</button>
      <button class="btn btn-start" id="startBtn" onclick="startGame()" data-i18n="start">🚀 เริ่มเกม!</button>
      <button class="btn" id="backBtn" onclick="goBack()" style="background: #95a5a6; display: none; margin-top: 10px;" data-i18n="back">กลับ</button>
    </div>
  </div>

  <!-- GAME PHASE -->
  <div id="gameContainer" class="hidden">
    <div id="header">
      <div class="turn-info" id="turnInfoLabel"><span class="turn-label">เทิร์น:</span> <span id="turnNumber">1</span></div>
      <div id="spectatorMode" style="display: none; color: #ff6b6b; font-size: 1.2rem; font-weight: bold; background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 10px;">👁️ โหมดดูเกม - คุณแพ้แล้ว</div>
      <div class="timer">⏱️ <span id="timer">30</span>s</div>
    </div>

    <div id="gameControlButtons" style="position: absolute; top: 80px; left: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 100;"></div>

    <!-- Deck Pile (กองการ์ด) -->
    <div id="deckPile" class="deck-pile">
      <div class="deck-card deck-card-1"></div>
      <div class="deck-card deck-card-2"></div>
      <div class="deck-card deck-card-3"></div>
      <div class="deck-card deck-card-4"></div>
    </div>

    <div class="game-table">
      <div class="table-wrapper">
        <div class="player-area p2" id="player2Area"></div>
        <div class="player-area p3" id="player3Area"></div>
        <div class="player-area p4" id="player4Area"></div>
        <div class="player-area p5" id="player5Area"></div>
        
        <div class="table-center">
          <div class="table-event-competition">
            <div class="table-event-item" id="tableEvent">📍 -</div>
            <div class="table-competition-item" id="tableCompetition">🏆 -</div>
          </div>
        </div>

        <div class="player-area p1" id="player1Area"></div>
      </div>
    </div>

    <div class="hand" id="hand" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; flex-wrap: nowrap; gap: 0; z-index: 80; max-width: 90%;"></div>

    <!-- ✅ Events Cheat Sheet Modal -->
    <div id="eventsModal">
      <div class="events-modal-content">
        <div class="events-modal-header">
          <h2 class="events-modal-title">📋 Event Guide</h2>
          <button class="events-modal-close" id="closeEventsModal">×</button>
        </div>
        <div class="events-grid" id="eventsGrid">
          <!-- Events will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- ✅ Card Detail Preview (Left Side) -->
    <div id="cardDetailPreview" style="position: fixed; left: 10px; top: 50%; transform: translateY(-50%); width: 180px; height: auto; max-height: 90vh; background: linear-gradient(135deg, rgba(5, 15, 43, 0.95), rgba(15, 52, 96, 0.85)); border: 3px solid #38f9ff; border-radius: 16px; padding: 12px; display: none; z-index: 101; box-shadow: 0 0 30px rgba(56, 249, 255, 0.4); overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none;">
      <style>
        #cardDetailPreview::-webkit-scrollbar { display: none; }
      </style>
      <div id="previewCardImage" style="width: 100%; height: 200px; background-size: cover; background-position: center; border-radius: 12px; margin-bottom: 12px;"></div>
      <div id="previewCardInfo" style="color: #52ffa0; font-size: 0.95rem; line-height: 1.5;"></div>
    </div>

    <div id="playCardPhase">
      <div class="playCardHeader" id="playCardHeader">เลือกการ์ดลงสนาม!</div>
      
      <!-- ✅ Card Preview Area (ด้านบน - แสดงการ์ดขยาย + รายละเอียด + Total Score ที่ขวา) -->
      <div id="cardPreviewContainer" style="display: flex; gap: 20px; align-items: flex-start;">
        <div class="cardPreviewArea" style="flex: 1;">
          <div class="cardPreview">
            <div style="color: #888;" id="clickCardMsg">คลิกการ์ดเพื่อดูรายละเอียด</div>
          </div>
          <div class="cardPreviewStats" style="display: none;"></div>
        </div>
        
        <!-- ✅ Total Score Display (ขวา) -->
        <div style="display: flex; flex-direction: column; gap: 12px; min-width: 200px;">
          <div style="background: linear-gradient(135deg, rgba(255, 107, 157, 0.1), rgba(56, 249, 255, 0.1)); border: 2px solid #ff4fd8; border-radius: 12px; padding: 16px; text-align: center;">
            <div style="color: #888; font-size: 0.9rem; margin-bottom: 8px;">⚡ Total Power</div>
            <div id="previewTotalScore" style="color: #ffd166; font-size: 2.5rem; font-weight: 700;">-</div>
          </div>
        </div>
      </div>
      
      <style>
        @media (max-width: 768px) {
          #cardPreviewContainer {
            flex-direction: column;
            gap: 15px;
          }
          #cardPreviewContainer > div:last-child {
            min-width: 100%;
          }
          #cardPreviewContainer > div:last-child > div {
            padding: 12px !important;
            font-size: 2rem !important;
          }
        }
      </style>

      <!-- ✅ Event & Competition Info (Chips) -->
      <div class="play-card-meta-section">
        <div class="play-card-meta-grid">
          <div class="play-card-chip">
            <div class="play-card-chip-label" id="playCardMetaEventLabel">📍 Event</div>
            <div class="play-card-chip-value" id="playCardMetaEvent">-</div>
          </div>
          <div class="play-card-chip">
            <div class="play-card-chip-label" id="playCardMetaCompetitionLabel">🏆 Competition</div>
            <div class="play-card-chip-value" id="playCardMetaCompetition">-</div>
          </div>
        </div>
      </div>

      <!-- ✅ Hand Cards Area (กรอบด้านล่าง - แสดงการ์ดทั้งหมด พร้อมเลื่อนได้) -->
      <div class="hand" id="phaseHandContainer" style="margin: 20px auto; max-width: 90%; display: flex; justify-content: center; align-items: center; flex-wrap: nowrap; overflow-x: auto !important; overflow-y: hidden !important; scroll-behavior: smooth; touch-action: pan-x; -webkit-overflow-scrolling: touch;">
        <div style="color: rgba(56, 249, 255, 0.5); font-size: 1rem; padding: 40px;" id="cardsAppearMsg">การ์ดของคุณจะปรากฏที่นี่...</div>
      </div>
      
      <div class="button-group">
        <button class="btn btn-confirm" id="confirmCard">✓ ยืนยันการ์ด</button>
      </div>
    </div>

    <div id="actionPhase">
      <div class="action-modal">
        <div class="action-header">
          <p class="action-eyebrow" id="actionPhaseEyebrow">Phase 2 · Strategy</p>
          <h1 class="action-title" id="selectActionTitle">เลือก Action!</h1>
          <div class="action-countdown">
            <span id="actionCountdownLabel">Time left</span>
            <span class="action-countdown-value"><span id="actionTimerValue">30</span><span id="actionCountdownUnit">s</span></span>
          </div>
        </div>

        <div class="action-meta-grid">
          <div class="action-chip">
            <div class="action-chip-label" id="actionMetaEventLabel">Event</div>
            <div class="action-chip-value" id="actionMetaEvent">-</div>
          </div>
          <div class="action-chip">
            <div class="action-chip-label" id="actionMetaCompetitionLabel">Competition</div>
            <div class="action-chip-value" id="actionMetaCompetition">-</div>
          </div>
        </div>

        <p class="action-helper-text" id="actionPhaseHelper">จัดการเลือกกลยุทธ์ของคุณก่อนเวลาจะหมด!</p>

        <div class="action-buttons">
          <button class="action-btn" data-action="1" id="actionBtn1">
            <div class="action-btn__title">
              <span class="action-btn__number">1</span>
              <span class="action-text">สุ่มกาชา</span>
            </div>
            <div class="action-description" id="actionDesc1">สุ่มกาชา 1 ใบ คะแนนลดลง 5 คะแนน</div>
          </button>

          <button class="action-btn" data-action="2" id="actionBtn2">
            <div class="action-btn__title">
              <span class="action-btn__number">2</span>
              <span class="action-text">ใช้สกิล</span>
              <span class="action-btn__badge" id="actionCdBadge"></span>
            </div>
            <div class="action-description" id="actionDesc2">ติด CD 2 เทิร์น</div>
          </button>

          <button class="action-btn" data-action="3" id="actionBtn3">
            <div class="action-btn__title">
              <span class="action-btn__number">3</span>
              <span class="action-text">แข่งตรง ๆ</span>
            </div>
            <div class="action-description" id="actionDesc3">พลังคงเดิม</div>
          </button>

          <button class="action-btn" data-action="4" id="actionBtn4">
            <div class="action-btn__title">
              <span class="action-btn__number">4</span>
              <span class="action-text">ถอยหนี</span>
            </div>
            <div class="action-description" id="actionDesc4">เสียพลังใจ 1</div>
          </button>
        </div>

        <div class="action-footer-note" id="actionFooterHint">แตะอีกครั้งเพื่อยืนยันตัวเลือกของคุณ</div>
      </div>
    </div>

    <button id="actionPhaseReopen" class="action-reopen-btn" type="button" aria-expanded="false">
      👁‍🗨 <span id="actionReopenLabel">เปิดหน้าต่าง Action</span>
    </button>

    <button id="cardHandReopen" class="card-hand-reopen-btn" type="button" aria-expanded="false">
      🎴 <span id="cardHandReopenLabel">เปิดการ์ด</span>
    </button>

    <div id="resultOverlay">
      <div class="result-wrapper">
        <!-- Title -->
        <div class="result-title" id="resultTitle" class="result-title-text">ผลรวมคะแนน</div>
        
        <!-- Revealed Cards Section -->
        <div class="revealed-cards-section" id="revealedCardsSection" style="display: none;">
          <div class="revealed-title" id="revealedCardsTitle">🎴 การ์ดที่หงาย</div>
          <div class="revealed-cards-grid" id="revealedCardsGrid">
            <!-- Cards will be shown here -->
          </div>
        </div>
        
        <!-- Players Score Grid -->
        <div class="players-score-grid" id="playersScoreGrid">
          <!-- Dynamic player score boxes -->
        </div>
        
        <!-- Winner Announcement -->
        <div class="winner-announcement" id="winnerAnnouncement">
          <!-- Will show winner and score -->
        </div>
        
        <!-- Game Over Message -->
        <div class="game-over-message" id="gameOverMessage" style="display: none;">
          <!-- Final winner announcement -->
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ==================== GLOBAL STATE ====================
    const socket = io();
    const actionPhaseElement = document.getElementById('actionPhase');
    const actionReopenBtn = document.getElementById('actionPhaseReopen');
    let actionModalCollapsed = false;
    
    const playCardPhaseElement = document.getElementById('playCardPhase');
    const cardHandReopenBtn = document.getElementById('cardHandReopen');
    let cardHandCollapsed = false;
    const playersListEl = document.getElementById('playersList');
    const botControlsEl = document.getElementById('botControls');
    const addBotBtn = document.getElementById('addBotBtn');
    const botStatusEl = document.getElementById('botStatus');
    const botHintEl = document.getElementById('botHint');
    
    // Language system - Read from URL parameter or localStorage
    const urlParams = new URLSearchParams(window.location.search);
    let currentLang = urlParams.get('lang') || localStorage.getItem('lang') || 'th';
    let translations = {};
    document.documentElement.setAttribute('data-lang', currentLang);
    console.log('[i18n-game] Current lang:', currentLang);

    async function loadLanguage(lang) {
      try {
        console.log(`[i18n-game] Loading language: ${lang}`);
        const response = await fetch(`/locales/${lang}.json?t=${Date.now()}`);
        console.log(`[i18n-game] Response status: ${response.status}`);
        
        if (!response.ok) {
          throw new Error(`Failed to load locales/${lang}.json: ${response.status}`);
        }
        
        translations = await response.json();
        console.log(`[i18n-game] ✅ Loaded translations for ${lang}:`, Object.keys(translations).length, 'keys');
        currentLang = lang;
        localStorage.setItem('lang', lang);
        document.documentElement.setAttribute('data-lang', currentLang);
        updatePageLanguage();
      } catch (e) {
        console.error('[i18n-game] Failed to load language:', e);
      }
    }

    function t(key) {
      return translations[key] || key;
    }

    function updatePageLanguage() {
      document.documentElement.setAttribute('data-lang', currentLang);
      // Update all data-i18n elements
      document.querySelectorAll('[data-i18n]').forEach(el => {
        el.textContent = t(el.dataset.i18n);
      });
      
      // Update all data-i18n-placeholder inputs
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        el.placeholder = t(el.dataset.i18nPlaceholder);
      });

      // === TRANSLATE CONFIRM CARD BUTTON ===
      const confirmCardBtn = document.getElementById('confirmCard');
      if (confirmCardBtn) {
        confirmCardBtn.textContent = currentLang === 'en' ? '✓ Confirm Card' : currentLang === 'ja' ? '✓ カードを確認' : '✓ ยืนยันการ์ด';
      }

      // === TRANSLATE ADD BOT BUTTON ===
      if (addBotBtn) {
        addBotBtn.textContent = currentLang === 'en' ? '+ Add Bot' : currentLang === 'ja' ? '+ ボットを追加' : '+ เพิ่มบอท';
      }

      // === TRANSLATE TURN LABEL ===
      const turnLabel = document.querySelector('.turn-label');
      if (turnLabel) {
        turnLabel.textContent = currentLang === 'en' ? 'Turn:' : currentLang === 'ja' ? 'ターン:' : 'เทิร์น:';
      }

      // === TRANSLATE PHASE TITLES ===
      const playCardHeader = document.getElementById('playCardHeader');
      const selectActionTitle = document.getElementById('selectActionTitle');
      const resultTitle = document.getElementById('resultTitle');
      const revealedCardsTitle = document.getElementById('revealedCardsTitle');
      const actionHelper = document.getElementById('actionPhaseHelper');
      const actionFooterHint = document.getElementById('actionFooterHint');
      const actionCountdownLabel = document.getElementById('actionCountdownLabel');
      const actionCountdownUnit = document.getElementById('actionCountdownUnit');
      const actionEyebrow = document.getElementById('actionPhaseEyebrow');
      const actionEventLabel = document.getElementById('actionMetaEventLabel');
      const actionCompetitionLabel = document.getElementById('actionMetaCompetitionLabel');
      const actionReopenLabel = document.getElementById('actionReopenLabel');
      const playCardEventLabel = document.getElementById('playCardMetaEventLabel');
      const playCardCompetitionLabel = document.getElementById('playCardMetaCompetitionLabel');

      if (currentLang === 'en') {
        if (playCardHeader) playCardHeader.textContent = 'Select a card to play!';
        if (selectActionTitle) selectActionTitle.textContent = 'Choose an action!';
        if (resultTitle) resultTitle.textContent = 'Turn Results';
        if (revealedCardsTitle) revealedCardsTitle.textContent = '🎴 Revealed Cards';
        if (actionHelper) actionHelper.textContent = 'Pick a strategy before the timer hits zero.';
        if (actionFooterHint) actionFooterHint.textContent = 'Tip: tap again to confirm your choice.';
        if (actionCountdownLabel) actionCountdownLabel.textContent = 'Time left';
        if (actionCountdownUnit) actionCountdownUnit.textContent = 's';
        if (actionEyebrow) actionEyebrow.textContent = 'Phase 2 · Strategy';
        if (actionEventLabel) actionEventLabel.textContent = 'Event';
        if (actionCompetitionLabel) actionCompetitionLabel.textContent = 'Competition';
        if (actionReopenLabel) actionReopenLabel.textContent = 'Open action window';
        if (playCardEventLabel) playCardEventLabel.textContent = '📍 Event';
        if (playCardCompetitionLabel) playCardCompetitionLabel.textContent = '🏆 Competition';
      } else if (currentLang === 'ja') {
        if (playCardHeader) playCardHeader.textContent = 'カードを選んで使用します！';
        if (selectActionTitle) selectActionTitle.textContent = 'アクションを選択してください！';
        if (resultTitle) resultTitle.textContent = 'ターン結果';
        if (revealedCardsTitle) revealedCardsTitle.textContent = '🎴 公開されたカード';
        if (actionHelper) actionHelper.textContent = 'カウントがゼロになる前に戦略を決めましょう。';
        if (actionFooterHint) actionFooterHint.textContent = 'ヒント: もう一度タップすると確定します。';
        if (actionCountdownLabel) actionCountdownLabel.textContent = '残り時間';
        if (actionCountdownUnit) actionCountdownUnit.textContent = '秒';
        if (actionEyebrow) actionEyebrow.textContent = 'フェーズ2 · ストラテジー';
        if (actionEventLabel) actionEventLabel.textContent = 'イベント';
        if (actionCompetitionLabel) actionCompetitionLabel.textContent = '競技';
        if (actionReopenLabel) actionReopenLabel.textContent = 'アクション画面を開く';
        if (playCardEventLabel) playCardEventLabel.textContent = '📍 イベント';
        if (playCardCompetitionLabel) playCardCompetitionLabel.textContent = '🏆 競技';
      } else {
        if (playCardHeader) playCardHeader.textContent = 'เลือกการ์ดลงสนาม!';
        if (selectActionTitle) selectActionTitle.textContent = 'เลือก Action!';
        if (resultTitle) resultTitle.textContent = 'ผลรวมคะแนน';
        if (revealedCardsTitle) revealedCardsTitle.textContent = '🎴 การ์ดที่หงาย';
        if (actionHelper) actionHelper.textContent = 'เลือกแผนการของคุณให้เสร็จก่อนเวลาจะหมด!';
        if (actionFooterHint) actionFooterHint.textContent = 'ทิป: แตะซ้ำอีกครั้งเพื่อยืนยันตัวเลือก';
        if (actionCountdownLabel) actionCountdownLabel.textContent = 'เวลาที่เหลือ';
        if (actionCountdownUnit) actionCountdownUnit.textContent = 'วิ';
        if (actionEyebrow) actionEyebrow.textContent = 'Phase 2 · กลยุทธ์';
        if (actionEventLabel) actionEventLabel.textContent = 'อีเวนต์';
        if (actionCompetitionLabel) actionCompetitionLabel.textContent = 'การแข่งขัน';
        if (actionReopenLabel) actionReopenLabel.textContent = 'เปิดหน้าต่าง Action';
        if (playCardEventLabel) playCardEventLabel.textContent = '📍 อีเวนต์';
        if (playCardCompetitionLabel) playCardCompetitionLabel.textContent = '🏆 การแข่งขัน';
      }

      // === TRANSLATE ACTION BUTTONS ===
      if (currentLang === 'en') {
        // Update action button text content
        const actionTexts = document.querySelectorAll('.action-text');
        const actionDescs = document.querySelectorAll('.action-description');
        
        if (actionTexts[0]) actionTexts[0].textContent = 'Gacha';
        if (actionTexts[1]) actionTexts[1].textContent = 'Use Skill';
        if (actionTexts[2]) actionTexts[2].textContent = 'Compete';
        if (actionTexts[3]) actionTexts[3].textContent = 'Flee';
        
        if (actionDescs[0]) actionDescs[0].textContent = 'Draw 1 card, lose 5 points';
        if (actionDescs[1]) actionDescs[1].textContent = 'Skill on cooldown for 2 turns';
        if (actionDescs[2]) actionDescs[2].textContent = 'Face off directly';
        if (actionDescs[3]) actionDescs[3].textContent = 'Escape but lose 1 HP';
      } else if (currentLang === 'ja') {
        // Japanese translations
        const actionTexts = document.querySelectorAll('.action-text');
        const actionDescs = document.querySelectorAll('.action-description');
        
        if (actionTexts[0]) actionTexts[0].textContent = 'ガチャ';
        if (actionTexts[1]) actionTexts[1].textContent = 'スキル使用';
        if (actionTexts[2]) actionTexts[2].textContent = '直接対戦';
        if (actionTexts[3]) actionTexts[3].textContent = '逃げる';
        
        if (actionDescs[0]) actionDescs[0].textContent = '1枚ドロー、スコア-5';
        if (actionDescs[1]) actionDescs[1].textContent = 'スキルは2ターンクールダウン';
        if (actionDescs[2]) actionDescs[2].textContent = '直接対戦する';
        if (actionDescs[3]) actionDescs[3].textContent = '逃げるがHP-1';
      } else {
        // Reset to Thai
        const actionTexts = document.querySelectorAll('.action-text');
        const actionDescs = document.querySelectorAll('.action-description');
        
        if (actionTexts[0]) actionTexts[0].textContent = 'สุ่มกาชา';
        if (actionTexts[1]) actionTexts[1].textContent = 'ใช้สกิล';
        if (actionTexts[2]) actionTexts[2].textContent = 'แข่งตรง ๆ';
        if (actionTexts[3]) actionTexts[3].textContent = 'ถอยหนี';
        
        if (actionDescs[0]) actionDescs[0].textContent = 'สุ่มกาชา 1 ใบ คะแนนลดลง 5 คะแนน';
        if (actionDescs[1]) actionDescs[1].textContent = 'ติด CD 2 เทิร์น';
        if (actionDescs[2]) actionDescs[2].textContent = 'พลังคงเดิม';
        if (actionDescs[3]) actionDescs[3].textContent = 'เสียพลังใจ 1';
      }

      // === TRANSLATE PLAY CARD PHASE MESSAGES ===
      const clickCardMsg = document.getElementById('clickCardMsg');
      const cardsAppearMsg = document.getElementById('cardsAppearMsg');
      
      if (currentLang === 'en') {
        if (clickCardMsg) clickCardMsg.textContent = 'Click card to view details';
        if (cardsAppearMsg) cardsAppearMsg.textContent = 'Your cards will appear here...';
      } else if (currentLang === 'ja') {
        if (clickCardMsg) clickCardMsg.textContent = 'カードをクリックして詳細を表示';
        if (cardsAppearMsg) cardsAppearMsg.textContent = 'あなたのカードがここに表示されます...';
      } else {
        if (clickCardMsg) clickCardMsg.textContent = 'คลิกการ์ดเพื่อดูรายละเอียด';
        if (cardsAppearMsg) cardsAppearMsg.textContent = 'การ์ดของคุณจะปรากฏที่นี่...';
      }

      const cardHandReopenLabel = document.getElementById('cardHandReopenLabel');
      if (cardHandReopenLabel) {
        if (currentLang === 'en') {
          cardHandReopenLabel.textContent = 'Show cards';
        } else if (currentLang === 'ja') {
          cardHandReopenLabel.textContent = 'カードを表示';
        } else {
          cardHandReopenLabel.textContent = 'เปิดการ์ด';
        }
      }

      const spectatorModeBanner = document.getElementById('spectatorMode');
      if (spectatorModeBanner) {
        if (currentLang === 'en') {
          spectatorModeBanner.textContent = '👁️ Spectator mode - you lost';
        } else if (currentLang === 'ja') {
          spectatorModeBanner.textContent = '👁️ 観戦モード - 敗北しました';
        } else {
          spectatorModeBanner.textContent = '👁️ โหมดดูเกม - คุณแพ้แล้ว';
        }
      }

      // Update language button styles
      const langBtnTh = document.getElementById('langBtnTh');
      const langBtnEn = document.getElementById('langBtnEn');
      const langBtnJa = document.getElementById('langBtnJa');
      
      if (langBtnTh && langBtnEn && langBtnJa) {
        // Reset all buttons
        langBtnTh.style.background = '#667eea';
        langBtnTh.style.color = '#fff';
        langBtnEn.style.background = '#667eea';
        langBtnEn.style.color = '#fff';
        langBtnJa.style.background = '#667eea';
        langBtnJa.style.color = '#fff';
        
        // Highlight active language
        if (currentLang === 'th') {
          langBtnTh.style.background = '#ffd700';
          langBtnTh.style.color = '#000';
        } else if (currentLang === 'en') {
          langBtnEn.style.background = '#ffd700';
          langBtnEn.style.color = '#000';
        } else if (currentLang === 'ja') {
          langBtnJa.style.background = '#ffd700';
          langBtnJa.style.color = '#000';
        }
      }

      if (menuInfoPanel && menuInfoPanel.classList.contains('show') && activeMenuInfoTopic) {
        setMenuInfoContent(activeMenuInfoTopic);
      }
      
      // Repopulate events grid with new language
      populateEventsModal();

      // Update lobby UI if it's currently active to reflect language changes
      if (gameState.lobbyMeta && document.getElementById('lobbyContainer') && !document.getElementById('lobbyContainer').classList.contains('hidden')) {
        updateLobbyUI(gameState.lobbyMeta);
      }
    }

    function changeLanguage(lang) {
      loadLanguage(lang);
      if (gameState.lobbyMeta) {
        updateLobbyUI(gameState.lobbyMeta);
      }
    }

    const gameState = {
      phase: 'init',
      roomCode: null,
      playerName: null,
      playerId: null,
      myCard: null,
      myAction: null,
      hand: [],
      players: [],
      turn: 1,
      event: null,
      competition: null,
      isReady: false,
      isHost: false,
      playedCards: {},
      lobbyMeta: null
    };

    let _countdownInterval = null;
    let _joinMode = false;
    let overlayLockUntil = 0; // Prevent overlay content from being replaced too soon
    let overlayLockReleaseTimer = null;

    // Events Data - 19 Events Cheat Sheet
    const EVENTS_DATA = [
      {id: 1, name: {en: "Nothing", ja: "何もない", th: "ไม่มีอะไร"}, description: {en: "No effect, play normally", ja: "効果なし、通常プレイ", th: "ไม่มีอะไรเกิดขึ้นเลย เล่นปกติ"}},
      {id: 2, name: {en: "Magical Mirai", ja: "Magical Mirai", th: "Magical Mirai"}, description: {en: "VS member cards get +5 points", ja: "VS メンバーカードは +5 ポイント", th: "การ์ดสมาชิก VS คะแนนเพิ่มขึ้น 5 คะแนน"}},
      {id: 3, name: {en: "School Trip", ja: "学校旅行", th: "งานโรงเรียน"}, description: {en: "LN member cards get +5 points", ja: "LN メンバーカードは +5 ポイント", th: "การ์ดสมาชิก LN คะแนนเพิ่มขึ้น 5 คะแนน"}},
      {id: 4, name: {en: "Idol Stage", ja: "アイドルステージ", th: "เวทีไอดอล"}, description: {en: "MMJ member cards get +5 points", ja: "MMJ メンバーカードは +5 ポイント", th: "การ์ดสมาชิก MMJ คะแนนเพิ่มขึ้น 5 คะแนน"}},
      {id: 5, name: {en: "Vivid Street", ja: "Vivid Street", th: "Vivid Street"}, description: {en: "VBS member cards get +5 points", ja: "VBS メンバーカードは +5 ポイント", th: "การ์ดสมาชิก VBS คะแนนเพิ่มขึ้น 5 คะแนน"}},
      {id: 6, name: {en: "Phoenix Land", ja: "Phoenix Land", th: "Phoenix land"}, description: {en: "WxS member cards get +5 points", ja: "WxS メンバーカードは +5 ポイント", th: "การ์ดสมาชิก WxS คะแนนเพิ่มขึ้น 5 คะแนน"}},
      {id: 7, name: {en: "Social Viral", ja: "ソーシャルバイラル", th: "โซเซียลไวรัล"}, description: {en: "Niigo member cards get +5 points", ja: "Niigo メンバーカードは +5 ポイント", th: "การ์ดสมาชิก Niigo คะแนนเพิ่มขึ้น 5 คะแนน"}},
      {id: 8, name: {en: "Festival", ja: "フェスティバル", th: "Festival"}, description: {en: "Limited/Festival rarity cards get +10 points", ja: "リミテッド/フェス レアリティカードは +10 ポイント", th: "การ์ดระดับลิมิต/เฟส คะแนนเพิ่มขึ้น 10 คะแนน"}},
      {id: 9, name: {en: "Gift from Mikudayo", ja: "ミクダヨーからのギフト", th: "ของขวัญจาก Mikudayo"}, description: {en: "All players draw 3 cards", ja: "全プレイヤーが3枚カードを引く", th: "ผู้เล่นสุ่มกาชาคนละ 3 ใบ"}},
      {id: 10, name: {en: "NeneRobo Frenzy", ja: "ネネロボ暴走", th: "NeneRobo คลั่ง"}, description: {en: "The highest stat of a card is deleted", ja: "カードの最高ステータスが削除される", th: "ค่าพลังที่เยอะที่สุดของการ์ดนั้น จะถูกลบไป"}},
      {id: 11, name: {en: "Movie Premiere!", ja: "映画公開！", th: "มูฟวี่ฉายแล้ว!"}, description: {en: "Players recover 1 HP through Miku's power", ja: "プレイヤーはミクの力で 1 HP 回復", th: "ด้วยพลังของมิกุจากหนังผู้เล่นฟื้นฟูพลังใจ 1 หน่วย"}},
      {id: 12, name: {en: "SapphireR", ja: "SapphireR", th: "SapphireR"}, description: {en: "Kohane gets +30 points", ja: "更衣は +30 ポイント", th: "Kohane คะแนนเพิ่มขึ้น 30 คะแนน"}},
      {id: 13, name: {en: "Miku VBS in Kitchen", ja: "Miku VBS キッチン", th: "มิกุVBSเข้าครัว"}, description: {en: "All card stats reduced by 2", ja: "全カードステータスが 2 減少", th: "ลบค่าพลังทุกอย่างลงอย่างละ 2 หน่วย"}},
      {id: 14, name: {en: "Mystery Show!?", ja: "ミステリー番組!?", th: "รายการปริศนา!?"}, description: {en: "Special battle mode, power values add up, no multiplier", ja: "特別バトルモード、パワー値は加算、倍率なし", th: "ไม่สุ่มการแข่งขัน แข่งรูปแบบพิเศษ ค่าพลังที่+กัน ไม่มีตัวคูณ"}},
      {id: 15, name: {en: "Card Reveal", ja: "セカイが開いた！", th: "โหนเซไก"}, description: {en: "Cards in this turn are revealed", ja: "このターンのカードが公開される", th: "หงายการ์ดในเทิร์นนั้น"}},
      {id: 16, name: {en: "Shrimp Curse", ja: "エビの呪い", th: "กุ้ง"}, description: {en: "Player loses 1 HP", ja: "プレイヤーは 1 HP を失う", th: "ค่าพลังใจของผู้เล่น -1"}},
      {id: 17, name: {en: "Love Type Buff", ja: "ラブタイプバフ", th: "Type love บัฟ"}, description: {en: "Love type cards get +5 points", ja: "愛タイプカードは +5 ポイント", th: "Type love คะแนนเพิ่มขึ้น 5 คะแนน"}},
      {id: 18, name: {en: "Hope Type Buff", ja: "ホープタイプバフ", th: "Type hope บัฟ"}, description: {en: "Hope type cards get +5 points", ja: "希望タイプカードは +5 ポイント", th: "Type hope คะแนนเพิ่มขึ้น 5 คะแนน"}},
      {id: 19, name: {en: "Happy Type Buff", ja: "ハッピータイプバフ", th: "Type happy บัฟ"}, description: {en: "Happy type cards get +5 points", ja: "幸福タイプカードは +5 ポイント", th: "Type happy คะแนนเพิ่มขึ้น 5 คะแนน"}}
    ];

    const PHASE_TIMERS = {
      eventReveal: 5,
      playCard: 25,
      action: 25,
      results: 7
    };

    function collapseActionModal() {
      if (!actionPhaseElement || actionModalCollapsed || !actionPhaseElement.classList.contains('show')) return;
      actionModalCollapsed = true;
      actionPhaseElement.classList.add('collapsed');
      if (actionReopenBtn) {
        actionReopenBtn.style.display = 'flex';
        actionReopenBtn.setAttribute('aria-expanded', 'false');
      }
    }

    function expandActionModal() {
      if (!actionPhaseElement || !actionModalCollapsed) return;
      actionModalCollapsed = false;
      actionPhaseElement.classList.remove('collapsed');
      if (actionReopenBtn) {
        actionReopenBtn.style.display = 'none';
        actionReopenBtn.setAttribute('aria-expanded', 'true');
      }
    }

    function hideActionPhaseOverlay() {
      if (!actionPhaseElement) return;
      actionModalCollapsed = false;
      actionPhaseElement.classList.remove('collapsed');
      actionPhaseElement.classList.remove('show');
      if (actionReopenBtn) {
        actionReopenBtn.style.display = 'none';
        actionReopenBtn.setAttribute('aria-expanded', 'false');
      }
    }

    // Card Hand Collapse/Expand Functions
    function collapseCardHand() {
      if (!playCardPhaseElement || cardHandCollapsed) return;
      cardHandCollapsed = true;
      playCardPhaseElement.classList.add('card-hand-collapsed');
      if (cardHandReopenBtn) {
        cardHandReopenBtn.style.display = 'flex';
        cardHandReopenBtn.setAttribute('aria-expanded', 'false');
      }
    }

    function expandCardHand() {
      if (!playCardPhaseElement || !cardHandCollapsed) return;
      cardHandCollapsed = false;
      playCardPhaseElement.classList.remove('card-hand-collapsed');
      if (cardHandReopenBtn) {
        cardHandReopenBtn.style.display = 'none';
        cardHandReopenBtn.setAttribute('aria-expanded', 'true');
      }
    }

    // Auto-collapse card hand on mobile when showing action phase
    function showActionPhase() {
      if (window.innerWidth <= 640 && !cardHandCollapsed) {
        collapseCardHand();
      }
    }

    // Events Modal Functions
    function populateEventsModal() {
      const eventsGrid = document.getElementById('eventsGrid');
      if (!eventsGrid) return;
      
      eventsGrid.innerHTML = EVENTS_DATA.map(event => {
        const lang = currentLang === 'ja' ? 'ja' : currentLang === 'en' ? 'en' : 'th';
        const name = typeof event.name === 'string' ? event.name : event.name[lang] || event.name.th;
        const description = typeof event.description === 'string' ? event.description : event.description[lang] || event.description.th;
        
        return `
        <div class="event-card">
          <div class="event-card-number">#${event.id}</div>
          <div class="event-card-name">${name}</div>
          <div class="event-card-description">${description}</div>
        </div>
      `;
      }).join('');
    }

    function showEventsModal() {
      const modal = document.getElementById('eventsModal');
      if (modal) {
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
      }
    }

    function hideEventsModal() {
      const modal = document.getElementById('eventsModal');
      if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
      }
    }

    // Populate events on load
    populateEventsModal();

    if (actionPhaseElement) {
      actionPhaseElement.addEventListener('click', (event) => {
        if (event.target === actionPhaseElement) {
          collapseActionModal();
        }
      });
    }

    if (actionReopenBtn) {
      actionReopenBtn.addEventListener('click', () => {
        expandActionModal();
      });
    }

    if (cardHandReopenBtn) {
      cardHandReopenBtn.addEventListener('click', () => {
        expandCardHand();
      });
    }

    // Events Modal Event Listeners
    const closeEventsModalBtn = document.getElementById('closeEventsModal');
    if (closeEventsModalBtn) {
      closeEventsModalBtn.addEventListener('click', hideEventsModal);
    }

    const eventsModal = document.getElementById('eventsModal');
    if (eventsModal) {
      eventsModal.addEventListener('click', (e) => {
        if (e.target === eventsModal) {
          hideEventsModal();
        }
      });
    }

    const tableEvent = document.getElementById('tableEvent');
    if (tableEvent) {
      tableEvent.addEventListener('click', showEventsModal);
    }

    // PlayCardPhase click listener to collapse/expand card hand
    if (playCardPhaseElement) {
      playCardPhaseElement.addEventListener('click', (event) => {
        // Check if click is on empty space (not on cards, buttons, or header)
        const isClickOnCard = event.target.closest('.card');
        const isClickOnButton = event.target.closest('.button-group') || event.target.closest('.btn');
        const isClickOnHeader = event.target.closest('.playCardHeader') || event.target.closest('.cardPreviewArea');
        
        if (!isClickOnCard && !isClickOnButton && !isClickOnHeader && !cardHandCollapsed) {
          collapseCardHand();
        } else if (cardHandCollapsed && !isClickOnCard && !isClickOnButton && !isClickOnHeader) {
          expandCardHand();
        }
      });
    }

    // ✅ ปิด card detail เมื่อคลิกที่ไหนก็ได้
    document.addEventListener('click', (e) => {
      const cardDetail = document.getElementById('cardDetailPreview');
      const clickedCard = e.target.closest('.card');
      
      // ถ้าคลิกไม่ใช่การ์ดและ card detail กำลังแสดงอยู่ ให้ปิด
      if (!clickedCard && cardDetail && cardDetail.style.display === 'block') {
        hideCardDetail();
      }
    });

    // ==================== SOUND SYSTEM ====================
    const audioState = {
      muted: false,
      bgmEnabled: localStorage.getItem('bgmEnabled') !== 'false',
      sfxEnabled: localStorage.getItem('sfxEnabled') !== 'false',
      userInteracted: false
    };

    const soundEffects = {
      cardDraw: new Audio('/assets/sounds/card_draw.mp3'),
      cardReturn: new Audio('/assets/sounds/card_return.wav'),
      cardPlay: new Audio('/assets/sounds/card_play.wav'),
      cardReveal: new Audio('/assets/sounds/card_reveal.mp3'),
      uiToggle: new Audio('/assets/sounds/ui_toggle.mp3'),
    };

    const loopedSoundEffects = {
      slotSpin: new Audio('/assets/sounds/slot_spin.mp3')
    };

    Object.keys(loopedSoundEffects).forEach(name => {
      if (loopedSoundEffects[name]) {
        loopedSoundEffects[name].loop = true;
        loopedSoundEffects[name].volume = 0.4;
      }
    });

    const backgroundMusic = new Audio('/assets/sounds/bgm_theme.wav');
    backgroundMusic.loop = true;
    backgroundMusic.volume = 0.18;

    [...Object.values(soundEffects), ...Object.values(loopedSoundEffects), backgroundMusic]
      .filter(Boolean)
      .forEach(audio => audio.load());

    function playSound(soundName) {
      if (audioState.muted || !audioState.sfxEnabled) return;
      const base = soundEffects[soundName];
      if (!base) return;
      const clone = base.cloneNode();
      clone.volume = base.volume ?? 0.35;
      clone.play().catch(err => console.warn('[Audio] Playback blocked:', err));
    }

    function startLoopSound(name) {
      if (audioState.muted || !audioState.sfxEnabled) return;
      const loopSound = loopedSoundEffects[name];
      if (!loopSound) return;
      loopSound.currentTime = 0;
      loopSound.play().catch(err => console.warn('[Audio] Loop playback blocked:', err));
    }

    function stopLoopSound(name) {
      const loopSound = loopedSoundEffects[name];
      if (!loopSound) return;
      loopSound.pause();
      loopSound.currentTime = 0;
    }

    function stopAllLoopingSounds() {
      Object.keys(loopedSoundEffects).forEach(stopLoopSound);
    }

    function startBackgroundMusic() {
      if (audioState.muted || !audioState.bgmEnabled) return;
      backgroundMusic.play().catch(err => console.warn('[Audio] BGM blocked:', err));
    }

    function stopBackgroundMusic() {
      backgroundMusic.pause();
      backgroundMusic.currentTime = 0;
    }

    function handleFirstAudioUnlock() {
      if (audioState.userInteracted) return;
      audioState.userInteracted = true;
      startBackgroundMusic();
    }

    const unlockHandler = () => {
      handleFirstAudioUnlock();
      window.removeEventListener('pointerdown', unlockHandler);
      window.removeEventListener('keydown', unlockHandler);
    };
    window.addEventListener('pointerdown', unlockHandler, { once: true });
    window.addEventListener('keydown', unlockHandler, { once: true });

    const muteToggleBtn = document.getElementById('audioMuteToggle');
    const bgmToggleBtn = document.getElementById('bgmToggleButton');

    function updateAudioControlUI() {
      if (muteToggleBtn) {
        muteToggleBtn.classList.toggle('muted', audioState.muted);
        muteToggleBtn.setAttribute('aria-pressed', audioState.muted ? 'true' : 'false');
        muteToggleBtn.innerHTML = `${audioState.muted ? '🔇' : '🔊'} <span class="audio-label">SFX</span>`;
      }
      if (bgmToggleBtn) {
        const bgmDisabled = !audioState.bgmEnabled || audioState.muted;
        bgmToggleBtn.classList.toggle('muted', bgmDisabled);
        bgmToggleBtn.setAttribute('aria-pressed', (!bgmDisabled).toString());
        bgmToggleBtn.innerHTML = `${audioState.bgmEnabled ? '🎵' : '🚫'} <span class="audio-label">BGM</span>`;
      }
    }

    if (muteToggleBtn) {
      muteToggleBtn.addEventListener('click', () => {
        audioState.muted = !audioState.muted;
        if (audioState.muted) {
          stopBackgroundMusic();
          stopAllLoopingSounds();
        } else if (audioState.bgmEnabled) {
          startBackgroundMusic();
        }
        updateAudioControlUI();
        playSound('uiToggle');
      });
    }

    if (bgmToggleBtn) {
      bgmToggleBtn.addEventListener('click', () => {
        audioState.bgmEnabled = !audioState.bgmEnabled;
        if (audioState.bgmEnabled && !audioState.muted) {
          startBackgroundMusic();
        } else {
          stopBackgroundMusic();
        }
        updateAudioControlUI();
        playSound('uiToggle');
      });
    }

    updateAudioControlUI();

    // ==================== GLOBAL MENU ====================
    const globalMenuContainer = document.getElementById('globalMenuContainer');
    const globalMenuButton = document.getElementById('globalMenuButton');
    const globalMenuPopup = document.getElementById('globalMenuPopup');
    const sideMenuPanel = document.getElementById('sideMenuPanel');
    const menuOverlay = document.getElementById('menuOverlay');
    const sideMenuClose = document.getElementById('sideMenuClose');
    const menuInfoTitle = document.getElementById('menuInfoTitle');
    const menuInfoBody = document.getElementById('menuInfoBody');
    const menuInfoClose = document.getElementById('menuInfoClose');
    const menuItems = document.querySelectorAll('.side-menu-item');
    const gameRuleBtn = document.getElementById('gameRuleBtn');
    const skillInfoBtn = document.getElementById('skillInfoBtn');
    const eventGuideBtn = document.getElementById('eventGuideBtn');
    let activeMenuInfoTopic = null;

    function togglePopupMenu(forceState = null) {
      if (!globalMenuPopup) return;
      const shouldOpen = forceState !== null ? forceState : !globalMenuPopup.classList.contains('show');
      if (shouldOpen) {
        globalMenuPopup.classList.add('show');
        globalMenuButton.classList.add('menu-open');
      } else {
        globalMenuPopup.classList.remove('show');
        globalMenuButton.classList.remove('menu-open');
      }
    }

    function toggleSideMenu(forceState = null) {
      if (!sideMenuPanel || !menuOverlay) return;
      togglePopupMenu(false);
      const shouldOpen = forceState !== null ? forceState : !sideMenuPanel.classList.contains('show');
      if (shouldOpen) {
        sideMenuPanel.classList.add('show');
        menuOverlay.classList.add('show');
        globalMenuButton.classList.add('menu-open');
        globalMenuButton.style.display = 'none';
        globalMenuButton.setAttribute('aria-expanded', 'true');
      } else {
        sideMenuPanel.classList.remove('show');
        menuOverlay.classList.remove('show');
        globalMenuButton.classList.remove('menu-open');
        if (gameState.phase === 'lobby' || gameState.phase === 'game') {
          globalMenuButton.style.display = 'flex';
        }
        globalMenuButton.setAttribute('aria-expanded', 'false');
      }
    }

    function setMenuInfoContent(topic) {
      if (!menuInfoTitle || !menuInfoBody) return;
      const topicMap = {
        about: { title: 'menuAbout', body: 'menuAboutContent' },
        sprInfo: { title: 'menuSprInfo', body: 'menuSprInfoContent' },
        gameInfo: { title: 'menuGameInfo', body: 'menuGameInfoContent' }
      };
      const { title, body } = topicMap[topic] || { title: 'menuLabel', body: 'menuLabel' };
      menuInfoTitle.textContent = t(title);
      menuInfoBody.innerHTML = t(body);
    }

    function showMenuInfo(topic) {
      if (!menuInfoPanel) return;
      activeMenuInfoTopic = topic;
      setMenuInfoContent(topic);
      menuInfoPanel.classList.add('show');
      menuInfoPanel.setAttribute('aria-hidden', 'false');
    }

    function hideMenuInfo() {
      if (!menuInfoPanel) return;
      activeMenuInfoTopic = null;
      menuInfoPanel.classList.remove('show');
      menuInfoPanel.setAttribute('aria-hidden', 'true');
    }

    function handleMenuAction(action) {
      toggleSideMenu(false);
      if (action === 'home') {
        hideMenuInfo();
        navigateToHomeScreen();
      } else if (['about', 'sprInfo', 'gameInfo'].includes(action)) {
        showMenuInfo(action);
      }
    }

    function navigateToHomeScreen() {
      location.href = '/';
    }

    function updateGlobalMenuVisibility() {
      if (!globalMenuButton) return;
      const shouldShow = gameState.phase === 'lobby' || gameState.phase === 'game';
      globalMenuButton.style.display = shouldShow ? 'flex' : 'none';
      
      // Change icon based on phase and add/remove lobby-mode class
      if (gameState.phase === 'lobby') {
        globalMenuButton.textContent = '☰';
        globalMenuContainer.classList.add('lobby-mode');
      } else if (gameState.phase === 'game') {
        globalMenuButton.textContent = '⚙️';
        globalMenuContainer.classList.remove('lobby-mode');
      }
      
      // Hide old audioControlPanel during game phase
      const audioControlPanel = document.getElementById('audioControlPanel');
      if (audioControlPanel) {
        audioControlPanel.style.display = gameState.phase === 'game' ? 'none' : 'flex';
      }
      
      // Close all menus if not in game/lobby
      if (gameState.phase !== 'lobby' && gameState.phase !== 'game') {
        togglePopupMenu(false);
        toggleSideMenu(false);
        hideMenuInfo();
      }
    }

    if (globalMenuButton) {
      globalMenuButton.addEventListener('click', () => {
        if (gameState.phase === 'lobby') {
          // In lobby: toggle side menu
          toggleSideMenu();
        } else if (gameState.phase === 'game') {
          // In game: toggle popup menu
          const isPopupOpen = globalMenuPopup?.classList.contains('show');
          if (isPopupOpen) {
            togglePopupMenu(false);
          } else {
            togglePopupMenu(true);
          }
        }
      });
    }

    if (sideMenuClose) {
      sideMenuClose.addEventListener('click', () => toggleSideMenu(false));
    }

    if (menuOverlay) {
      menuOverlay.addEventListener('click', () => toggleSideMenu(false));
    }

    if (menuInfoClose) {
      menuInfoClose.addEventListener('click', hideMenuInfo);
    }

    if (menuInfoPanel) {
      menuInfoPanel.addEventListener('click', (event) => {
        if (event.target === menuInfoPanel) {
          hideMenuInfo();
        }
      });
    }

    if (menuItems && menuItems.length > 0) {
      menuItems.forEach(item => {
        item.addEventListener('click', () => handleMenuAction(item.dataset.action));
      });
    }

    // Popup Menu Button Handlers
    if (gameRuleBtn) {
      gameRuleBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        togglePopupMenu(false);
        showGameRuleModal();
      });
    }

    if (skillInfoBtn) {
      skillInfoBtn.addEventListener('click', () => {
        togglePopupMenu(false);
        showSkillInfoModal();
      });
    }

    if (eventGuideBtn) {
      eventGuideBtn.addEventListener('click', () => {
        togglePopupMenu(false);
        if (document.getElementById('eventsModal')) {
          document.getElementById('eventsModal').classList.add('show');
        }
      });
    }

    // BGM Toggle Button in Popup Menu (game phase only)
    const bgmGameToggleBtn = document.getElementById('bgmGameToggleBtn');
    const sfxGameToggleBtn = document.getElementById('sfxGameToggleBtn');
    const bgmToggleText = document.querySelector('.bgm-toggle-text');
    const sfxToggleText = document.querySelector('.sfx-toggle-text');

    function updateSoundButtonStates() {
      if (bgmGameToggleBtn && bgmToggleText) {
        bgmGameToggleBtn.setAttribute('aria-pressed', audioState.bgmEnabled);
        bgmToggleText.textContent = currentLang === 'en' ? (audioState.bgmEnabled ? 'BGM ON' : 'BGM OFF') : currentLang === 'ja' ? (audioState.bgmEnabled ? 'BGM ON' : 'BGM OFF') : (audioState.bgmEnabled ? 'BGM เปิด' : 'BGM ปิด');
      }
      if (sfxGameToggleBtn && sfxToggleText) {
        sfxGameToggleBtn.setAttribute('aria-pressed', audioState.sfxEnabled);
        sfxToggleText.textContent = currentLang === 'en' ? (audioState.sfxEnabled ? 'SFX ON' : 'SFX OFF') : currentLang === 'ja' ? (audioState.sfxEnabled ? 'SFX ON' : 'SFX OFF') : (audioState.sfxEnabled ? 'SFX เปิด' : 'SFX ปิด');
      }
    }

    if (bgmGameToggleBtn) {
      bgmGameToggleBtn.addEventListener('click', () => {
        audioState.bgmEnabled = !audioState.bgmEnabled;
        localStorage.setItem('bgmEnabled', audioState.bgmEnabled);
        updateSoundButtonStates();
        
        if (backgroundMusic) {
          if (audioState.bgmEnabled && gameState.phase === 'game') {
            backgroundMusic.play().catch(e => console.log('[sound] BGM play error:', e));
          } else {
            backgroundMusic.pause();
          }
        }
      });
    }

    if (sfxGameToggleBtn) {
      sfxGameToggleBtn.addEventListener('click', () => {
        audioState.sfxEnabled = !audioState.sfxEnabled;
        localStorage.setItem('sfxEnabled', audioState.sfxEnabled);
        updateSoundButtonStates();
      });
    }

    // Close popup when clicking outside
    document.addEventListener('click', (event) => {
      if (globalMenuContainer && !globalMenuContainer.contains(event.target)) {
        togglePopupMenu(false);
      }
    });

    // Initialize sound button states
    updateSoundButtonStates();

    // Load initial language after UI controls are ready
    loadLanguage(currentLang);

    if (addBotBtn) {
      addBotBtn.addEventListener('click', () => {
        if (!gameState.roomCode) return;
        socket.emit('addBot', { code: gameState.roomCode });
      });
    }

    if (playersListEl) {
      playersListEl.addEventListener('click', (event) => {
        if (!gameState.roomCode) return;
        const removeBtn = event.target.closest('.remove-bot');
        if (removeBtn) {
          const targetPlayerId = removeBtn.dataset.playerId;
          if (!targetPlayerId) return;
          socket.emit('removeBot', { code: gameState.roomCode, playerId: targetPlayerId });
          return;
        }

        const kickBtn = event.target.closest('.kick-player');
        if (kickBtn) {
          const targetPlayerId = kickBtn.dataset.playerId;
          if (!targetPlayerId) return;
          socket.emit('kickPlayer', { code: gameState.roomCode, playerId: targetPlayerId });
        }
      });
    }

    // ==================== DECK ANIMATION FUNCTIONS ====================
    async function animateDrawCard(targetElement, cardData) {
      return new Promise((resolve) => {
        playSound('cardDraw');
        
        const deckPile = document.getElementById('deckPile');
        const deckRect = deckPile.getBoundingClientRect();
        
        // ✅ คำนวณตำแหน่งจากการ์ดใบล่าสุดใน hand หรือใช้ hand container
        const lastCard = targetElement.querySelector('.card:last-child');
        const targetRect = lastCard ? lastCard.getBoundingClientRect() : targetElement.getBoundingClientRect();
        
        const flyingCard = document.createElement('div');
        flyingCard.className = 'card-flying';
        flyingCard.style.cssText = `
          left: ${deckRect.left}px;
          top: ${deckRect.top}px;
          width: 110px;
          height: 158px;
          background-image: url('/assets/images/cards/0Backcard.jpg');
          background-size: cover;
          border-radius: 12px;
          transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
          border: 2px solid #00d2ff;
          box-shadow: 0 4px 15px rgba(0, 210, 255, 0.5);
        `;
        
        document.body.appendChild(flyingCard);
        
        setTimeout(() => {
          flyingCard.style.left = `${targetRect.left}px`;
          flyingCard.style.top = `${targetRect.top}px`;
          flyingCard.style.width = '90px';
          flyingCard.style.height = '130px';
          flyingCard.style.transform = 'rotate(360deg)';
        }, 50);
        
        setTimeout(() => {
          flyingCard.remove();
          resolve();
        }, 550);
      });
    }

    async function animateReturnCard(sourceElement) {
      return new Promise((resolve) => {
        playSound('cardReturn');
        
        const deckPile = document.getElementById('deckPile');
        const deckRect = deckPile.getBoundingClientRect();
        const sourceRect = sourceElement.getBoundingClientRect();
        
        const flyingCard = document.createElement('div');
        flyingCard.className = 'card-flying';
        flyingCard.style.cssText = `
          left: ${sourceRect.left}px;
          top: ${sourceRect.top}px;
          width: ${sourceRect.width}px;
          height: ${sourceRect.height}px;
          background-image: url('/assets/images/cards/0Backcard.jpg');
          background-size: cover;
          border-radius: 12px;
          transition: all 0.7s cubic-bezier(0.4, 0, 0.2, 1);
          border: 2px solid #00d2ff;
          box-shadow: 0 4px 15px rgba(255, 107, 107, 0.5);
        `;
        
        document.body.appendChild(flyingCard);
        
        setTimeout(() => {
          flyingCard.style.left = `${deckRect.left}px`;
          flyingCard.style.top = `${deckRect.top}px`;
          flyingCard.style.width = '110px';
          flyingCard.style.height = '158px';
          flyingCard.style.transform = 'rotate(-360deg) scale(0.9)';
          flyingCard.style.opacity = '0';
        }, 50);
        
        setTimeout(() => {
          flyingCard.remove();
          resolve();
        }, 750);
      });
    }

    // ==================== LOBBY FUNCTIONS ====================
    function createRoom() {
      const name = document.getElementById('playerName').value.trim() || 'ผู้เล่น';
      gameState.playerName = name;
      gameState.playerId = null;
      socket.emit('createRoom', { name });
    }

    function toggleJoinMode() {
      _joinMode = !_joinMode;
      const roomInput = document.getElementById('roomCode');
      const joinBtn = document.getElementById('joinToggle');
      const createBtn = document.querySelector('.btn-create');
      const backBtn = document.getElementById('backBtn');

      if (_joinMode) {
        roomInput.style.display = 'block';
        joinBtn.textContent = currentLang === 'en' ? '✓ Join' : currentLang === 'ja' ? '✓ 参加' : '✓ เข้าร่วม';
        joinBtn.onclick = () => joinRoom();
        createBtn.style.display = 'none';
        backBtn.style.display = 'block';
        roomInput.focus();
      } else {
        roomInput.style.display = 'none';
        roomInput.value = '';
        joinBtn.textContent = currentLang === 'en' ? '👥 Join Room' : currentLang === 'ja' ? '👥 ルームに参加' : '👥 เข้าร่วม';
        joinBtn.onclick = () => toggleJoinMode();
        createBtn.style.display = 'inline-block';
        backBtn.style.display = 'none';
      }
    }

    function goBack() {
      toggleJoinMode();
    }

    function joinRoom() {
      const code = document.getElementById('roomCode').value.trim().toUpperCase();
      const name = document.getElementById('playerName').value.trim() || 'ผู้เล่น';

      if (code.length !== 6) {
        showError(currentLang === 'en' ? 'Please enter 6-digit room code!' : currentLang === 'ja' ? '6桁のルームコードを入力してください！' : 'กรุณาใส่โค้ดห้องให้ครบ 6 ตัว!');
        return;
      }

      gameState.playerName = name;
      socket.emit('joinRoom', { code, name, playerId: gameState.playerId });
    }

    function toggleReady() {
      socket.emit('toggleReady', { code: gameState.roomCode });
    }

    function startGame() {
      socket.emit('startGame', gameState.roomCode);
    }

    // ==================== UI UPDATES ====================
    function showLobby() {
      gameState.phase = 'lobby';
      document.getElementById('lobbyContainer').classList.remove('hidden');
      document.getElementById('gameContainer').classList.add('hidden');
      document.getElementById('roomCodeShare').style.display = 'none';
      _joinMode = false;
      document.getElementById('roomCode').style.display = 'none';
      document.getElementById('joinToggle').textContent = currentLang === 'en' ? '👥 Join Room' : currentLang === 'ja' ? '👥 ルームに参加' : '👥 เข้าร่วม';
      document.getElementById('backBtn').style.display = 'none';
      updatePageLanguage(); // ✅ Update UI text on lobby display
      updateGlobalMenuVisibility();
    }

    function showGame() {
      gameState.phase = 'game';
      document.getElementById('lobbyContainer').classList.add('hidden');
      document.getElementById('gameContainer').classList.remove('hidden');
      updateGlobalMenuVisibility();
    }

    function updateLobbyUI(lobbyData = {}) {
      if (!playersListEl) return;
      const players = lobbyData.players || [];
      const isHost = lobbyData.hostPlayerId && lobbyData.hostPlayerId === gameState.playerId;
      gameState.isHost = !!isHost;

      const playersHeaderText = currentLang === 'en' ? '👥 Players' : currentLang === 'ja' ? '👥 プレイヤー' : '👥 ผู้เล่น';
      const readyText = currentLang === 'en' ? 'Ready ✓' : currentLang === 'ja' ? '準備完了 ✓' : 'พร้อมแล้ว ✓';
      const waitingText = currentLang === 'en' ? 'Waiting...' : currentLang === 'ja' ? '待機中...' : 'รอ...';
      const hostLabel = currentLang === 'en' ? 'Host' : currentLang === 'ja' ? 'ホスト' : 'โฮสต์';
      const botLabel = currentLang === 'en' ? 'Bot' : currentLang === 'ja' ? 'ボット' : 'บอท';
      const removeBotLabel = currentLang === 'en' ? 'Remove bot' : currentLang === 'ja' ? 'ボットを削除' : 'ลบบอท';
      const kickPlayerLabel = currentLang === 'en' ? 'Kick player' : currentLang === 'ja' ? 'プレイヤーを退出' : 'เตะผู้เล่น';

      playersListEl.innerHTML = `<h3 style="color: #00ff88; margin-bottom: 12px;">${playersHeaderText}</h3>` +
        players.map(p => {
          const badges = [];
          if (p.playerId === lobbyData.hostPlayerId) badges.push(`<span class="bot-badge">${hostLabel}</span>`);
          if (p.isBot) badges.push(`<span class="bot-badge">${botLabel}</span>`);
          const readiness = p.ready ? `<span class="player-ready">${readyText}</span>` : `<span style="color: #f39c12;">${waitingText}</span>`;
          const actionButtons = [];
          if (isHost && p.isBot) {
            actionButtons.push(`<button class="remove-bot" data-player-id="${p.playerId}" aria-label="${removeBotLabel}">✕</button>`);
          } else if (isHost && !p.isBot && p.playerId !== lobbyData.hostPlayerId) {
            actionButtons.push(`<button class="kick-player" data-player-id="${p.playerId}" aria-label="${kickPlayerLabel}">✕</button>`);
          }
          return `
            <div class="player-item">
              <span>${p.name}${badges.length ? ' ' + badges.join(' ') : ''}</span>
              <span class="player-status">${readiness} ${actionButtons.join(' ')}</span>
            </div>`;
        }).join('');

      const readyBtn = document.getElementById('readyBtn');
      const startBtn = document.getElementById('startBtn');
      const readyBtnReadyText = currentLang === 'en' ? 'Cancel Ready' : currentLang === 'ja' ? '準備キャンセル' : 'ยกเลิกพร้อม';
      const readyBtnNotReadyText = currentLang === 'en' ? 'Ready!' : currentLang === 'ja' ? '準備完了！' : 'พร้อมแล้ว!';
      const me = players.find(p => p.name === gameState.playerName);
      if (me && me.ready) {
        readyBtn.textContent = readyBtnReadyText;
        readyBtn.classList.add('ready');
      } else {
        readyBtn.textContent = readyBtnNotReadyText;
        readyBtn.classList.remove('ready');
      }

      const everyoneReady = players.length >= 2 && players.every(p => p.ready);
      if (isHost && everyoneReady) {
        startBtn.classList.add('show');
      } else {
        startBtn.classList.remove('show');
      }

      updateBotControls(lobbyData, isHost);
    }

    function updateBotControls(lobbyData, isHost) {
      if (!botControlsEl) return;
      botControlsEl.classList.toggle('hidden', !isHost);
      if (!isHost) return;

      const botCount = lobbyData.botCount ?? 0;
      const botLimit = lobbyData.botLimit ?? 4;
      const maxPlayers = lobbyData.maxPlayers ?? 5;
      const players = lobbyData.players || [];

      if (botStatusEl) {
        const statusText = currentLang === 'en'
          ? `Bots ${botCount}/${botLimit}`
          : currentLang === 'ja'
            ? `ボット ${botCount}/${botLimit}`
            : `บอท ${botCount}/${botLimit}`;
        botStatusEl.textContent = statusText;
      }

      if (botHintEl) {
        if (currentLang === 'en') {
          botHintEl.textContent = 'Host can add up to 4 bots';
        } else if (currentLang === 'ja') {
          botHintEl.textContent = 'ホストは最大4体のボットを追加できます';
        } else {
          botHintEl.textContent = 'โฮสต์สามารถเพิ่มบอทได้สูงสุด 4 ตัว';
        }
      }

      if (addBotBtn) {
        addBotBtn.disabled = botCount >= botLimit || players.length >= maxPlayers;
      }
    }

    // ✅ สร้างการ์ด + แสดง back card สำหรับคนอื่น
    const SKILL_DESCRIPTIONS = {
      'salt': '🌊 No effect',
      'leek_shield': '🛡️ No heart loss this turn',
      'never_give_up': '💪 +2 Willpower',
      'golden_microphone': '🎤 +5 Vocal',
      'feet_of_fire': '🔥 +5 Dance',
      'makeup_shop_visit': '💄 +5 Visual',
      'mic_power_cut': '📵 Opponents -5 Vocal',
      'freeze_spell': '❄️ Opponents -5 Dance',
      'banana_slip': '🍌 Opponents -5 Visual',
      'fate_control': '🎲 Change competition type',
      'hidden_skill': '👻 Block opponent skills',
      'gacha_god': '🎰 Draw 3 cards',
      'divine_card': '✨ Revive + 10 cards'
    };

    const normalizeSkillKey = (skill = '') => skill.toLowerCase().replace(/\s+/g, '_');

    function getSkillEffectDescription(skillKey) {
      if (!skillKey) return '-';
      const normalizedKey = normalizeSkillKey(skillKey);
      const localeDescriptions = translations && translations.skillDescriptions;
      if (localeDescriptions) {
        if (localeDescriptions[normalizedKey]) return localeDescriptions[normalizedKey];
        if (localeDescriptions[skillKey]) return localeDescriptions[skillKey];
      }
      return SKILL_DESCRIPTIONS[normalizedKey] || SKILL_DESCRIPTIONS[skillKey] || translateSkillName(skillKey);
    }

    function renderTableCardStats(cardElement, cardData) {
      if (!cardElement || !cardData) return;
      const displayName = translateCharacterName(cardData.character || cardData.name || 'Card');
      const vocal = cardData.vocal ?? 0;
      const dance = cardData.dance ?? 0;
      const visual = cardData.visual ?? 0;

      cardElement.innerHTML = `
        <div style="position: absolute; top: 3px; left: 3px; right: 3px; font-size: 9px; font-weight: bold; background: rgba(0,0,0,0.8); padding: 2px; border-radius: 3px; text-align: center;">${displayName}</div>
        <div style="position: absolute; bottom: 3px; left: 3px; right: 3px; background: rgba(0,0,0,0.85); padding: 4px; border-radius: 4px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2px; text-align: center;">
            <div style="font-size: 10px; color: #ff6b9d;">🎤<br><strong style="font-size: 13px; color: #fff;">${vocal}</strong></div>
            <div style="font-size: 10px; color: #00d4ff;">💃<br><strong style="font-size: 13px; color: #fff;">${dance}</strong></div>
            <div style="font-size: 10px; color: #ffd700;">✨<br><strong style="font-size: 13px; color: #fff;">${visual}</strong></div>
          </div>
        </div>
      `;
    }

    function createCardElement(card, isMe = true, revealed = false) {
      const div = document.createElement('div');
      div.className = 'card';
      div.dataset.cardId = card.id; // เก็บ ID สำหรับหงายภายหลัง

      const typeEmojis = {
        'happy': '😊',
        'love': '💖',
        'hope': '✨'
      };

      // ✅ ถ้าไม่ใช่ฉันและยังไม่หงาย → แสดง backcard (หลังการ์ด)
      if (!isMe && !revealed) {
        div.style.backgroundImage = `url('/assets/images/cards/0Backcard.jpg')`;
        div.style.backgroundSize = 'cover';
        div.style.backgroundPosition = 'center';
        div.innerHTML = ``;
        div.dataset.revealed = 'false';
        return div;
      }

      // ✅ แสดงรูปการ์ด (ทั้งของฉันและคนอื่นที่หงายแล้ว)
      const cardImageUrl = `/assets/images/cards/${String(card.id).padStart(3, '0')}.png`;
      div.style.backgroundImage = `url('${cardImageUrl}')`;
      div.style.backgroundSize = 'cover';
      div.style.backgroundPosition = 'center';
      div.dataset.revealed = 'true'; // ✅ เซ็ตว่าหงายแล้ว
      
      // เพิ่ม click handler สำหรับซูม
      div.addEventListener('click', (e) => {
        e.stopPropagation();
        showCardPreview(card);
      });

      // Store card data for preview
      div.dataset.cardData = JSON.stringify(card);
      
      if (isMe) {
        div.innerHTML = ``;
      } else {
        renderTableCardStats(div, card);
      }
      return div;
    }

    // ✅ แสดง preview การ์ด (zoom)
    function showCardPreview(card) {
      const previewDiv = document.querySelector('.cardPreview');
      const statsDiv = document.querySelector('.cardPreviewStats');
      if (!previewDiv || !statsDiv) return;

      const typeEmojis = {
        'happy': '😊',
        'love': '💖',
        'hope': '✨'
      };

      // Show card image on left
      const cardImageUrl = `/assets/images/cards/${String(card.id).padStart(3, '0')}.png`;
      previewDiv.style.backgroundImage = `url('${cardImageUrl}')`;
      previewDiv.style.backgroundSize = 'cover';
      previewDiv.style.backgroundPosition = 'center';
      previewDiv.innerHTML = '';
      
      // ✅ Translate skill name and character name
      const translatedSkill = translateSkillName(card.skill);
      const translatedCharacter = translateCharacterName(card.character);
      const skillDetail = getSkillEffectDescription(card.skill);
      const skillEffectLabel = currentLang === 'ja' ? 'スキル効果' : currentLang === 'en' ? 'Skill Effect' : 'รายละเอียดสกิล';
      
      // ✅ Calculate total score based on competition with event modifiers
      let totalScore = 0;
      let v = card.vocal || 0;
      let d = card.dance || 0;
      let vi = card.visual || 0;
      
      // Apply event modifiers (stat penalties, max stat zero)
      if (gameState.event) {
        if (gameState.event.effect === 'stat_minus_2') {
          v = Math.max(1, v - 2);
          d = Math.max(1, d - 2);
          vi = Math.max(1, vi - 2);
        }
        
        if (gameState.event.effect === 'max_stat_zero') {
          const maxStat = Math.max(v, d, vi);
          if (v === maxStat) v = 0;
          if (d === maxStat) d = 0;
          if (vi === maxStat) vi = 0;
        }
      }
      
      // Calculate base score
      if (gameState.event && gameState.event.effect === 'special_battle') {
        // Special battle: no multipliers, just sum
        totalScore = v + d + vi;
      } else if (gameState.competition === 'vocal') {
        totalScore = Math.round((v * 2 + d * 1.5 + vi * 1) * 10) / 10;
      } else if (gameState.competition === 'dance') {
        totalScore = Math.round((d * 2 + vi * 1.5 + v * 1) * 10) / 10;
      } else if (gameState.competition === 'visual') {
        totalScore = Math.round((vi * 2 + v * 1.5 + d * 1) * 10) / 10;
      } else {
        totalScore = Math.round(((v + d + vi) / 3) * 10) / 10;
      }
      
      // Apply score bonuses (after calculation)
      if (gameState.event) {
        if (gameState.event.effect === 'type_buff' && card.type === gameState.event.type) {
          totalScore += gameState.event.scoreBonus || 5;
        }
        if (gameState.event.effect === 'rarity_buff' && gameState.event.rarity && gameState.event.rarity.includes(card.rarity)) {
          totalScore += gameState.event.scoreBonus || 10;
        }
        if (gameState.event.effect === 'group_buff' && card.group === gameState.event.group) {
          totalScore += gameState.event.scoreBonus || 5;
        }
        if (gameState.event.effect === 'sapphire_r' && (card.characterBase || card.character) === 'Kohane') {
          totalScore += gameState.event.scoreBonus || 30;
        }
      }
      
      // Show stats on right
      statsDiv.style.display = 'block';
      statsDiv.innerHTML = `
        <div style="font-weight: bold; color: #ffd700; font-size: 1rem; margin-bottom: 4px;">${translatedCharacter}</div>
        <div style="margin-bottom: 2px;"><span style="font-size: 1rem;">${typeEmojis[card.type] || '?'}</span> <strong>${(card.type || '?').toUpperCase()}</strong></div>
        <div style="margin: 2px 0; font-size: 0.8rem;">📌 Rarity: ${card.rarity}</div>
        <div style="margin: 2px 0; font-size: 0.8rem;">👥 Group: ${card.group}</div>
        <div style="margin: 2px 0; font-size: 0.8rem; color: #00d2ff;">✨ Skill: ${translatedSkill}</div>
        <div style="margin: 2px 0; font-size: 0.9rem; color: #f5f5f5;">🪄 ${skillEffectLabel}: <span style="color: #00fdu5;">${skillDetail}</span></div>
        <hr style="border: 1px solid #00d2ff; margin: 4px 0;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; text-align: center;">
          <div style="background: rgba(255, 107, 157, 0.2); padding: 8px; border-radius: 3px; font-size: 1.2rem;">🎤<br><strong style="font-size: 1.4rem;">${card.vocal}</strong></div>
          <div style="background: rgba(0, 212, 255, 0.2); padding: 8px; border-radius: 3px; font-size: 1.2rem;">💃<br><strong style="font-size: 1.4rem;">${card.dance}</strong></div>
          <div style="background: rgba(255, 215, 0, 0.2); padding: 8px; border-radius: 3px; font-size: 1.2rem;">✨<br><strong style="font-size: 1.4rem;">${card.visual}</strong></div>
        </div>
      `;
      
      // ✅ Update total score display
      const totalScoreEl = document.getElementById('previewTotalScore');
      if (totalScoreEl) {
        totalScoreEl.textContent = totalScore.toString();
      }
    }

    function updateTableDisplay() {
      // ✅ Translate event and competition names based on language
      let displayEventName = gameState.event?.name || gameState.event || '-';
      if ((currentLang === 'en' || currentLang === 'ja') && gameState.event?.name) {
        displayEventName = translateEventName(gameState.event.name);
      }
      document.getElementById('tableEvent').textContent = '📍 ' + displayEventName;
      const actionMetaEvent = document.getElementById('actionMetaEvent');
      if (actionMetaEvent) actionMetaEvent.textContent = displayEventName;
      
      const competitionText = getCompetitionLabel(gameState.competition, 'table');
      document.getElementById('tableCompetition').textContent = '🏆 ' + competitionText;
      const actionMetaCompetition = document.getElementById('actionMetaCompetition');
      if (actionMetaCompetition) actionMetaCompetition.textContent = competitionText;

      // ✅ Game control buttons are now in the gear icon popup menu - hide the old container
      const btnContainer = document.getElementById('gameControlButtons');
      if (btnContainer) {
        btnContainer.style.display = 'none';
      }

      // Find my position and rotate player order so I'm at bottom (p1)
      const myIndex = gameState.players.findIndex(p => p.name === gameState.playerName);
      const playerAreas = ['player1Area', 'player2Area', 'player3Area', 'player4Area', 'player5Area'];
      
      // ✅ ซ่อนโต๊ะทั้งหมดก่อน
      playerAreas.forEach(areaId => {
        const area = document.getElementById(areaId);
        area.style.display = 'none';
        area.innerHTML = '';
      });
      
      // ✅ แสดงเฉพาะโต๊ะที่มีผู้เล่น
      gameState.players.forEach((player, idx) => {
        // Rotate: if myIndex=0, positions become [1,2,3,0]
        // if myIndex=1, positions become [2,3,0,1], etc
        const rotatedIdx = (idx - myIndex + gameState.players.length) % gameState.players.length;
        const areaId = playerAreas[rotatedIdx];
        
        if (areaId) {
          const area = document.getElementById(areaId);
          area.style.display = 'flex'; // ✅ แสดงโต๊ะนี้
          const isMe = player.name === gameState.playerName;
          
          // Clear previous content
          area.innerHTML = '';
          
          // ✅ ถ้าเป็นของฉัน → แสดงเฉพาะชื่อผู้เล่น hearts และการ์ด (ลบปุ่ม)
          if (isMe) {
            // Add player name tag
            const nameTag = document.createElement('div');
            nameTag.className = 'player-name-tag';
            nameTag.textContent = player.name;
            area.appendChild(nameTag);
            
            // Add hearts
            const hearts = document.createElement('div');
            hearts.className = 'player-hearts-display';
            hearts.textContent = '♥ ' + (player.heart || 0);
            area.appendChild(hearts);
            
            // ✅ Add played card (visual)
            if (gameState.playedCards[player.name]) {
              const card = gameState.playedCards[player.name];
              const cardElement = createCardElement(card, isMe);
              cardElement.setAttribute('data-player', player.name);
              cardElement.classList.add('table-card'); // ✅ เพิ่ม class พิเศษ
              // ✅ Reset inline styles ที่อาจทำให้การ์ดหลุด
              cardElement.style.position = 'relative';
              cardElement.style.marginLeft = '0';
              cardElement.style.transform = 'none';
              area.appendChild(cardElement);
            }
            return;
          }
          
          // Add player name tag
          const nameTag = document.createElement('div');
          nameTag.className = 'player-name-tag';
          nameTag.textContent = player.name;
          area.appendChild(nameTag);
          
          // Add hearts
          const hearts = document.createElement('div');
          hearts.className = 'player-hearts-display';
          hearts.textContent = '♥ ' + (player.heart || 0);
          area.appendChild(hearts);
          
          // ✅ Add played card (visual) - คว่ำถ้าไม่ใช่ฉัน
          if (gameState.playedCards[player.name]) {
            const card = gameState.playedCards[player.name];
            // ✅ ถ้าเป็นอีเวนต์โหนเซไก → หงายการ์ดทันที
            const isRevealed = (gameState.event?.effect === 'reveal_cards');
            const cardElement = createCardElement(card, isMe, isRevealed);
            cardElement.setAttribute('data-player', player.name);
            cardElement.classList.add('table-card'); // ✅ เพิ่ม class พิเศษ
            // ✅ Reset inline styles ที่อาจทำให้การ์ดหลุด
            cardElement.style.position = 'relative';
            cardElement.style.marginLeft = '0';
            cardElement.style.transform = 'none';
            area.appendChild(cardElement);
          }
        }
      });
    }

    // ✅ Modal: GAME RULE
    function showGameRuleModal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center;
        z-index: 2000;
      `;
      
      const gameRuleContent = currentLang === 'en' ? `
        <div style="background: linear-gradient(145deg, rgba(5, 15, 43, 0.95), rgba(12, 34, 86, 0.9)); border: 2px solid #00d2ff; border-radius: 20px; padding: 30px; max-width: 700px; max-height: 85vh; overflow-y: auto; color: #00ff88; box-shadow: 0 0 50px rgba(0, 210, 255, 0.5);">
          <div style="font-size: 2rem; font-weight: bold; color: #ffd700; margin-bottom: 20px; text-align: center;">📖 GAME RULE</div>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">Game Details & How to Play:</h3>
          <p>• 2-5 players</p>
          <p>• Start: Everyone has 6 ♥</p>
          <p>• Each Turn: Have 5 cards (no draw except from Actions)</p>
          <p>• Events: 19 random events per turn</p>
          <p>• Competition: Random between Vocal, Dance, Visual</p>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">Game Steps:</h3>
          <p>1. Select 1 card to play</p>
          <p>2. Choose an Action:</p>
          <p style="margin-left: 20px;">• Action 1 Gacha: Get 1 card but score -5</p>
          <p style="margin-left: 20px;">• Action 2 Use Skill: CD 2 turns</p>
          <p style="margin-left: 20px;">• Action 3 Compete: Direct competition</p>
          <p style="margin-left: 20px;">• Action 4 Flee: Lose 1 ♥ but keep card</p>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">Score Calculation:</h3>
          <p><strong>Vocal Battle:</strong> Vocal×2 + Dance×1.5 + Visual×1 + modifiers</p>
          <p><strong>Rhythm Clash:</strong> Dance×2 + Visual×1.5 + Vocal×1 + modifiers</p>
          <p><strong>Stage Charm:</strong> Visual×2 + Vocal×1.5 + Dance×1 + modifiers</p>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">How to Win:</h3>
          <p>• Winner: Last one with ♥ remaining</p>
          <p>• Loser: No cards or no ♥</p>
          <p>• Draw: Both lose at same time</p>
          
          <div style="text-align: center; margin-top: 30px;">
            <button style="padding: 10px 24px; font-size: 1rem; background: linear-gradient(135deg, #ff6b6b, #ff8787); border: none; color: white; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: all 0.3s;">×</button>
          </div>
        </div>
      ` : currentLang === 'ja' ? `
        <div style="background: linear-gradient(145deg, rgba(5, 15, 43, 0.95), rgba(12, 34, 86, 0.9)); border: 2px solid #00d2ff; border-radius: 20px; padding: 30px; max-width: 700px; max-height: 85vh; overflow-y: auto; color: #00ff88; box-shadow: 0 0 50px rgba(0, 210, 255, 0.5);">
          <div style="font-size: 2rem; font-weight: bold; color: #ffd700; margin-bottom: 20px; text-align: center;">📖 ゲームルール</div>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">ゲーム詳細と遊び方:</h3>
          <p>• プレイヤー: 2～5人</p>
          <p>• 開始時: 全員6 ♥を持つ</p>
          <p>• 各ターン: 5枚のカードを所持（アクション以外は引かない）</p>
          <p>• イベント: 毎ターン19個のランダムイベント</p>
          <p>• 対戦: ボーカル・ダンス・ビジュアルからランダム</p>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">ゲームステップ:</h3>
          <p>1. 使用するカード1枚を選択</p>
          <p>2. アクションを選択:</p>
          <p style="margin-left: 20px;">• アクション1 ガチャ: 1枚獲得でスコア-5</p>
          <p style="margin-left: 20px;">• アクション2 スキル使用: CD2ターン</p>
          <p style="margin-left: 20px;">• アクション3 直接対戦: スコア計算</p>
          <p style="margin-left: 20px;">• アクション4 逃げる: ♥1失うがカードキープ</p>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">スコア計算:</h3>
          <p><strong>ボーカルバトル:</strong> ボーカル×2 + ダンス×1.5 + ビジュアル×1 + 修正値</p>
          <p><strong>リズムクラッシュ:</strong> ダンス×2 + ビジュアル×1.5 + ボーカル×1 + 修正値</p>
          <p><strong>ステージチャーム:</strong> ビジュアル×2 + ボーカル×1.5 + ダンス×1 + 修正値</p>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">勝利条件:</h3>
          <p>• 勝者: ♥が残った最後の1人</p>
          <p>• 敗者: カードなし または ♥なし</p>
          <p>• 同時敗北: 同時にカードまたは♥が終わる</p>
          
          <div style="text-align: center; margin-top: 30px;">
            <button style="padding: 10px 24px; font-size: 1rem; background: linear-gradient(135deg, #ff6b6b, #ff8787); border: none; color: white; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: all 0.3s;">×</button>
          </div>
        </div>
      ` : `
        <div style="background: linear-gradient(145deg, rgba(5, 15, 43, 0.95), rgba(12, 34, 86, 0.9)); border: 2px solid #00d2ff; border-radius: 20px; padding: 30px; max-width: 700px; max-height: 85vh; overflow-y: auto; color: #00ff88; box-shadow: 0 0 50px rgba(0, 210, 255, 0.5);">
          <div style="font-size: 2rem; font-weight: bold; color: #ffd700; margin-bottom: 20px; text-align: center;">📖 GAME RULE</div>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">รายละเอียดและวิธีการเล่น:</h3>
          <p>• ผู้เล่น 2-5 คน</p>
          <p>• เริ่มต้น: ทุกคนจะมี 6 ♥</p>
          <p>• เริ่มเทิร์น: มีการ์ด 5 ใบ (ไม่มีการจั่วเพิ่มนอกจากออก Action)</p>
          <p>• อีเวนต์: ทั้ง 19 สุ่มให้ในแต่ละเทิร์น</p>
          <p>• การแข่ง: สุ่มระหว่าง Vocal, Dance, Visual</p>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">ขั้นตอนการเล่น:</h3>
          <p>1. เลือกการ์ด 1 ใบที่ต้องการเล่น</p>
          <p>2. เลือก Action ที่ต้องการทำ:</p>
          <p style="margin-left: 20px;">• Action 1 สุ่มกาชา: ได้ 1 ใบแต่คะแนน -5</p>
          <p style="margin-left: 20px;">• Action 2 ใช้สกิล: ติด CD 2 เทิร์น</p>
          <p style="margin-left: 20px;">• Action 3 แข่งตรงๆ: วัดคะแนน</p>
          <p style="margin-left: 20px;">• Action 4 ถอยหนี: เสีย ♥ 1 แต่ไม่เสียการ์ด</p>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">การคำนวนคะแนน:</h3>
          <p><strong>Vocal Battle:</strong> Vocal×2 + Dance×1.5 + Visual×1 + เงื่อนไขพิเศษ</p>
          <p><strong>Rhythm Clash:</strong> Dance×2 + Visual×1.5 + Vocal×1 + เงื่อนไขพิเศษ</p>
          <p><strong>Stage Charm:</strong> Visual×2 + Vocal×1.5 + Dance×1 + เงื่อนไขพิเศษ</p>
          
          <h3 style="color: #00d2ff; font-size: 1.2rem; margin-top: 20px;">วิธีชนะ:</h3>
          <p>• ผู้ชนะ: มีพลังใจเหลือเป็นคนสุดท้าย</p>
          <p>• ผู้แพ้: การ์ดหมดมือ หรือ พลังใจหมด</p>
          <p>• เสมอ: แพ้พร้อมกัน</p>
          
          <div style="text-align: center; margin-top: 30px;">
            <button style="padding: 10px 24px; font-size: 1rem; background: linear-gradient(135deg, #ff6b6b, #ff8787); border: none; color: white; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: all 0.3s;">×</button>
          </div>
        </div>
      `;
      
      modal.innerHTML = gameRuleContent;
      document.body.appendChild(modal);
      
      // Add close functionality
      const closeBtn = modal.querySelector('button');
      closeBtn.onclick = () => modal.remove();
    }

    // ✅ Modal: SKILL INFO (Skills)
    function showSkillInfoModal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center;
        z-index: 2000;
      `;
      
      const skillsContent = currentLang === 'en' ? `
        <div style="background: linear-gradient(145deg, rgba(5, 15, 43, 0.95), rgba(12, 34, 86, 0.9)); border: 2px solid #ff6b6b; border-radius: 20px; padding: 30px; max-width: 700px; max-height: 85vh; overflow-y: auto; color: #00ff88; box-shadow: 0 0 50px rgba(255, 107, 107, 0.5);">
          <div style="font-size: 2rem; font-weight: bold; color: #ffd700; margin-bottom: 20px; text-align: center;">⚡ Skill Info</div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">🌊 Salt</strong><br>No skill effect
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">🛡️ Leek Shield</strong><br>No ♥ loss this turn
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">💪 Never Give Up</strong><br>+2 Willpower
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">🎤 Golden Microphone</strong><br>+5 Vocal
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">🔥 Feet of Fire</strong><br>+5 Dance
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">💄 Makeup Shop Visit</strong><br>+5 Visual
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ff6b6b; border-radius: 5px;">
              <strong style="color: #ff6b6b;">📵 Mic Power Cut</strong><br>Enemy -5 Vocal
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ff6b6b; border-radius: 5px;">
              <strong style="color: #ff6b6b;">❄️ Freeze Spell</strong><br>Enemy -5 Dance
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ff6b6b; border-radius: 5px;">
              <strong style="color: #ff6b6b;">🍌 Banana Slip</strong><br>Enemy -5 Visual
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px;">
              <strong style="color: #ffd700;">🎲 Fate Control</strong><br>Change Event (except special)
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px;">
              <strong style="color: #ffd700;">👻 Hidden Skill</strong><br>Block Enemy Skill
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px;">
              <strong style="color: #ffd700;">🎰 Gacha God</strong><br>Draw 2 Cards
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px; grid-column: 1/3;">
              <strong style="color: #ffd700;">✨ Divine Card</strong><br>Revive + 10 Cards (♥=0)
            </div>
          </div>
          
          <div style="text-align: center; margin-top: 30px;">
            <button style="padding: 10px 24px; font-size: 1rem; background: linear-gradient(135deg, #ff6b6b, #ff8787); border: none; color: white; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: all 0.3s;">×</button>
          </div>
        </div>
      ` : currentLang === 'ja' ? `
        <div style="background: linear-gradient(145deg, rgba(5, 15, 43, 0.95), rgba(12, 34, 86, 0.9)); border: 2px solid #ff6b6b; border-radius: 20px; padding: 30px; max-width: 700px; max-height: 85vh; overflow-y: auto; color: #00ff88; box-shadow: 0 0 50px rgba(255, 107, 107, 0.5);">
          <div style="font-size: 2rem; font-weight: bold; color: #ffd700; margin-bottom: 20px; text-align: center;">⚡ チートシート - 13スキル</div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">🌊 塩</strong><br>スキル効果なし
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">🛡️ ネギ盾</strong><br>このターン♥ダメージなし
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">💪 絶対に諦めない</strong><br>+2 ウィルパワー
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">🎤 ゴールデンマイク</strong><br>+5 ボーカル
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">🔥 炎の足</strong><br>+5 ダンス
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">💄 メイクショップ訪問</strong><br>+5 ビジュアル
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ff6b6b; border-radius: 5px;">
              <strong style="color: #ff6b6b;">📵 マイク停止</strong><br>敵 -5 ボーカル
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ff6b6b; border-radius: 5px;">
              <strong style="color: #ff6b6b;">❄️ 凍結魔法</strong><br>敵 -5 ダンス
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ff6b6b; border-radius: 5px;">
              <strong style="color: #ff6b6b;">🍌 バナナスリップ</strong><br>敵 -5 ビジュアル
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px;">
              <strong style="color: #ffd700;">🎲 運命操作</strong><br>イベント変更（特殊除く）
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px;">
              <strong style="color: #ffd700;">👻 隠しスキル</strong><br>敵スキルをブロック
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px;">
              <strong style="color: #ffd700;">🎰 ガチャの神</strong><br>2枚ドロー
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px; grid-column: 1/3;">
              <strong style="color: #ffd700;">✨ 神カード</strong><br>復活 + 10枚ドロー (♥=0)
            </div>
          </div>
          
          <div style="text-align: center; margin-top: 30px;">
            <button style="padding: 10px 24px; font-size: 1rem; background: linear-gradient(135deg, #ff6b6b, #ff8787); border: none; color: white; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: all 0.3s;">×</button>
          </div>
        </div>
      ` : `
        <div style="background: linear-gradient(145deg, rgba(5, 15, 43, 0.95), rgba(12, 34, 86, 0.9)); border: 2px solid #ff6b6b; border-radius: 20px; padding: 30px; max-width: 700px; max-height: 85vh; overflow-y: auto; color: #00ff88; box-shadow: 0 0 50px rgba(255, 107, 107, 0.5);">
          <div style="font-size: 2rem; font-weight: bold; color: #ffd700; margin-bottom: 20px; text-align: center;">⚡ Skill Info</div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">🌊 เกลือ</strong><br>ไม่มีเอฟเฟกต์
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">🛡️ โล่แห่งต้นหอม</strong><br>ไม่เสีย ♥ เทิร์นนี้
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">💪 ไม่ยอมแพ้</strong><br>+2 พลังใจ
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">🎤 ไมค์ทองคำ</strong><br>+5 Vocal
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">🔥 ขาเทพไฟเราะ</strong><br>+5 Dance
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #00d2ff; border-radius: 5px;">
              <strong style="color: #00d2ff;">💄 ไปร้านแต่งหน้า</strong><br>+5 Visual
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ff6b6b; border-radius: 5px;">
              <strong style="color: #ff6b6b;">📵 ไฟดับไมค์ดับ</strong><br>ศัตรู -5 Vocal
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ff6b6b; border-radius: 5px;">
              <strong style="color: #ff6b6b;">❄️ พื้นน้ำแข็งสุดลื่นปื้น</strong><br>ศัตรู -5 Dance
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ff6b6b; border-radius: 5px;">
              <strong style="color: #ff6b6b;">🍌 ลื่นกล้วยกลางเวที</strong><br>ศัตรู -5 Visual
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px;">
              <strong style="color: #ffd700;">🎲 โชคชะตาข้าลิขิต</strong><br>เปลี่ยนอีเวนต์ ยกเว้นพิเศษ
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px;">
              <strong style="color: #ffd700;">👻 ไม่บอก</strong><br>Block Skill ของศัตรู
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px;">
              <strong style="color: #ffd700;">🎰 เทพกาชา</strong><br>ดึง 2 Card
            </div>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-left: 3px solid #ffd700; border-radius: 5px; grid-column: 1/3;">
              <strong style="color: #ffd700;">✨ ใบเทพ</strong><br>ชุบชีวิต + ดึง 10 Card (♥=0)
            </div>
          </div>
          
          <div style="text-align: center; margin-top: 30px;">
            <button style="padding: 10px 24px; font-size: 1rem; background: linear-gradient(135deg, #ff6b6b, #ff8787); border: none; color: white; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: all 0.3s;">×</button>
          </div>
        </div>
      `;
      
      modal.innerHTML = skillsContent;
      document.body.appendChild(modal);
      
      // Add close functionality
      const closeBtn = modal.querySelector('button');
      closeBtn.onclick = () => modal.remove();
    }

    function renderHand(hand) {
      const container = document.getElementById('hand');
      container.innerHTML = '';
      
      if (!hand || hand.length === 0) {
        container.innerHTML = '<div style="color:#aaa; padding: 20px;">ไม่มีการ์ดในมือนะ</div>';
        return;
      }

      hand.forEach((card, i) => {
        const div = document.createElement('div');
        div.className = 'card';
        
        const cardId = String(card.id).padStart(3, '0');
        const cardImageUrl = `/assets/images/cards/${cardId}.png`;
        
        const img = document.createElement('img');
        img.src = cardImageUrl;
        img.alt = `Card ${cardId}`;
        img.className = 'card-image';
        img.style.border = 'none';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '12px';
        img.onerror = function() { 
          this.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'; 
        };
        
        div.appendChild(img);
        
        div.onclick = () => {
          showCardDetail(card);
          selectCard(card, div);
        };
        
        container.appendChild(div);
      });
      
      // ✅ ถ้า playCardPhase เปิดอยู่ ให้แสดงการ์ดใน phase ด้วย
      const phaseElement = document.getElementById('playCardPhase');
      if (phaseElement && phaseElement.classList.contains('show')) {
        renderCardsInPhase(hand);
      }
    }
    
    function renderCardsInPhase(hand) {
      const phaseContainer = document.getElementById('phaseHandContainer');
      if (!phaseContainer) return;
      
      phaseContainer.innerHTML = '';
      
      hand.forEach((card, i) => {
        const div = document.createElement('div');
        div.className = 'card';
        div.style.marginLeft = '0';
        div.style.flex = '0 0 110px';
        div.style.width = '110px';
        div.style.minWidth = '110px';
        div.style.flexShrink = '0';
        
        const cardId = String(card.id).padStart(3, '0');
        const cardImageUrl = `/assets/images/cards/${cardId}.png`;
        
        const img = document.createElement('img');
        img.src = cardImageUrl;
        img.alt = `Card ${cardId}`;
        img.className = 'card-image';
        img.style.border = 'none';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '12px';
        img.onerror = function() { 
          this.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'; 
        };
        
        div.appendChild(img);
        
        div.addEventListener('click', (e) => {
          // ถ้าผู้ใช้ drag scroll ไป ให้ไม่ trigger click
          if (e.detail === 0) return;
          
          showCardPreview(card);
          selectCardInPhase(card, div);
        }, { capture: false });
        
        phaseContainer.appendChild(div);
      });
    }
    
    function selectCardInPhase(card, element) {
      // เอา border ออกจากการ์ดทั้งหมด
      document.querySelectorAll('#phaseHandContainer .card').forEach(c => {
        c.style.border = 'none';
        c.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.5)';
      });
      
      // เพิ่ม border สีทองให้การ์ดที่เลือก
      element.style.border = '3px solid #ffd700';
      element.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.8), 0 4px 15px rgba(0, 0, 0, 0.5)';
      
      gameState.myCard = card;
      document.getElementById('confirmCard').classList.add('show');
    }

    function showCardDetail(card) {
      const preview = document.getElementById('cardDetailPreview');
      const image = document.getElementById('previewCardImage');
      const info = document.getElementById('previewCardInfo');
      
      const cardId = String(card.id).padStart(3, '0');
      const cardImageUrl = `/assets/images/cards/${cardId}.png`;
      
      image.style.backgroundImage = `url('${cardImageUrl}')`;
      
      const typeEmojis = { 'happy': '😊', 'love': '💖', 'hope': '✨' };
      const translatedSkill = translateSkillName(card.skill);
      
      // ✅ Display card stats normally
      let displayVocal = card.vocal;
      let displayDance = card.dance;
      let displayVisual = card.visual;
      
      // ✅ Translate character name
      const translatedCharName = translateCharacterName(card.character);
      
      info.innerHTML = `
        <div style="font-weight: bold; color: #ffd700; font-size: 1.1rem; margin-bottom: 5px;">${translatedCharName}</div>
        <div style="margin-bottom: 3px;">${typeEmojis[card.type] || '?'} ${(card.type || '?').toUpperCase()}</div>
        <div style="font-size: 0.8rem; color: #aaa; margin-bottom: 5px;">Rarity: ${card.rarity}</div>
        <div style="font-size: 0.8rem; color: #00d2ff; margin-bottom: 8px;">✨ ${translatedSkill}</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; font-size: 1.1rem;">
          <div style="background: rgba(255,107,157,0.3); padding: 8px; border-radius: 5px; text-align: center;">🎤<br><strong style="font-size: 1.3rem;">${displayVocal}</strong></div>
          <div style="background: rgba(0,212,255,0.3); padding: 8px; border-radius: 5px; text-align: center;">💃<br><strong style="font-size: 1.3rem;">${displayDance}</strong></div>
          <div style="background: rgba(255,215,0,0.3); padding: 8px; border-radius: 5px; text-align: center;">✨<br><strong style="font-size: 1.3rem;">${displayVisual}</strong></div>
        </div>
      `;
      
      preview.style.display = 'block';
    }

    function hideCardDetail() {
      const preview = document.getElementById('cardDetailPreview');
      preview.style.display = 'none';
    }

    function selectCard(card, element) {
      // เอา border ออกจากการ์ดทั้งหมด
      document.querySelectorAll('#hand .card').forEach(c => {
        c.style.border = 'none';
        c.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.5)';
      });
      
      // เพิ่ม border สีทองให้การ์ดที่เลือก
      element.style.border = '3px solid #ffd700';
      element.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.8), 0 4px 15px rgba(0, 0, 0, 0.5)';
      
      gameState.myCard = card;
      document.getElementById('confirmCard').classList.add('show');
    }

    function showError(msg) {
      const err = document.createElement('div');
      err.className = 'error-message';
      err.textContent = msg;
      document.body.appendChild(err);
      setTimeout(() => err.remove(), 3000);
    }

    // ==================== UTILITY FUNCTIONS ====================
    function formatScore(score) {
      // แสดง decimal เฉพาะตอน .5 เท่านั้น (ไม่แสดง .0)
      const decimal = score % 1;
      console.log(`[formatScore] score=${score}, decimal=${decimal}, result=${decimal === 0.5 ? score.toFixed(1) : Math.floor(score).toString()}`);
      if (decimal === 0.5) {
        return score.toFixed(1);
      }
      return Math.floor(score).toString();
    }

    // ==================== SOCKET EVENTS ====================
    socket.on('connect', () => {
      console.log('[SPA] ✅ Connected:', socket.id);
      showLobby();
    });

    socket.on('roomCreated', ({ code, playerId, name }) => {
      console.log('[SPA] roomCreated:', code);
      gameState.roomCode = code;
      gameState.playerId = playerId || gameState.playerId;
      gameState.playerName = name || gameState.playerName;
      gameState.isHost = true;
      document.getElementById('displayCode').textContent = code;
      document.getElementById('roomCodeShare').style.display = 'block';
      document.getElementById('roomCode').style.display = 'none';
    });

    socket.on('joined', ({ code, playerId, name }) => {
      console.log('[SPA] joined:', code);
      gameState.roomCode = code;
      if (playerId) {
        gameState.playerId = playerId;
      }
      if (name) {
        gameState.playerName = name;
      }
      gameState.isHost = false;
    });

    socket.on('updateLobby', (data) => {
      console.log('[SPA] updateLobby:', data);
      gameState.lobbyMeta = data;
      gameState.players = data.players;
      updateLobbyUI(data);
    });

    socket.on('kicked', ({ message }) => {
      const defaultMsg = currentLang === 'en'
        ? 'You were removed by the host.'
        : currentLang === 'ja'
          ? 'ホストに退出させられました。'
          : 'คุณถูกโฮสต์เตะออกจากห้อง';
      alert(message || defaultMsg);
      location.href = '/';
    });

    socket.on('gameStarted', (data) => {
      console.log('[SPA] gameStarted:', data);
      console.log('[i18n-game] Current language:', currentLang);
      gameState.turn = data.turn || 1;
      gameState.players = data.players || [];
      gameState.playedCards = {};
      
      // ซ่อนหน้าจอผลลัพธ์เก่า
      document.getElementById('resultOverlay').classList.remove('show');
      const slotOverlay = document.getElementById('slotOverlay');
      if (slotOverlay) {
        slotOverlay.style.display = 'none';
      }
      
      // ✅ รับการ์ดเริ่มต้น (แบบเก่า - ถ้า server ส่งมา)
      if (data.hand && Array.isArray(data.hand)) {
        gameState.hand = data.hand;
        console.log('[SPA] Received starting hand:', data.hand.length, 'cards');
      }
      
      showGame();
      updateTableDisplay();
      updatePageLanguage(); // ✅ Update language on game start
      
      // แสดงการ์ดที่ได้รับ
      if (gameState.hand && gameState.hand.length > 0) {
        renderHand(gameState.hand);
      }
      
      console.log('[SPA] ✅ Game started, waiting for initial hand draw...');
    });

    // ✅ เริ่มเกม - จั่วการ์ด 5 ใบทีละใบพร้อมแอนิเมชั่น
    socket.on('initialHandDraw', async (data) => {
      console.log('[SPA] 🎴 Initial hand draw:', data.cards.length, 'cards');
      
      // ✅ หยุด timer เก่าทั้งหมด
      clearInterval(_countdownInterval);
      
      // ✅ รีเซ็ต gameState ทั้งหมด
      gameState.turn = data.turn || 1;
      gameState.players = data.players || [];
      gameState.hand = [];
      gameState.playedCards = {};
      gameState.myCard = null;  // ✅ Clear การ์ดที่เลือกเก่า
      gameState.myAction = null;  // ✅ Clear action เก่า
      
      // ✅ ซ่อน UI เก่าทั้งหมด
      document.getElementById('resultOverlay').classList.remove('show');
      document.getElementById('playCardPhase').classList.remove('show');
      hideActionPhaseOverlay();
      const slotOverlay = document.getElementById('slotOverlay');
      if (slotOverlay) {
        slotOverlay.style.display = 'none';
      }
      
      showGame();
      updateTableDisplay();
      
      // จั่วการ์ดทีละใบพร้อมแอนิเมชั่น
      const handContainer = document.getElementById('hand');
      for (const card of data.cards) {
        gameState.hand.push(card);
        const animPromise = animateDrawCard(handContainer, card);
        await new Promise(resolve => setTimeout(resolve, 450)); // รอให้ลอยมาครึ่งทาง
        renderHand(gameState.hand); // ✅ แสดงการ์ดตอนลอยมาถึง
        await animPromise; // รอให้ animation เสร็จ
        await new Promise(resolve => setTimeout(resolve, 150)); // delay ก่อนใบถัดไป
      }
      
      console.log('[SPA] ✅ Initial hand complete, waiting for event slot...');
    });

    // ✅ Gacha God - จั่วการ์ด 2 ใบพร้อมแอนิเมชั่น
    socket.on('gachaGodDraw', async (data) => {
      console.log('[SPA] 🎰 Gacha God draw:', data.cards.length, 'cards');
      const handContainer = document.getElementById('hand');
      for (const card of data.cards) {
        gameState.hand.push(card);
        await animateDrawCard(handContainer, card);
        await new Promise(resolve => setTimeout(resolve, 500)); // 0.5 วินาที/ใบ
      }
      renderHand(gameState.hand);
      console.log('[SPA] ✅ Gacha God complete!');
    });

    // ✅ Divine Card Revival - จั่วการ์ด 10 ใบพร้อมแอนิเมชั่น
    socket.on('divineCardRevive', async (data) => {
      console.log('[SPA] ✨ Divine Card Revival:', data.cards.length, 'cards');
      const handContainer = document.getElementById('hand');
      for (const card of data.cards) {
        gameState.hand.push(card);
        await animateDrawCard(handContainer, card);
        await new Promise(resolve => setTimeout(resolve, 500)); // 0.5 วินาที/ใบ
      }
      renderHand(gameState.hand);
      console.log('[SPA] ✅ Divine Card Revival complete!');
    });

    // ✅ เฟสสุ่มอีเวนต์ (Slot Machine)
    socket.on('eventSlotStart', (data) => {
      console.log('[SPA] 🎰 Event slot starting...', data);
      startLoopSound('slotSpin');
      showEventSlotMachine(data.duration, data.finalEvent); // ✅ ส่งผลลัพธ์จริงไปด้วย
    });

    socket.on('eventSlotResult', (data) => {
      console.log('[SPA] 🎲 Event revealed:', data.event);
      stopLoopSound('slotSpin');
      gameState.event = data.event;
      gameState.revealCards = data.event.effect === 'reveal_cards';
      showEventResult(data.event);
      updateTableDisplay();
    });

    // ✅ เฟสสุ่มการแข่ง (Slot Machine)
    socket.on('competitionSlotStart', (data) => {
      console.log('[SPA] 🎰 Competition slot starting...', data);
      startLoopSound('slotSpin');
      showCompetitionSlotMachine(data.duration, data.finalCompetition); // ✅ ส่งผลลัพธ์จริงไปด้วย
    });

    socket.on('competitionSlotResult', (data) => {
      console.log('[SPA] 📍 Competition revealed:', data.competition);
      stopLoopSound('slotSpin');
      gameState.competition = data.competition;
      
      // ✅ ถ้า skipSlot = true (อีเวนต์รายการปริศนา) แสดงผลทันทีโดยไม่มีสลอต
      if (data.skipSlot) {
        console.log('[SPA] ❓ รายการปริศนา - ข้ามสลอตแข่งขัน');
        showCompetitionResult(data.competition);
      } else {
        showCompetitionResult(data.competition);
      }
      
      updateTableDisplay(); // อัพเดทการแสดงผล
    });

    // ✅ เฟสหงายการ์ด
    socket.on('revealCardsPhase', (data) => {
      console.log('[SPA] 🎴 Revealing cards...', data);
      console.log('[DEBUG] skillEffects:', data.skillEffects);
      console.log('[DEBUG] skillEffects length:', data.skillEffects ? data.skillEffects.length : 'undefined');
      
      // ✅ หงายการ์ดบนโต๊ะแทนแสดงป็อปอัพ
      revealAllCards();
      playSound('cardReveal');
      
      // ✅ แสดงสกิลเอฟเฟคหลังหงายการ์ด 3 วินาที
      if (data.skillEffects && data.skillEffects.length > 0) {
        console.log('[DEBUG] Will show skill effects in 3 seconds...');
        setTimeout(() => {
          console.log('[DEBUG] Showing skill effects NOW!');
          showSkillEffects(data.skillEffects);
        }, 3000);
      } else {
        console.log('[DEBUG] No skill effects to show');
      }
    });

    // ✅ สำหรับโหนเซไก - แสดงสกิลโดยไม่ต้องหงายการ์ด
    socket.on('showSkillEffectsOnly', (data) => {
      console.log('[SPA] 💫 Showing skill effects (no reveal)...', data);
      revealAllCards();
      if (data.skillEffects && data.skillEffects.length > 0) {
        showSkillEffects(data.skillEffects);
      }
    });

    socket.on('newTurn', (data) => {
      console.log('[SPA] newTurn received:', data);
      gameState.turn = data.turn || gameState.turn;
      // ❌ ไม่ต้องอัพเดท event/competition จาก newTurn เพราะได้จากสล็อตแล้ว
      // gameState.event = data.event || null;
      // gameState.competition = data.competition || null;
      gameState.players = data.players || gameState.players;
      gameState.myCard = null;
      gameState.myAction = null;
      gameState.playedCards = {};
      gameState.actionCooldown = data.actionCooldown || 0;

      document.getElementById('turnNumber').textContent = gameState.turn;
      
      // ✅ ตรวจสอบว่าผู้เล่นแพ้หรือยัง และแสดงโหมดดูเกม
      const me = gameState.players.find(p => p.name === gameState.playerName);
      const spectatorMode = document.getElementById('spectatorMode');
      if (me && (me.heart <= 0 || me.handCount <= 0)) {
        spectatorMode.style.display = 'block';
        console.log('[SPA] 💀 Player eliminated - spectator mode active');
      } else {
        spectatorMode.style.display = 'none';
      }
      
      // ❌ ไม่ต้อง updateTableDisplay ที่นี่ เพราะจะทำใน eventSlotResult และ competitionSlotResult แล้ว
      // updateTableDisplay();

      if (data.hand && Array.isArray(data.hand)) {
        console.log('[SPA] Received hand with', data.hand.length, 'cards');
        gameState.hand = data.hand;
        renderHand(gameState.hand);
      } else {
        console.warn('[SPA] No hand data in newTurn');
      }

      // ✅ ข้าม eventRevealPhase ถ้าเป็น Mikudayo (เพราะจะมีเฟสจั่วการ์ดแยกต่างหาก)
      if (data.isMikudayo) {
        console.log('[SPA] 🎁 Mikudayo event - skipping eventRevealPhase, starting playCard phase');
        // ไม่เรียก startEventRevealPhase() - เพราะจั่วการ์ดไปแล้ว
        startPlayCardPhase(); // ✅ เรียก startPlayCardPhase ทันที
      } else {
        startEventRevealPhase();
      }
    });

    socket.on('allPlayedCards', (data) => {
      console.log('[SPA] allPlayedCards:', data);
      if (data.playedCards) {
        gameState.playedCards = data.playedCards;
      }
      
      // ✅ เก็บ event data เพื่อใช้ใน updateTableDisplay
      if (data.event) {
        gameState.event = data.event;
      }
      
      updateTableDisplay();
      setTimeout(() => {
        startActionPhase();
      }, 1000);
    });

    socket.on('gameOver', (data) => {
      console.log('[SPA] 🏆 GAME OVER:', data);
      clearInterval(_countdownInterval);
      hideActionPhaseOverlay();
      document.getElementById('playCardPhase').classList.remove('show');
      
      // แสดงหน้าจอจบเกม
      const overlay = document.getElementById('slotOverlay');
      if (overlay) {
        let html = '<div class="slot-container"><div class="slot-machine">';
        
        if (data.isDraw) {
          html += `
            <div style="font-size: 3rem; color: #ffd700; margin: 20px 0;">🤝</div>
            <div style="font-size: 2rem; color: #fff; margin: 20px 0;">เสมอ!</div>
            <div style="font-size: 1.2rem; color: #aaa; margin: 10px 0;">ทุกคนแพ้พร้อมกัน</div>
          `;
        } else {
          html += `
            <div style="font-size: 3rem; color: #ffd700; margin: 20px 0;">🏆</div>
            <div style="font-size: 2.5rem; color: #00ff88; margin: 20px 0;">${data.winnerName}</div>
            <div style="font-size: 1.5rem; color: #fff; margin: 10px 0;">ชนะเกม!</div>
          `;
        }
        
        if (data.reason === 'shrimp_curse') {
          html += `<div style="font-size: 1rem; color: #ff6b6b; margin: 10px 0;">🦐 อีเวนต์กุ้ง</div>`;
        }
        
        html += '</div></div>';
        overlay.innerHTML = html;
        overlay.style.display = 'flex';
        
        // ✅ Auto กลับ lobby หลัง 5 วินาที
        setTimeout(() => {
          overlay.style.display = 'none';
          showLobby();
        }, 5000);
      }
    });

    socket.on('turnResult', (result) => {
      console.log('[SPA] turnResult:', result);
      clearInterval(_countdownInterval);
      hideActionPhaseOverlay();
      
      // ซ่อน slot overlay
      const slotOverlay = document.getElementById('slotOverlay');
      if (slotOverlay) {
        slotOverlay.style.display = 'none';
      }
      
      document.getElementById('resultOverlay').classList.add('show');
      
      // ❌ ไม่แสดงสกิลที่นี่ เพราะแสดงไปแล้วใน revealCardsPhase
      
      // ==================== PHASE 1: Show Revealed Cards (SKIP - ไม่ใช้แล้ว) ====================
      // ❌ ลบป็อปอัพ revealedCards เพราะหงายการ์ดไปแล้วตอนลงการ์ด
      const revealedSection = document.getElementById('revealedCardsSection');
      if (revealedSection) {
        revealedSection.style.display = 'none';
      }
      
      // Initially hide score boxes
      document.getElementById('playersScoreGrid').style.display = 'none';
      document.getElementById('winnerAnnouncement').style.display = 'none';
      
      // ==================== PHASE 2: Show Results after 1.5 seconds ====================
      setTimeout(() => {
        // Hide revealed cards
        document.getElementById('revealedCardsSection').style.display = 'none';
        
        // Show score boxes
        document.getElementById('playersScoreGrid').style.display = 'grid';
        document.getElementById('winnerAnnouncement').style.display = 'block';
        
        // ✅ Create score map from actionResults
        const scoreMap = {};
        if (result.actionResults && result.actionResults.length > 0) {
          result.actionResults.forEach(ar => {
            scoreMap[ar.name] = ar.score;
          });
        }
        
        console.log('[SPA] scoreMap:', scoreMap);
        
        // Build player score boxes
        const playersScoreGrid = document.getElementById('playersScoreGrid');
        playersScoreGrid.innerHTML = '';
        
        // ✅ Reset gameOverMessage div at the start
        const gameOverDiv = document.getElementById('gameOverMessage');
        gameOverDiv.style.display = 'none';
        gameOverDiv.innerHTML = '';
        
        (result.players || gameState.players || []).forEach(player => {
          const thisRoundScore = scoreMap[player.name] || 0;
          console.log(`[SPA] ${player.name}: ${thisRoundScore} pts`);
          
          const scoreLabel = currentLang === 'ja' ? 'ポイント' : currentLang === 'en' ? 'Points' : 'คะแนน';
          const box = document.createElement('div');
          box.className = 'player-score-box';
          box.innerHTML = `
            <div class="player-score-name">${player.name}</div>
            <div class="player-score-hearts">${'♥'.repeat(player.heart || 0)}</div>
            <div class="player-score-points">${formatScore(thisRoundScore)} ${scoreLabel}</div>
          `;
          playersScoreGrid.appendChild(box);
        });
        
        // Show winner announcement for this turn
        const announcementDiv = document.getElementById('winnerAnnouncement');
        const noWinnerText = currentLang === 'ja' ? '勝者なし' : currentLang === 'en' ? 'No Winner' : 'ไม่มีผู้ชนะ';
        const scoreLabel = currentLang === 'ja' ? 'ポイント' : currentLang === 'en' ? 'Points' : 'คะแนน';
        announcementDiv.innerHTML = `
          <div class="turn-winner">🏆 ${result.winnerName || noWinnerText}</div>
          <div class="turn-winner-score">${formatScore(result.winnerScore || 0)} ${scoreLabel}</div>
        `;
        
        // Check if game is over
        if (result.gameOver === true) {
          gameOverDiv.style.display = 'block';
          
          console.log(`🏆 [GAME OVER] Winner: ${result.winnerNameFinal}, Draw: ${result.isDraw}`);
          
          // ✅ แสดงผลการเสมอหรือผู้ชนะ
          const drawText = currentLang === 'ja' ? 'ゲーム引き分け！' : currentLang === 'en' ? 'Game Draw!' : 'เกมเสมอ!';
          const playersText = currentLang === 'ja' ? 'プレイヤー' : currentLang === 'en' ? 'Players' : 'ผู้เล่น';
          const winnerText = currentLang === 'ja' ? 'ゲームの勝者です！' : currentLang === 'en' ? 'is the Game Winner!' : 'เป็นผู้ชนะเกม!';
          
          if (result.isDraw === true) {
            gameOverDiv.innerHTML = `
              <div class="final-winner-text">🤝 ${drawText}</div>
              <div class="draw-players-text">${playersText}: ${result.drawPlayers.join(', ')}</div>
            `;
          } else if (result.winnerNameFinal) {
            gameOverDiv.innerHTML = `
              <div class="final-winner-text">🎉 ${result.winnerNameFinal} ${winnerText} 🎉</div>
            `;
          }
          
          // ✅ Auto กลับ lobby หลัง 5 วินาที
          setTimeout(() => {
            showLobby();
          }, 5000);
        } else {
          // Auto proceed to next turn after 3 more seconds
          setTimeout(() => {
            document.getElementById('resultOverlay').classList.remove('show');
          }, 3000);
        }
      }, 1500);

      gameState.players = result.players || gameState.players;
      // ❌ ไม่ update ที่นี่ เพราะจะ update หลัง returnCards animation แทน
    });

    // ==================== DECK ANIMATION LISTENERS ====================
    socket.on('returnCards', async (data) => {
      console.log('[SPA] 📤 Returning cards to deck...', data);
      
      // แสดง animation คืนการ์ดของทุกคน (จาก player area)
      if (data.playedCards && data.playedCards.length > 0) {
        for (const pc of data.playedCards) {
          // หา element การ์ดที่วางใน player area
          const playerAreas = document.querySelectorAll('.player-area .card');
          let cardElement = null;
          
          // หาการ์ดที่มี data-player ตรงกับชื่อผู้เล่น
          for (const card of playerAreas) {
            if (card.dataset && card.dataset.player === pc.playerName) {
              cardElement = card;
              break;
            }
          }
          
          if (cardElement) {
            console.log(`[ANIM] Returning card from ${pc.playerName}`);
            await animateReturnCard(cardElement);
          } else {
            console.log(`[ANIM] Card element not found for ${pc.playerName}, using fallback`);
            // fallback: ใช้การ์ดใบแรกที่เจอ
            if (playerAreas.length > 0) {
              await animateReturnCard(playerAreas[0]);
            }
          }
        }
      }
      
      // ✅ Clear played cards หลังแอนิเมชั่นเสร็จ
      gameState.playedCards = {};
      updateTableDisplay();
      
      console.log('[SPA] ✅ All cards returned to deck');
    });

    socket.on('drawCards', async (data) => {
      console.log('[SPA] 🎴 Drawing cards...', data);
      
      // เพิ่มการ์ดเข้ามือพร้อม animation
      if (data.cards && data.cards.length > 0) {
        for (let i = 0; i < data.cards.length; i++) {
          // เพิ่มการ์ดเข้า gameState ก่อน
          gameState.hand.push(data.cards[i]);
          
          // Render มือเพื่อสร้าง element การ์ดใหม่
          renderHand(gameState.hand);
          
          // หา element การ์ดที่เพิ่งสร้างใหม่ (ใบสุดท้าย)
          const handElement = document.getElementById('hand');
          const lastCard = handElement.lastElementChild;
          
          if (lastCard) {
            console.log(`[ANIM] Drawing card ${i+1}/${data.cards.length}: ${data.cards[i].character}`);
            // ซ่อนการ์ดก่อน แล้วค่อยแสดง animation
            lastCard.style.opacity = '0';
            await animateDrawCard(lastCard, data.cards[i]);
            lastCard.style.opacity = '1';
          }
        }
        
        console.log('[SPA] ✅ Drew', data.cards.length, 'cards -', data.reason);
      }
    });

    socket.on('error', (msg) => {
      console.error('[SPA] server error:', msg);
      showError('❌ ' + msg);
    });

    socket.on('disconnect', (reason) => {
      console.warn('[SPA] disconnected:', reason);
    });

    // ✅ Fate Control - เปลี่ยนอีเวนต์ใหม่
    socket.on('fateControlEventChange', (data) => {
      console.log('[SPA] 🎴 Fate Control activated:', data);
      
      // แสดงข้อความว่าใครใช้สกิล
      const overlay = document.getElementById('slotOverlay');
      if (overlay) {
        overlay.innerHTML = `
          <div class="slot-container">
            <h2 style="color: #ff00ff; font-size: 2rem; margin-bottom: 20px;">✨ Fate Control!</h2>
            <p style="color: #fff; font-size: 1.5rem; margin-bottom: 20px;">${data.player} เปลี่ยนอีเวนต์!</p>
            <h3 style="color: #ff6b6b; font-size: 1.8rem; margin: 10px 0;">❌ ${data.oldEvent.name}</h3>
            <h3 style="color: #666; font-size: 2rem; margin: 10px 0;">⬇️</h3>
            <h3 style="color: #00ff88; font-size: 1.8rem; margin: 10px 0;">✅ ${data.newEvent.name}</h3>
          </div>
        `;
        overlay.style.display = 'flex';
        
        // อัพเดต gameState
        gameState.event = data.newEvent;
        
        // ซ่อนหลัง 3 วินาที
        setTimeout(() => {
          overlay.style.display = 'none';
        }, 3000);
      }
    });

    // ==================== TRANSLATION HELPER ====================
    function translateEventName(eventNameInput) {
      if (!eventNameInput) return eventNameInput;
      
      // Map English names to Thai/JA names using EVENTS_DATA
      const eventMap = {
        "Nothing": { en: "Nothing", ja: "何もない", th: "ไม่มีอะไร" },
        "Magical Mirai": { en: "Magical Mirai", ja: "マジカルミライ", th: "Magical Mirai" },
        "School Trip": { en: "School Trip", ja: "修学旅行", th: "งานโรงเรียน" },
        "Idol Stage": { en: "Idol Stage", ja: "アイドルステージ", th: "เวทีไอดอล" },
        "Vivid Street": { en: "Vivid Street", ja: "ビビッドストリート", th: "Vivid Street" },
        "Phoenix Land": { en: "Phoenix Land", ja: "フェニックスランド", th: "Phoenix land" },
        "Social Viral": { en: "Social Viral", ja: "ソーシャルウイルス", th: "โซเซียลไวรัล" },
        "Festival": { en: "Festival", ja: "フェスティバル", th: "Festival" },
        "Gift from Mikudayo": { en: "Gift from Mikudayo", ja: "ミクダヨーからのギフト", th: "ของขวัญจาก Mikudayo" },
        "NeneRobo Crazy": { en: "NeneRobo Crazy", ja: "ネネロボ暴走", th: "NeneRobo คลั่ง" },
        "Movie Released!": { en: "Movie Released!", ja: "映画公開！", th: "มูฟวี่ฉายแล้ว!" },
        "SapphireR": { en: "SapphireR", ja: "SapphireR", th: "SapphireR" },
        "Miku VBS Cooking": { en: "Miku VBS Cooking", ja: "ミクVBS料理", th: "มิกุVBSเข้าครัว" },
        "Mystery Show!?": { en: "Mystery Show!?", ja: "謎の番組！？", th: "รายการปริศนา!?" },
        "Card Reveal": { en: "Card Reveal", ja: "セカイが開いた", th: "โหนเซไก" },
        "Shrimp Curse": { en: "Shrimp Curse", ja: "エビの呪い", th: "กุ้ง" },
        "Love Type Buff": { en: "Love Type Buff", ja: "ラブタイプバフ", th: "Type love บัฟ" },
        "Hope Type Buff": { en: "Hope Type Buff", ja: "ホープタイプバフ", th: "Type hope บัฟ" },
        "Happy Type Buff": { en: "Happy Type Buff", ja: "ハッピータイプバフ", th: "Type happy บัฟ" }
      };
      
      // Try to find the event by English name first (from server)
      let foundEvent = eventMap[eventNameInput];
      
      // If not found, try Thai name (for backward compatibility)
      if (!foundEvent) {
        for (const [enName, translations] of Object.entries(eventMap)) {
          if (translations.th === eventNameInput || translations.ja === eventNameInput) {
            foundEvent = translations;
            break;
          }
        }
      }
      
      if (foundEvent) {
        if (currentLang === 'en') return foundEvent.en;
        if (currentLang === 'ja') return foundEvent.ja;
        if (currentLang === 'th') return foundEvent.th;
      }
      
      // Fallback to original input if not found
      return eventNameInput;
    }
    
    function translateSkillName(skillName) {
      if (!skillName) return skillName;
      
      console.log('[translateSkillName] Input:', skillName, 'Lang:', currentLang, 'Translations loaded:', !!translations.skillNames);
      
      // Convert underscore to space for lookup (server sends with underscore, JSON uses space)
      const skillNameWithSpace = skillName.replace(/_/g, ' ');
      
      // For Thai and Japanese, use skillNames mapping
      if (currentLang === 'th' || currentLang === 'ja') {
        if (translations.skillNames && translations.skillNames[skillNameWithSpace]) {
          console.log('[translateSkillName] Found translation:', translations.skillNames[skillNameWithSpace]);
          return translations.skillNames[skillNameWithSpace];
        } else {
          console.warn('[translateSkillName] No translation found for:', skillNameWithSpace, 'Available keys:', Object.keys(translations.skillNames || {}));
        }
      }
      
      // For English, convert underscore to space and capitalize each word
      if (currentLang === 'en') {
        return skillNameWithSpace.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
      }
      
      // Fallback to the converted skill name
      return skillNameWithSpace;
    }
    
    function translateCharacterName(englishName) {
      if (!englishName || !translations.characters) return englishName;
      
      // If English is selected, return the English name
      if (currentLang === 'en') {
        return translations.characters[englishName] || englishName;
      }
      
      // For Thai and Japanese, both have direct mappings
      const translation = translations.characters[englishName];
      if (translation) {
        return translation;
      }
      
      // Fallback to original English name
      return englishName;
    }

    function translateEventDescription(thaiDescription) {
      if (!thaiDescription) return thaiDescription;
      if (currentLang !== 'en' && currentLang !== 'ja') return thaiDescription;

      const normalizedDescription = thaiDescription
        .trim()
        .replace(/Niko/gi, 'Niigo')
        .replace(/nilo/gi, 'Niigo');
      
      // Event descriptions translation mapping
      const eventDescriptions = {
        "ไม่มีอะไรเกิดขึ้นเลย เล่นปกติ": {
          en: "Nothing special happens. Play normally.",
          ja: "特に何も起きません。通常通りプレイしてください。"
        },
        "การ์ดสมาชิก VS คะแนนเพิ่มขึ้น 5 คะแนน": {
          en: "VS members gain +5 score.",
          ja: "VS メンバーが+5スコア獲得"
        },
        "การ์ดสมาชิก LN คะแนนเพิ่มขึ้น 5 คะแนน": {
          en: "LN members gain +5 score.",
          ja: "LN メンバーが+5スコア獲得"
        },
        "การ์ดสมาชิก MMJ คะแนนเพิ่มขึ้น 5 คะแนน": {
          en: "MMJ members gain +5 score.",
          ja: "MMJ メンバーが+5スコア獲得"
        },
        "การ์ดสมาชิก VBS คะแนนเพิ่มขึ้น 5 คะแนน": {
          en: "VBS members gain +5 score.",
          ja: "VBS メンバーが+5スコア獲得"
        },
        "การ์ดสมาชิก WxS คะแนนเพิ่มขึ้น 5 คะแนน": {
          en: "WxS members gain +5 score.",
          ja: "WxS メンバーが+5スコア獲得"
        },
        "การ์ดสมาชิก Niigo คะแนนเพิ่มขึ้น 5 คะแนน": {
          en: "Niigo members gain +5 score.",
          ja: "Niigo メンバーが+5スコア獲得"
        },
        "การ์ดระดับลิมิต/เฟส คะแนนเพิ่มขึ้น 10 คะแนน": {
          en: "Limited/Festival cards gain +10 score.",
          ja: "リミテッド/フェスティバルカードが+10スコア獲得"
        },
        "ผู้เล่นสุ่มกาชาคนละ 3 ใบ": {
          en: "Players draw 3 random cards.",
          ja: "プレイヤーが3枚ランダムにドロー"
        },
        "ค่าพลังที่เยอะที่สุดของการ์ดนั้น จะถูกลบไป": {
          en: "Highest stat of the card is nullified.",
          ja: "カードの最高ステータスが無効化される"
        },
        "ด้วยพลังของมิกุจากหนังผู้เล่นฟื้นฟูพลังใจ 1 หน่วย": {
          en: "Players recover 1 willpower.",
          ja: "プレイヤーがウィルパワー1回復"
        },
        "Kohane คะแนนเพิ่มขึ้น 30 คะแนน": {
          en: "Kohane gains +30 score.",
          ja: "小春が+30スコア獲得"
        },
        "ลบค่าพลังทุกอย่างลงอย่างละ 2 หน่วย": {
          en: "All stats reduced by 2.",
          ja: "全てのステータスが2減少"
        },
        "ไม่สุ่มการแข่งขัน แข่งรูปแบบพิเศษ ค่าพลังที่+กัน ไม่มีตัวคูณ": {
          en: "Special battle: Add stats, no multiplier.",
          ja: "特別対戦：ステータスを合算、乗数なし"
        },
        "หงายการ์ดในเทิร์นนั้น": {
          en: "Cards are revealed this turn.",
          ja: "このターンカードが公開される"
        },
        "ค่าพลังใจของผู้เล่น -1": {
          en: "Players lose 1 willpower.",
          ja: "プレイヤーがウィルパワー1喪失"
        },
        "Type love คะแนนเพิ่มขึ้น 5 คะแนน": {
          en: "Love type cards gain +5 score.",
          ja: "ラブタイプカードが+5スコア獲得"
        },
        "Type hope คะแนนเพิ่มขึ้น 5 คะแนน": {
          en: "Hope type cards gain +5 score.",
          ja: "ホープタイプカードが+5スコア獲得"
        },
        "Type happy คะแนนเพิ่มขึ้น 5 คะแนน": {
          en: "Happy type cards gain +5 score.",
          ja: "ハッピータイプカードが+5スコア獲得"
        }
      };
      
      const translation = eventDescriptions[normalizedDescription];
      if (translation) {
        return currentLang === 'ja' ? translation.ja : translation.en;
      }
      return thaiDescription;
    }

    function isMysteryCompetition(competitionName) {
      if (!competitionName) return false;
      const normalized = competitionName.toString().trim();
      return normalized === 'รายการปริศนา' || normalized === 'รายการปริศนา!?' || normalized === 'Mystery Show!?' || normalized === '謎の番組！？';
    }

    function getMysteryCompetitionLabel(variant = 'table') {
      const langKey = currentLang === 'en' ? 'en' : currentLang === 'ja' ? 'ja' : 'th';
      const labels = {
        table: {
          en: '❓ Mystery Show!? (Special Battle)',
          ja: '❓ 謎の番組!? (特別バトル)',
          th: '❓ รายการปริศนา!? (โหมดพิเศษ)'
        },
        overlay: {
          en: '❓ Mystery Show!? SPECIAL BATTLE',
          ja: '❓ 謎の番組!? 特別バトル',
          th: '❓ รายการปริศนา!? โหมดพิเศษ'
        }
      };
      return (labels[variant] && labels[variant][langKey]) || labels.table.th;
    }

    function getMysteryCompetitionHint() {
      if (currentLang === 'en') {
        return 'Stats add up. Multipliers are disabled this turn.';
      }
      if (currentLang === 'ja') {
        return 'すべてのステータスを合計。今ターンは倍率なし。';
      }
      return 'รวมค่าพลังทั้งหมด ไม่มีตัวคูณในเทิร์นนี้';
    }

    function getCompetitionLabel(competitionName, variant = 'table') {
      if (!competitionName) return '-';
      if (isMysteryCompetition(competitionName)) {
        return getMysteryCompetitionLabel(variant);
      }

      const key = competitionName.toString().toLowerCase();
      const tableLabels = {
        vocal: currentLang === 'ja' ? '🎤 ボーカルバトル' : '🎤 Vocal Battle',
        dance: currentLang === 'ja' ? '💃 リズムクラッシュ' : '💃 Rhythm Clash',
        visual: currentLang === 'ja' ? '✨ ステージチャーム' : '✨ Stage Charm'
      };

      const overlayLabels = {
        vocal: currentLang === 'ja' ? '🎤 ボーカルバトル' : '🎤 VOCAL BATTLE',
        dance: currentLang === 'ja' ? '💃 リズムクラッシュ' : '💃 RHYTHM CLASH',
        visual: currentLang === 'ja' ? '✨ ステージチャーム' : '✨ STAGE CHARM'
      };

      const map = variant === 'overlay' ? overlayLabels : tableLabels;
      return map[key] || competitionName;
    }

    // ==================== SLOT MACHINE FUNCTIONS ====================
    // Event names in Thai and English
    const EVENTS_TH = [
      "ไม่มีอะไร","Magical Mirai","งานโรงเรียน","เวทีไอดอล",
      "Vivid Street","Phoenix land","โซเซียลไวรัล","Festival",
      "ของขวัญจาก Mikudayo","NeneRobo คลั่ง","มูฟวี่ฉายแล้ว!",
      "SapphireR","มิกุVBSเข้าครัว","รายการปริศนา!?","โหนเซไก",
      "กุ้ง","Type love บัฟ","Type hope บัฟ","Type happy บัฟ"
    ];
    
    const EVENTS_EN = [
      "Nothing","Magical Mirai","School Trip","Idol Stage",
      "Vivid Street","Phoenix Land","Social Viral","Festival",
      "Gift from Mikudayo","NeneRobo Crazy","Movie Released!",
      "SapphireR","Miku VBS Cooking","Mystery Show!?","Card Reveal",
      "Shrimp Curse","Love Type Buff","Hope Type Buff","Happy Type Buff"
    ];
    
    const EVENTS_JA = [
      "何もない","マジカルミライ","修学旅行","アイドルステージ",
      "ビビッドストリート","フェニックスランド","ソーシャルウイルス","フェスティバル",
      "ミクダヨーからのギフト","ネネロボ暴走","映画公開！",
      "サファイアR","ミクVBS料理","謎の番組！？","セカイが開いた",
      "エビの呪い","ラブタイプバフ","ホープタイプバフ","ハッピータイプバフ"
    ];
    
    const EVENTS_LIST = currentLang === 'en' ? EVENTS_EN : currentLang === 'ja' ? EVENTS_JA : EVENTS_TH;

    function showEventSlotMachine(duration, finalEvent) {
      const overlay = document.getElementById('slotOverlay');
      if (!overlay) return;

      const slotTitle = currentLang === 'en' ? '🎰 Spinning Event Slot...' : currentLang === 'ja' ? '🎰 イベントスロット回転中...' : '🎰 กำลังสุ่มอีเวนต์...';
      const eventList = currentLang === 'en' ? EVENTS_EN : currentLang === 'ja' ? EVENTS_JA : EVENTS_TH;
      
      overlay.innerHTML = `
        <div class="slot-container">
          <h2 style="color: #00ff88; font-size: 2.5rem; margin-bottom: 30px;">${slotTitle}</h2>
          <div class="slot-machine">
            <div class="slot-display" id="eventSlotDisplay">???</div>
          </div>
        </div>
      `;
      overlay.style.display = 'flex';

      // Spin animation - หมุนแสดงอีเวนต์สุ่ม
      const display = document.getElementById('eventSlotDisplay');
      let spinCount = 0;
      const spinInterval = setInterval(() => {
        const randomEvent = eventList[Math.floor(Math.random() * eventList.length)];
        display.textContent = randomEvent;
        display.style.transform = `translateY(${(spinCount % 2) * 10}px)`;
        spinCount++;
      }, 100);

      // ✅ หยุดที่อีเวนต์ที่ถูกต้อง 500ms ก่อนหมดเวลา
      setTimeout(() => {
        clearInterval(spinInterval);
        if (finalEvent) {
          // Translate event name if English is selected
          const displayName = translateEventName(finalEvent.name);
          display.textContent = displayName;
          display.style.transform = 'translateY(0)';
        }
      }, duration - 500);
    }

    function showEventResult(event) {
      const overlay = document.getElementById('slotOverlay');
      if (!overlay) return;

      // Store event for later use
      gameState.currentEvent = event;

      const translatedEventName = translateEventName(event.name);
      const translatedDescription = translateEventDescription(event.description);

      overlay.innerHTML = `
        <div class="slot-result">
          <h1 style="color: #ff6b6b; font-size: 4rem; animation: popIn 0.5s;">🎉 ${translatedEventName}</h1>
          <p style="font-size: 1.8rem; margin-top: 20px; color: #fff;">${translatedDescription}</p>
        </div>
      `;
      overlay.style.display = 'flex';

      const eventInfo = document.getElementById('tableEvent');
      if (eventInfo) {
        eventInfo.textContent = `📍 ${translatedEventName}`;
      }

      const EVENT_RESULT_DURATION = 4000;
      overlayLockUntil = Date.now() + EVENT_RESULT_DURATION;

      if (overlayLockReleaseTimer) {
        clearTimeout(overlayLockReleaseTimer);
      }

      overlayLockReleaseTimer = setTimeout(() => {
        overlay.style.display = 'none';
        overlayLockUntil = 0;
        overlayLockReleaseTimer = null;
      }, EVENT_RESULT_DURATION);
    }

    function showCompetitionSlotMachine(duration, finalCompetition) {
      const overlay = document.getElementById('slotOverlay');
      if (!overlay) return;

      const now = Date.now();
      if (overlayLockUntil > now) {
        const waitTime = overlayLockUntil - now;
        setTimeout(() => {
          showCompetitionSlotMachine(duration, finalCompetition);
        }, waitTime);
        return;
      }

      const compNames = {
        'vocal': '🎤 VOCAL',
        'dance': '💃 DANCE',
        'visual': '✨ VISUAL'
      };

      const slotTitle = currentLang === 'en' ? '🎰 Spinning Competition Type...' : currentLang === 'ja' ? '🎰 対戦タイプ回転中...' : '🎰 กำลังสุ่มการแข่งขัน...';

      overlay.innerHTML = `
        <div class="slot-container">
          <h2 style="color: #00d2ff; font-size: 2.5rem; margin-bottom: 30px;">${slotTitle}</h2>
          <div class="slot-machine">
            <div class="slot-display" id="compSlotDisplay">???</div>
          </div>
        </div>
      `;
      overlay.style.display = 'flex';

      // Spin animation - หมุนแสดงการแข่งขันสุ่ม
      const display = document.getElementById('compSlotDisplay');
      const comps = ['🎤 VOCAL','💃 DANCE','✨ VISUAL'];
      let spinCount = 0;
      const spinInterval = setInterval(() => {
        const randomComp = comps[Math.floor(Math.random() * comps.length)];
        display.textContent = randomComp;
        display.style.transform = `translateY(${(spinCount % 2) * 10}px)`;
        spinCount++;
      }, 100);

      // ✅ หยุดที่การแข่งขันที่ถูกต้อง 500ms ก่อนหมดเวลา
      setTimeout(() => {
        clearInterval(spinInterval);
        if (finalCompetition) {
          display.textContent = compNames[finalCompetition];
          display.style.transform = 'translateY(0)';
        }
      }, duration - 500);
    }

    function showCompetitionResult(competition) {
      const overlay = document.getElementById('slotOverlay');
      if (!overlay) return;

      // Store competition for later use
      gameState.currentCompetition = competition;

      const competitionTitle = getCompetitionLabel(competition, 'overlay');
      const defaultResultText = currentLang === 'en' ? 'Competition Type Announced!' : currentLang === 'ja' ? '対戦タイプ発表！' : 'ประกาศประเภทการแข่งขัน!';
      const resultText = isMysteryCompetition(competition) ? getMysteryCompetitionHint() : defaultResultText;

      overlay.innerHTML = `
        <div class="slot-result">
          <h1 style="color: #ff00ff; font-size: 4rem; animation: popIn 0.5s;">${competitionTitle}</h1>
          <p style="font-size: 1.8rem; margin-top: 20px; color: #fff;">${resultText}</p>
        </div>
      `;

      // Update info display
      const competitionInfo = document.getElementById('tableCompetition');
      if (competitionInfo) {
        competitionInfo.textContent = `🏆 ${getCompetitionLabel(competition, 'table')}`;
      }

      setTimeout(() => {
        overlay.style.display = 'none';
      }, 1000);
    }

    // ✅ ฟังก์ชันหงายการ์ดบนโต๊ะ (แทนป็อปอัพ)
    function revealAllCards() {
      console.log('[REVEAL] Revealing all cards on table...');
      
      // หาการ์ดทั้งหมดที่คว่ำอยู่ (data-revealed="false")
      const cardElements = document.querySelectorAll('.card[data-revealed="false"]');
      
      cardElements.forEach(cardEl => {
        const cardId = cardEl.dataset.cardId;
        if (!cardId) return;
        
        // หาข้อมูลการ์ดจาก playedCards
        let cardData = null;
        for (const playerName in gameState.playedCards) {
          const card = gameState.playedCards[playerName];
          if (card.id === cardId) {
            cardData = card;
            break;
          }
        }
        
        if (!cardData) return;
        
        // หงายการ์ด - เปลี่ยนจาก backcard เป็นหน้าการ์ดจริง
        const cardImageUrl = `/assets/images/cards/${String(cardData.id).padStart(3, '0')}.png`;
        cardEl.style.backgroundImage = `url('${cardImageUrl}')`;
        cardEl.dataset.revealed = 'true';
        renderTableCardStats(cardEl, cardData);
        
        // เพิ่ม animation หงาย
        cardEl.style.animation = 'flipCard 0.6s ease-in-out';
      });
      
      console.log('[REVEAL] Revealed', cardElements.length, 'cards');
    }

    function showRevealedCards(playedCards) {
      const overlay = document.getElementById('slotOverlay');
      if (!overlay) return;

      const actionNames = {
        '1': '🎲 กาชา',
        '2': '⚡ สกิล',
        '3': '⚔️ แข่ง',
        '4': '🏃 หนี'
      };

      let html = '<div class="revealed-container"><h2 style="color: #ffd700; font-size: 2.5rem; margin-bottom: 30px;">🎴 การ์ดที่เล่น</h2><div class="revealed-grid">';
      
      playedCards.forEach(pc => {
        const card = pc.card;
        html += `
          <div class="revealed-card">
            <div style="font-size: 1.5rem; font-weight: bold; color: #00ff88;">${pc.playerName}</div>
            <div style="font-size: 2rem; margin: 10px 0;">${card.character}</div>
            <div style="font-size: 1rem; color: #aaa; margin: 5px 0;">🎤 ${card.vocal} | 💃 ${card.dance} | ✨ ${card.visual}</div>
            <div style="font-size: 1.2rem; color: #00d2ff; margin-top: 5px;">${actionNames[pc.action]}</div>
          </div>
        `;
      });
      
      html += '</div></div>';
      overlay.innerHTML = html;
      overlay.style.display = 'flex';
    }

    // ==================== GAME FLOW ====================
    function showSkillEffects(skillEffects) {
      console.log('[SPA] 💫 Showing skill effects:', skillEffects);
      console.log('[DEBUG] skillEffects type:', typeof skillEffects);
      console.log('[DEBUG] skillEffects is array:', Array.isArray(skillEffects));
      console.log('[DEBUG] skillEffects length:', skillEffects ? skillEffects.length : 'null/undefined');
      
      if (!skillEffects || skillEffects.length === 0) {
        console.log('[DEBUG] No skill effects - returning early');
        return;
      }
      
      const skillVisuals = {
        // ดีบัฟ
        'mic power cut': { icon: '📵', stat: 'Vocal', color: '#ff6b9d', emoji: '🎤', type: 'debuff' },
        'freeze spell': { icon: '❄️', stat: 'Dance', color: '#00d4ff', emoji: '💃', type: 'debuff' },
        'banana slip': { icon: '🍌', stat: 'Visual', color: '#ffd700', emoji: '✨', type: 'debuff' },
        // บัฟ
        'golden microphone': { icon: '🎤', stat: 'Vocal', color: '#ff6b9d', emoji: '🎤', type: 'buff' },
        'feet of fire': { icon: '🔥', stat: 'Dance', color: '#00d4ff', emoji: '💃', type: 'buff' },
        'makeup shop visit': { icon: '💄', stat: 'Visual', color: '#ffd700', emoji: '✨', type: 'buff' },
        // อื่นๆ
        'leek shield': { icon: '🛡️', stat: 'Shield', color: '#00ff88', emoji: '🛡️', type: 'protect' },
        'never give up': { icon: '💪', stat: 'Willpower', color: '#ff00ff', emoji: '♥', type: 'heal' },
        'hidden skill': { icon: '🚫', stat: 'Block', color: '#888', emoji: '🚫', type: 'block' },
        'gacha god': { icon: '🎰', stat: 'Draw', color: '#ffd700', emoji: '🎴', type: 'draw' },
        'divine card': { icon: '✨', stat: 'Divine', color: '#fff', emoji: '✨', type: 'divine' }
      };
      
      console.log('[DEBUG] Starting skill effects display...');
      
      // ✅ รวบรวมสกิลทั้งหมดแล้วแสดงพร้อมกัน
      const overlay = document.getElementById('slotOverlay');
      if (!overlay) return;
      
      let allEffectsHTML = '<div class="slot-container" style="max-height: 90vh; overflow-y: auto;">';
      const skillEffectTitle = currentLang === 'ja' ? '💫 スキルエフェクト' : currentLang === 'en' ? '💫 Skill Effects' : '💫 Skill Effects';
      allEffectsHTML += `<h2 style="color: #00ff88; font-size: 2.5rem; margin-bottom: 20px;">${skillEffectTitle}</h2>`;
      
      // แยกประเภทสกิล
      const debuffs = [];
      const buffs = [];
      const others = [];
      const blocked = [];
      
      skillEffects.forEach((effect) => {
        console.log(`[DEBUG] Processing effect:`, effect);
        
        if (effect.blocked) {
          blocked.push(effect);
          return;
        }
        
        const skillInfo = skillVisuals[effect.skill];
        if (!skillInfo) return;
        
        if (skillInfo.type === 'debuff') {
          debuffs.push({ effect, skillInfo });
        } else if (skillInfo.type === 'buff') {
          buffs.push({ effect, skillInfo });
        } else {
          others.push({ effect, skillInfo });
        }
      });
      
      // แสดงสกิลที่ถูกบล็อก
      if (blocked.length > 0) {
        allEffectsHTML += '<div style="background: rgba(136,136,136,0.2); padding: 15px; margin: 10px 0; border-radius: 10px;">';
        const blockedLabel = currentLang === 'ja' ? '🚫 ブロック済み!' : '🚫 BLOCKED!';
        allEffectsHTML += `<h3 style="color: #888; font-size: 1.8rem; margin-bottom: 10px;">${blockedLabel}</h3>`;
        blocked.forEach(effect => {
          const translatedSkill = translateSkillName(effect.skill);
          allEffectsHTML += `<div style="color: #ff6b6b; margin: 5px 0;">${effect.player}'s ${translatedSkill}</div>`;
        });
        allEffectsHTML += '</div>';
      }
      
      // แสดงดีบัฟ
      if (debuffs.length > 0) {
        allEffectsHTML += '<div style="background: rgba(255,107,157,0.2); padding: 15px; margin: 10px 0; border-radius: 10px;">';
        const debuffsLabel = currentLang === 'ja' ? '💥 デバフ' : '💥 Debuffs';
        allEffectsHTML += `<h3 style="color: #ff00ff; font-size: 1.8rem; margin-bottom: 10px;">${debuffsLabel}</h3>`;
        debuffs.forEach(({ effect, skillInfo }) => {
          const translatedSkill = translateSkillName(effect.skill);
          allEffectsHTML += `
            <div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
              <div style="font-size: 1.3rem; color: #fff; margin-bottom: 5px;">${skillInfo.icon} ${effect.player} → ${translatedSkill}</div>
              <div style="color: ${skillInfo.color}; font-size: 1.1rem;">
                ${effect.effects.filter(e => e.includes('debuff')).map(e => `▼ ${e.replace('debuff to', '')}`).join('<br>')}
              </div>
            </div>
          `;
          // สร้างพาร์ติเคิล
          createDebuffParticles(skillInfo.icon, skillInfo.color);
        });
        allEffectsHTML += '</div>';
      }
      
      // แสดงบัฟ
      if (buffs.length > 0) {
        allEffectsHTML += '<div style="background: rgba(0,255,136,0.2); padding: 15px; margin: 10px 0; border-radius: 10px;">';
        const buffsLabel = currentLang === 'ja' ? '✨ バフ' : '✨ Buffs';
        allEffectsHTML += `<h3 style="color: #00ff88; font-size: 1.8rem; margin-bottom: 10px;">${buffsLabel}</h3>`;
        buffs.forEach(({ effect, skillInfo }) => {
          const translatedSkill = translateSkillName(effect.skill);
          allEffectsHTML += `
            <div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
              <div style="font-size: 1.3rem; color: #fff; margin-bottom: 5px;">${skillInfo.icon} ${effect.player} → ${translatedSkill}</div>
              <div style="color: ${skillInfo.color}; font-size: 1.1rem;">
                ${effect.effects.map(e => `▲ ${e}`).join('<br>')}
              </div>
            </div>
          `;
          // สร้างพาร์ติเคิล
          createBuffParticles(skillInfo.icon, skillInfo.color);
        });
        allEffectsHTML += '</div>';
      }
      
      // แสดงสกิลพิเศษ
      if (others.length > 0) {
        allEffectsHTML += '<div style="background: rgba(0,210,255,0.2); padding: 15px; margin: 10px 0; border-radius: 10px;">';
        const specialLabel = currentLang === 'ja' ? '⚡ 特別なスキル' : '⚡ Special Skills';
        allEffectsHTML += `<h3 style="color: #00d2ff; font-size: 1.8rem; margin-bottom: 10px;">${specialLabel}</h3>`;
        others.forEach(({ effect, skillInfo }) => {
          const translatedSkill = translateSkillName(effect.skill);
          allEffectsHTML += `
            <div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
              <div style="font-size: 1.3rem; color: #fff; margin-bottom: 5px;">${skillInfo.icon} ${effect.player} → ${translatedSkill}</div>
              <div style="color: ${skillInfo.color}; font-size: 1.1rem;">
                ${effect.effects.map(e => `✨ ${e}`).join('<br>')}
              </div>
            </div>
          `;
        });
        allEffectsHTML += '</div>';
      }
      
      allEffectsHTML += '</div>';
      
      // แสดงทุกอย่างพร้อมกัน
      if (debuffs.length > 0 || buffs.length > 0 || others.length > 0 || blocked.length > 0) {
        overlay.innerHTML = allEffectsHTML + `
          <style>
            @keyframes pulse {
              from { transform: scale(1); }
              to { transform: scale(1.1); }
            }
          </style>
        `;
        overlay.style.display = 'flex';
        
        // ซ่อนหลัง 3 วินาที
        setTimeout(() => {
          overlay.style.display = 'none';
        }, 3000);
      }
    }
    
    function createDebuffParticles(icon, color) {
      const table = document.getElementById('table');
      if (!table) return;
      
      // สร้างพาร์ติเคิล 8 ตัว
      for (let i = 0; i < 8; i++) {
        const particle = document.createElement('div');
        particle.textContent = icon;
        particle.style.position = 'absolute';
        particle.style.fontSize = '3rem';
        particle.style.left = `${Math.random() * 80 + 10}%`;
        particle.style.top = '50%';
        particle.style.transform = 'translateY(-50%)';
        particle.style.opacity = '1';
        particle.style.pointerEvents = 'none';
        particle.style.zIndex = '100';
        particle.style.textShadow = `0 0 10px ${color}`;
        particle.style.animation = `floatUp${i} 2s ease-out forwards`;
        
        table.appendChild(particle);
        
        // ลบหลัง animation จบ
        setTimeout(() => {
          particle.remove();
        }, 2000);
      }
      
      // เพิ่ม keyframes แบบสุ่ม
      const style = document.createElement('style');
      let keyframes = '';
      for (let i = 0; i < 8; i++) {
        const randomX = (Math.random() - 0.5) * 200;
        keyframes += `
          @keyframes floatUp${i} {
            0% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-150px) translateX(${randomX}px) rotate(${Math.random() * 360}deg); opacity: 0; }
          }
        `;
      }
      style.textContent = keyframes;
      document.head.appendChild(style);
      setTimeout(() => style.remove(), 2100);
    }
    
    function createBuffParticles(icon, color) {
      const table = document.getElementById('table');
      if (!table) return;
      
      // สร้างพาร์ติเคิลแบบบัฟ (ขึ้นและเรืองแสง)
      for (let i = 0; i < 10; i++) {
        const particle = document.createElement('div');
        particle.textContent = icon;
        particle.style.position = 'absolute';
        particle.style.fontSize = '2.5rem';
        particle.style.left = `${Math.random() * 80 + 10}%`;
        particle.style.top = '50%';
        particle.style.transform = 'translateY(-50%)';
        particle.style.opacity = '1';
        particle.style.pointerEvents = 'none';
        particle.style.zIndex = '100';
        particle.style.textShadow = `0 0 20px ${color}, 0 0 40px ${color}`;
        particle.style.animation = `floatUpBuff${i} 1.5s ease-out forwards`;
        
        table.appendChild(particle);
        
        setTimeout(() => {
          particle.remove();
        }, 1500);
      }
      
      // เพิ่ม keyframes สำหรับบัฟ (ลอยขึ้นและกระจาย)
      const style = document.createElement('style');
      let keyframes = '';
      for (let i = 0; i < 10; i++) {
        const randomX = (Math.random() - 0.5) * 150;
        const randomRotate = Math.random() * 720 - 360;
        keyframes += `
          @keyframes floatUpBuff${i} {
            0% { 
              transform: translateY(0) translateX(0) rotate(0deg) scale(1); 
              opacity: 1; 
            }
            50% {
              transform: translateY(-80px) translateX(${randomX * 0.5}px) rotate(${randomRotate * 0.5}deg) scale(1.5);
              opacity: 1;
            }
            100% { 
              transform: translateY(-120px) translateX(${randomX}px) rotate(${randomRotate}deg) scale(2); 
              opacity: 0; 
            }
          }
        `;
      }
      style.textContent = keyframes;
      document.head.appendChild(style);
      setTimeout(() => style.remove(), 1600);
    }
    
    function startEventRevealPhase() {
      document.getElementById('playCardPhase').classList.remove('show');
      let time = PHASE_TIMERS.eventReveal;
      document.getElementById('timer').textContent = time;
      clearInterval(_countdownInterval);

      _countdownInterval = setInterval(() => {
        time--;
        document.getElementById('timer').textContent = time;
        if (time <= 0) {
          clearInterval(_countdownInterval);
          startPlayCardPhase();
        }
      }, 1000);
    }

    function startPlayCardPhase() {
      // ✅ ตรวจสอบว่าผู้เล่นแพ้หรือยัง (heart = 0 หรือการ์ดหมด)
      const me = gameState.players.find(p => p.name === gameState.playerName);
      if (me && (me.heart <= 0 || me.handCount <= 0)) {
        console.log('[SPA] 💀 Player eliminated - skipping play card phase');
        // ไม่แสดงหน้าจอเลือกการ์ด - ให้ดูคนอื่นเล่นอย่างเดียว
        return;
      }
      
      document.getElementById('playCardPhase').classList.add('show');
      
      // ✅ Hide table event/competition when in play card phase
      const tableEventComp = document.querySelector('.table-event-competition');
      if (tableEventComp) {
        tableEventComp.style.opacity = '0';
        tableEventComp.style.pointerEvents = 'none';
      }
      
      // ✅ Update Event and Competition chips with translations
      const eventEl = document.getElementById('playCardMetaEvent');
      const competitionEl = document.getElementById('playCardMetaCompetition');
      if (eventEl && gameState.event) {
        let displayEventName = gameState.event?.name || gameState.event || '-';
        if ((currentLang === 'en' || currentLang === 'ja') && gameState.event?.name) {
          displayEventName = translateEventName(gameState.event.name);
        }
        eventEl.textContent = displayEventName;
      }
      if (competitionEl && gameState.competition) {
        const competitionLabels = {
          'vocal': currentLang === 'en' ? '🎤 Vocal Battle' : currentLang === 'ja' ? '🎤 ボーカルバトル' : '🎤 Vocal Battle',
          'dance': currentLang === 'en' ? '💃 Rhythm Clash' : currentLang === 'ja' ? '💃 リズムクラッシュ' : '💃 Rhythm Clash',
          'visual': currentLang === 'en' ? '✨ Stage Charm' : currentLang === 'ja' ? '✨ ステージチャーム' : '✨ Stage Charm'
        };
        const competitionText = competitionLabels[gameState.competition] || (gameState.competition || '-');
        competitionEl.textContent = competitionText;
      }
      
      // ✅ แสดงการ์ดใน phase container
      renderCardsInPhase(gameState.hand);
      
      let time = PHASE_TIMERS.playCard;
      document.getElementById('timer').textContent = time;
      clearInterval(_countdownInterval);

      _countdownInterval = setInterval(() => {
        time--;
        document.getElementById('timer').textContent = time;
        if (time <= 0) {
          clearInterval(_countdownInterval);
          if (!gameState.myCard) {
            // Auto-pick random card from hand
            if (gameState.hand && gameState.hand.length > 0) {
              const randomIdx = Math.floor(Math.random() * gameState.hand.length);
              gameState.myCard = gameState.hand[randomIdx];
            }
          }
          socket.emit('playCard', { roomCode: gameState.roomCode, card: gameState.myCard, skipTurn: false });
          document.getElementById('playCardPhase').classList.remove('show');
          
          // ✅ Show table event/competition again when play card phase ends
          const tableEventComp = document.querySelector('.table-event-competition');
          if (tableEventComp) {
            tableEventComp.style.opacity = '1';
            tableEventComp.style.pointerEvents = 'auto';
          }
          
          // Hide card hand reopen button when phase ends
          if (cardHandReopenBtn) {
            cardHandReopenBtn.style.display = 'none';
          }
          // Auto-expand card hand when phase ends
          if (playCardPhaseElement && playCardPhaseElement.classList.contains('card-hand-collapsed')) {
            expandCardHand();
          }
        }
      }, 1000);
    }

    function startActionPhase() {
      // ✅ ตรวจสอบว่าผู้เล่นแพ้หรือยัง (heart = 0 หรือการ์ดหมด)
      const me = gameState.players.find(p => p.name === gameState.playerName);
      if (me && (me.heart <= 0 || me.handCount <= 0)) {
        console.log('[SPA] 💀 Player eliminated - skipping action phase');
        // ไม่แสดงหน้าจอเลือก action - ให้ดูคนอื่นเล่นอย่างเดียว
        return;
      }
      
      document.getElementById('playCardPhase').classList.remove('show');
      document.getElementById('actionPhase').classList.add('show');
      
      // ✅ Show table event/competition again when leaving play card phase
      const tableEventComp = document.querySelector('.table-event-competition');
      if (tableEventComp) {
        tableEventComp.style.opacity = '1';
        tableEventComp.style.pointerEvents = 'auto';
      }
      
      if (actionPhaseElement) {
        actionPhaseElement.classList.remove('collapsed');
      }
      actionModalCollapsed = false;
      if (actionReopenBtn) {
        actionReopenBtn.style.display = 'none';
        actionReopenBtn.setAttribute('aria-expanded', 'true');
      }
      
      // Auto-expand card hand when action phase starts
      if (playCardPhaseElement && playCardPhaseElement.classList.contains('card-hand-collapsed')) {
        expandCardHand();
      }
      
      // Hide card hand reopen button when action phase starts
      if (cardHandReopenBtn) {
        cardHandReopenBtn.style.display = 'none';
      }
      
      const skillTextSpan = document.querySelector('#actionBtn2 .action-text');
      if (skillTextSpan) {
        skillTextSpan.textContent = currentLang === 'en' ? 'Skill' : currentLang === 'ja' ? 'スキル' : 'ใช้สกิล';
      }
      
      // Update Action 2 button status based on cooldown
      updateActionCooldownDisplay();
      
      let time = PHASE_TIMERS.action;
      document.getElementById('timer').textContent = time;
      const actionTimerValue = document.getElementById('actionTimerValue');
      if (actionTimerValue) actionTimerValue.textContent = time;
      clearInterval(_countdownInterval);

      _countdownInterval = setInterval(() => {
        time--;
        document.getElementById('timer').textContent = time;
        if (actionTimerValue) actionTimerValue.textContent = time;
        if (time <= 0) {
          clearInterval(_countdownInterval);
          if (!gameState.myAction) {
            gameState.myAction = "3";
          }
          socket.emit('chooseAction', { roomCode: gameState.roomCode, action: gameState.myAction });
          hideActionPhaseOverlay();
        }
      }, 1000);
    }

    function updateActionCooldownDisplay() {
      const btn2 = document.getElementById('actionBtn2');
      const cdBadge = document.getElementById('actionCdBadge');
      
      if (gameState.actionCooldown > 0) {
        btn2.disabled = true;
        btn2.style.opacity = '0.5';
        btn2.style.cursor = 'not-allowed';
        cdBadge.textContent = ` (CD: ${gameState.actionCooldown})`;
      } else {
        btn2.disabled = false;
        btn2.style.opacity = '1';
        btn2.style.cursor = 'pointer';
        cdBadge.textContent = '';
      }
    }

    function startResultsPhase(gameOver) {
      // ถ้าเกมจบแล้ว ให้ปุ่มขึ้นตลอด ไม่ต้องซ่อน
      if (gameOver) {
        return;
      }
      
      // ถ้าเกมยังไม่จบ ให้ซ่อน overlay หลัง 7 วินาที
      let time = PHASE_TIMERS.results;
      document.getElementById('timer').textContent = time;
      clearInterval(_countdownInterval);

      _countdownInterval = setInterval(() => {
        time--;
        document.getElementById('timer').textContent = time;
        if (time <= 0) {
          clearInterval(_countdownInterval);
          document.getElementById('resultOverlay').classList.remove('show');
        }
      }, 1000);
    }

    document.getElementById('confirmCard').addEventListener('click', () => {
      if (!gameState.myCard) {
        showError(currentLang === 'en' ? 'Select a card first!' : currentLang === 'ja' ? 'まずカードを選択してください！' : 'เลือกการ์ดก่อน!');
        return;
      }
      
      playSound('cardPlay');
      
      clearInterval(_countdownInterval);
      socket.emit('playCard', { roomCode: gameState.roomCode, card: gameState.myCard, skipTurn: false });
      document.getElementById('playCardPhase').classList.remove('show');
      document.getElementById('confirmCard').classList.remove('show');
      
      // เอา border ออกจากการ์ดที่เลือก
      document.querySelectorAll('#hand .card').forEach(c => {
        c.style.border = 'none';
        c.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.5)';
      });
      
      // ซ่อน card detail
      document.getElementById('cardDetailPreview').style.display = 'none';
    });

    document.querySelectorAll('.action-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (btn.dataset.action === "2" && gameState.actionCooldown > 0) {
          showError(currentLang === 'en' ? `Skill is on cooldown for ${gameState.actionCooldown} more turns!` : currentLang === 'ja' ? `スキルは${gameState.actionCooldown}ターン間クールダウン中です！` : `ปุ่ม Action 2 ยังติด CD ${gameState.actionCooldown} เทิร์น!`);
          return;
        }
        
        gameState.myAction = btn.dataset.action;
        clearInterval(_countdownInterval);
        socket.emit('chooseAction', { roomCode: gameState.roomCode, action: gameState.myAction });
        hideActionPhaseOverlay();
      });
    });
  </script>

  <div id="slotOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; justify-content: center; align-items: center;">
  </div>
</body>
</html>
